import{u as j,r as f,c as W,o as G,a as X,b as F,d as L,e as o,f as E,t as Y,i as ee,g as k}from"./index-CAe1qyEd.js";import{_ as te,a as ae}from"./AddCustomBudgetModal-CKKObM2L.js";function U(){const _=j(),{apiCall:m}=_,g=f([]),n=f(!1),c=f(""),b=W(()=>(_.currentSalesperson?.role||"").startsWith("Hospitality")),h=async()=>{n.value=!0,c.value="";try{const s=await m("/api/sales");if(!s.ok)throw new Error("Failed to fetch sales data");const r=await s.json();g.value=r.data||[]}catch(s){c.value=s.message,console.error("Error fetching sales:",s)}finally{n.value=!1}},d=()=>g.value.reduce((s,r)=>s+(parseFloat(r.q1_sales)||0),0),y=()=>g.value.reduce((s,r)=>s+(parseFloat(r.q2_sales)||0),0),i=()=>g.value.reduce((s,r)=>s+(parseFloat(r.q3_sales)||0),0),q=()=>g.value.reduce((s,r)=>s+(parseFloat(r.q4_sales)||0),0),v=()=>g.value.reduce((s,r)=>s+(parseFloat(r.q4_orders)||0),0),w=()=>g.value.reduce((s,r)=>s+(parseFloat(r.total_sales)||0),0),B=()=>g.value.reduce((s,r)=>s+(parseFloat(r.zero_perc_sales_total)||0),0);return{sales:g,loading:n,error:c,isHospitality:b,fetchSales:h,getTotalQ1:d,getTotalQ2:y,getTotalQ3:i,getTotalQ4Sales:q,getTotalQ4:v,getTotalSales:w,getTotalZeroPercent:B,getZeroPercentRate:()=>{const s=w(),r=B();return s>0?r/s*100:0},getTotalOpen2026:()=>g.value.reduce((s,r)=>s+(parseFloat(r.open_2026)||0),0)}}function se(){const _=j(),{apiCall:m}=_,{isHospitality:g}=U(),n=f([]),c=f({}),b=f(new Set),h=f(new Set),d=f({}),y=f({customer_classes:[],customer_names:[],brands:[],flags:[]});let i=null;const q=async()=>{try{const e=await m("/api/budget");if(!e.ok)throw new Error("Failed to fetch budget data");const t=await e.json();n.value=t.data||[],c.value={},n.value.forEach(a=>{const l=`${a.brand||"null"}_${a.flag||"null"}_${a.customer_name}`;c.value[l]=a})}catch(e){console.error("Error fetching budgets:",e)}},v=async(e,t,a)=>{const l=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;b.value.add(l);try{if(!_.currentSalesperson)throw new Error("Salesperson data not available");const u=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,S=c.value[u],x={salesperson_id:_.currentSalesperson.salesman_no,salesperson_name:_.currentSalesperson.salesman_name,brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:g.value?"Hospitality":e.derived_customer_class,[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let T;if(S?T=await m(`/api/budget/${S.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):T=await m("/api/budget",{method:"POST",body:JSON.stringify(x)}),!T.ok)throw new Error("Failed to save budget");const O=await T.json();S?S[`quarter_${t}_sales`]=parseFloat(a)||0:(c.value[u]=O.data,n.value.push(O.data)),h.value.add(l),setTimeout(()=>h.value.delete(l),1e3),$()}catch(u){console.error("Error saving budget:",u)}finally{b.value.delete(l)}},w=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;if(d.value.hasOwnProperty(a))return d.value[a];const l=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,u=c.value[l];return u&&u[`quarter_${t}_sales`]||0},B=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;return b.value.has(a)?"bg-blue-50 border-blue-300":h.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},Q=(e,t,a)=>{i&&clearTimeout(i),i=setTimeout(()=>{a&&a!=="0"&&a!==""&&v(e,t,a)},2e3)},P=(e,t,a)=>{const l=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`,u=e.target.value;d.value[l]=u,$(),Q(t,a,u)},s=(e,t,a)=>{const l=e.target.value,u=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;i&&(clearTimeout(i),i=null),delete d.value[u],$(),v(t,a,l)},r=(e,t,a)=>{const l=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;d.value[l]=e.target.value,e.key==="Enter"&&e.target.blur()},$=()=>{const e={};Object.keys(d.value).forEach(t=>{const a=d.value[t];a&&a!=="0"&&a!==""&&(e[t]=a)}),localStorage.setItem("budget_pending_changes",JSON.stringify(e))};return{budgets:n,budgetMap:c,savingCells:b,savedCells:h,inputValues:d,autosuggestData:y,fetchBudgets:q,saveBudgetCell:v,getBudgetValue:w,getCellClass:B,handleBudgetChange:P,handleBudgetBlur:s,handleBudgetInput:r,savePendingChangesToStorage:$,loadPendingChangesFromStorage:()=>{try{const e=localStorage.getItem("budget_pending_changes");if(e){const t=JSON.parse(e);return Object.keys(t).forEach(a=>{d.value[a]=t[a]}),Object.keys(t).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},clearPendingChangesFromStorage:()=>{localStorage.removeItem("budget_pending_changes")},fetchAutosuggestData:async()=>{try{const e=await m("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();y.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},createCustomBudget:async e=>{try{if(!_.currentSalesperson)throw new Error("Salesperson data not available");const t={...e,salesperson_id:_.currentSalesperson.salesman_no,salesperson_name:_.currentSalesperson.salesman_name,customer_class:g.value?"Hospitality":e.customer_class,quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},a=await m("/api/budget",{method:"POST",body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to create custom budget");const l=await a.json(),u=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}`;return c.value[u]=l.data,n.value.push(l.data),l.data}catch(t){throw console.error("Error creating custom budget:",t),t}},deleteCustomBudget:async e=>{try{if(!(await m(`/api/budget/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const a=n.value.findIndex(l=>l.id===e);if(a!==-1){const l=n.value[a],u=`${l.brand||"null"}_${l.flag||"null"}_${l.customer_name}`;delete c.value[u],n.value.splice(a,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},getCustomBudgets:()=>n.value.filter(e=>e.is_custom===!0),getTotalQ1Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),getTotalQ2Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),getTotalQ3Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),getTotalQ4Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0),getTotalBudget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.total_sales)||0),0),cleanup:()=>{i&&clearTimeout(i)}}}const oe={class:"mx-auto px-4 py-8"},le={key:0,class:"flex justify-center"},re={key:1,class:"alert alert-error"},ne={key:2,class:"text-center py-8"},ue={key:3},de={__name:"SalesView",setup(_){const{currentUser:m,currentSalesperson:g}=j(),n=ee("addBudgetModal"),{sales:c,loading:b,error:h,isHospitality:d,fetchSales:y,getTotalQ1:i,getTotalQ2:q,getTotalQ3:v,getTotalQ4Sales:w,getTotalQ4:B,getTotalSales:Q,getTotalZeroPercent:P,getZeroPercentRate:s,getTotalOpen2026:r}=U(),{fetchBudgets:$,getBudgetValue:D,getCellClass:N,handleBudgetChange:A,handleBudgetBlur:z,handleBudgetInput:H,loadPendingChangesFromStorage:I,fetchAutosuggestData:M,createCustomBudget:V,deleteCustomBudget:Z,getCustomBudgets:J,getTotalQ1Budget:K,getTotalQ2Budget:R,getTotalQ3Budget:e,getTotalQ4Budget:t,getTotalBudget:a,autosuggestData:l,cleanup:u}=se(),S=()=>{n.close()},x=async C=>{console.log("handleCustomBudgetCreated called with:",C);try{await V(C),console.log("Custom budget created successfully")}catch(p){console.error("Error creating custom budget:",p)}},T=async C=>{try{await Z(C),console.log("Custom budget deleted successfully")}catch(p){console.error("Error deleting custom budget:",p)}},O=async()=>{await M()};return G(async()=>{await y(),await $(),I()&&console.log("Restored pending budget changes from localStorage"),window.addEventListener("beforeunload",p=>{})}),X(()=>{window.removeEventListener("beforeunload",()=>{}),u()}),(C,p)=>(k(),F("div",oe,[o(b)?(k(),F("div",le,[...p[0]||(p[0]=[E("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):o(h)?(k(),F("div",re,[p[1]||(p[1]=E("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[E("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),E("span",null,Y(o(h)),1)])):o(c).length===0?(k(),F("div",ne,[...p[2]||(p[2]=[E("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(k(),F("div",ue,[L(te,{sales:o(c),"custom-budgets":o(J)(),"get-budget-value":o(D),"get-cell-class":o(N),"handle-budget-change":o(A),"handle-budget-blur":o(z),"handle-budget-input":o(H),"handle-delete-custom-budget":T,"is-hospitality":o(d),"get-total-q1":o(i),"get-total-q2":o(q),"get-total-q3":o(v),"get-total-q4-sales":o(w),"get-total-q4":o(B),"get-total-sales":o(Q),"get-total-zero-percent":o(P),"get-zero-percent-rate":o(s),"get-total-open-2026":o(r),"get-total-q1-budget":o(K),"get-total-q2-budget":o(R),"get-total-q3-budget":o(e),"get-total-q4-budget":o(t),"get-total-budget":o(a)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),L(ae,{"is-open":o(n).isOpen.value,"is-hospitality":o(d),"autosuggest-data":o(l),onClose:S,onCreated:x,onFetchAutosuggest:O},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{de as default};
