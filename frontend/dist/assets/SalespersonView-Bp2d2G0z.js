import{u as L,r as b,c as ee,e as s,n as oe,o as se,m as ne,i as X,a as re,b as O,d as Y,f as j,t as le,g as x}from"./index-DuC6HlwO.js";import{_ as ue,a as ce}from"./AddCustomBudgetModal-DF02GWPP.js";function te(c){const Q=L(),{apiCall:m}=Q,d=b([]),y=b(!1),u=b(""),g=b(null),$=ee(()=>g.value?.is_hospitality||!1),B=async()=>{y.value=!0,u.value="";try{const n=s(c),l=await m(`/api/sales/${n}`);if(!l.ok)throw new Error("Failed to fetch sales data");const w=await l.json();d.value=w.data||[],g.value=w.salesperson_info||null}catch(n){u.value=n.message,console.error("Error fetching sales:",n)}finally{y.value=!1}},i=()=>d.value.reduce((n,l)=>n+(parseFloat(l.q1_sales)||0),0),S=()=>d.value.reduce((n,l)=>n+(parseFloat(l.q2_sales)||0),0),p=()=>d.value.reduce((n,l)=>n+(parseFloat(l.q3_sales)||0),0),P=()=>d.value.reduce((n,l)=>n+(parseFloat(l.q4_sales)||0),0),k=()=>d.value.reduce((n,l)=>n+(parseFloat(l.q4_orders)||0),0),q=()=>d.value.reduce((n,l)=>n+(parseFloat(l.total_sales)||0),0),F=()=>d.value.reduce((n,l)=>n+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:d,loading:y,error:u,salespersonInfo:g,isHospitality:$,fetchSales:B,getTotalQ1:i,getTotalQ2:S,getTotalQ3:p,getTotalQ4Sales:P,getTotalQ4:k,getTotalSales:q,getTotalZeroPercent:F,getZeroPercentRate:()=>{const n=q(),l=F();return n>0?l/n*100:0},getTotalOpen2026:()=>d.value.reduce((n,l)=>n+(parseFloat(l.open_2026)||0),0)}}function de(c){const Q=L(),{apiCall:m}=Q,{isHospitality:d,salespersonInfo:y}=te(c),u=b([]),g=b({}),$=b(new Set),B=b(new Set),i=b({}),S=b({customer_classes:[],customer_names:[],brands:[],flags:[]});let p=null;const P=async()=>{try{const e=s(c),t=await m(`/api/budget/${e}`);if(!t.ok)throw new Error("Failed to fetch budget data");const a=await t.json();u.value=a.data||[],g.value={},u.value.forEach(o=>{const r=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;g.value[r]=o})}catch(e){console.error("Error fetching budgets:",e)}},k=async(e,t,a)=>{const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;$.value.add(o);try{const r=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,h=g.value[r],T=s(c);let v=y.value?.salesperson_name;if(!v)try{const _=await m("/api/admin/summary");_.ok&&(v=(await _.json()).data?.find(ae=>ae.salesperson_id===T)?.salesperson_name)}catch(_){console.error("Error fetching salesperson name from admin summary:",_)}const V={salesperson_id:T,salesperson_name:v||"Unknown",brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:d.value?"Hospitality":e.derived_customer_class||"General",[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let C;if(h?C=await m(`/api/budget/${T}/${h.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):C=await m(`/api/budget/${T}`,{method:"POST",body:JSON.stringify(V)}),!C.ok)throw new Error("Failed to save budget");const E=await C.json();h?h[`quarter_${t}_sales`]=parseFloat(a)||0:(g.value[r]=E.data,u.value.push(E.data)),B.value.add(o),setTimeout(()=>B.value.delete(o),1e3),w()}catch(r){console.error("Error saving budget:",r)}finally{$.value.delete(o)}},q=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;if(i.value.hasOwnProperty(a))return i.value[a];const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,r=g.value[o];return r&&r[`quarter_${t}_sales`]||0},F=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;return $.value.has(a)?"bg-blue-50 border-blue-300":B.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},D=(e,t,a)=>{p&&clearTimeout(p),p=setTimeout(()=>{a&&a!=="0"&&a!==""&&k(e,t,a)},2e3)},A=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`,r=e.target.value;i.value[o]=r,w(),D(t,a,r)},n=(e,t,a)=>{const o=e.target.value,r=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;p&&(clearTimeout(p),p=null),delete i.value[r],w(),k(t,a,o)},l=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;i.value[o]=e.target.value,e.key==="Enter"&&e.target.blur()},w=()=>{const e=typeof c=="function"?c():c,t={};Object.keys(i.value).forEach(a=>{const o=i.value[a];o&&o!=="0"&&o!==""&&(t[a]=o)}),localStorage.setItem(`budget_pending_changes_${e}`,JSON.stringify(t))},Z=()=>{try{const e=s(c),t=localStorage.getItem(`budget_pending_changes_${e}`);if(t){const a=JSON.parse(t);return Object.keys(a).forEach(o=>{i.value[o]=a[o]}),Object.keys(a).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},H=()=>{const e=typeof c=="function"?c():c;localStorage.removeItem(`budget_pending_changes_${e}`)},J=async()=>{try{const e=await m("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();S.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},I=async e=>{try{const t=s(c);let a=y.value?.salesperson_name;if(!a)try{const v=await m("/api/admin/summary");v.ok&&(a=(await v.json()).data?.find(E=>E.salesperson_id===t)?.salesperson_name)}catch(v){console.error("Error fetching salesperson name from admin summary:",v)}const o={...e,salesperson_id:t,salesperson_name:a||"Unknown",customer_class:d.value?"Hospitality":e.customer_class||"General",quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},r=await m(`/api/budget/${t}`,{method:"POST",body:JSON.stringify(o)});if(!r.ok)throw new Error("Failed to create custom budget");const h=await r.json(),T=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;return g.value[T]=h.data,u.value.push(h.data),h.data}catch(t){throw console.error("Error creating custom budget:",t),t}},K=async e=>{try{const t=s(c);if(!(await m(`/api/budget/${t}/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const o=u.value.findIndex(r=>r.id===e);if(o!==-1){const r=u.value[o],h=`${r.brand||"null"}_${r.flag||"null"}_${r.customer_name}`;delete g.value[h],u.value.splice(o,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},U=()=>u.value.filter(e=>e.is_custom===!0),N=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),R=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),M=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),z=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0);return{budgets:u,budgetMap:g,savingCells:$,savedCells:B,inputValues:i,autosuggestData:S,fetchBudgets:P,saveBudgetCell:k,getBudgetValue:q,getCellClass:F,handleBudgetChange:A,handleBudgetBlur:n,handleBudgetInput:l,savePendingChangesToStorage:w,loadPendingChangesFromStorage:Z,clearPendingChangesFromStorage:H,fetchAutosuggestData:J,createCustomBudget:I,deleteCustomBudget:K,getCustomBudgets:U,getTotalQ1Budget:N,getTotalQ2Budget:R,getTotalQ3Budget:M,getTotalQ4Budget:z,getTotalBudget:()=>N()+R()+M()+z(),cleanup:()=>{p&&clearTimeout(p)}}}const ge={class:"mx-auto px-4 py-8"},ie={key:0,class:"flex justify-center"},me={key:1,class:"alert alert-error"},_e={key:2,class:"text-center py-8"},pe={key:3},be={__name:"SalespersonView",setup(c){const Q=oe(),m=ne(),d=L(),y=ee(()=>{const _=Q.params.salespersonId;return parseInt(_)}),u=X("addBudgetModal"),g=X("navActions"),{sales:$,loading:B,error:i,isHospitality:S,fetchSales:p,getTotalQ1:P,getTotalQ2:k,getTotalQ3:q,getTotalQ4Sales:F,getTotalQ4:D,getTotalSales:A,getTotalZeroPercent:n,getZeroPercentRate:l,getTotalOpen2026:w}=te(y),{fetchBudgets:Z,getBudgetValue:H,getCellClass:J,handleBudgetChange:I,handleBudgetBlur:K,handleBudgetInput:U,loadPendingChangesFromStorage:N,fetchAutosuggestData:R,createCustomBudget:M,deleteCustomBudget:z,getCustomBudgets:G,getTotalQ1Budget:W,getTotalQ2Budget:e,getTotalQ3Budget:t,getTotalQ4Budget:a,getTotalBudget:o,autosuggestData:r,cleanup:h}=de(y),T=()=>{m.push("/admin")},v=()=>{u.close()},V=async _=>{console.log("handleCustomBudgetCreated called with:",_);try{await M(_),console.log("Custom budget created successfully")}catch(f){console.error("Error creating custom budget:",f)}},C=async _=>{try{await z(_),console.log("Custom budget deleted successfully")}catch(f){console.error("Error deleting custom budget:",f)}},E=async()=>{await R()};return se(async()=>{if(!d.adminStatus){m.push("/");return}await p(),await Z(),N()&&console.log("Restored pending budget changes from localStorage"),g.set([{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost mr-2",handler:T,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),window.addEventListener("beforeunload",f=>{})}),re(()=>{window.removeEventListener("beforeunload",()=>{}),g.clear(),h()}),(_,f)=>(x(),O("div",ge,[s(B)?(x(),O("div",ie,[...f[0]||(f[0]=[j("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):s(i)?(x(),O("div",me,[f[1]||(f[1]=j("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[j("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),j("span",null,le(s(i)),1)])):s($).length===0?(x(),O("div",_e,[...f[2]||(f[2]=[j("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(x(),O("div",pe,[Y(ue,{sales:s($),"custom-budgets":s(G)(),"get-budget-value":s(H),"get-cell-class":s(J),"handle-budget-change":s(I),"handle-budget-blur":s(K),"handle-budget-input":s(U),"handle-delete-custom-budget":C,"is-hospitality":s(S),"get-total-q1":s(P),"get-total-q2":s(k),"get-total-q3":s(q),"get-total-q4-sales":s(F),"get-total-q4":s(D),"get-total-sales":s(A),"get-total-zero-percent":s(n),"get-zero-percent-rate":s(l),"get-total-open-2026":s(w),"get-total-q1-budget":s(W),"get-total-q2-budget":s(e),"get-total-q3-budget":s(t),"get-total-q4-budget":s(a),"get-total-budget":s(o)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),Y(ce,{"is-open":s(u).isOpen.value,"is-hospitality":s(S),"autosuggest-data":s(r),onClose:v,onCreated:V,onFetchAutosuggest:E},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{be as default};
