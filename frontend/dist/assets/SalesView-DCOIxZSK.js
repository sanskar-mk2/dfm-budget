import{u as x,r as b,c as L,o as U,a as W,b as T,d as K,e as s,f as E,t as G,i as X,g as F}from"./index-BwlVtp6Q.js";import{_ as Y,a as ee}from"./AddCustomBudgetModal-SJSzf0RS.js";function R(){const m=x(),{apiCall:p}=m,i=b([]),n=b(!1),c=b(""),v=L(()=>(m.currentSalesperson?.role||"").startsWith("Hospitality")),f=async()=>{n.value=!0,c.value="";try{const r=await p("/api/sales");if(!r.ok)throw new Error("Failed to fetch sales data");const l=await r.json();i.value=l.data||[]}catch(r){c.value=r.message,console.error("Error fetching sales:",r)}finally{n.value=!1}},g=()=>i.value.reduce((r,l)=>r+(parseFloat(l.q1_sales)||0),0),w=()=>i.value.reduce((r,l)=>r+(parseFloat(l.q2_sales)||0),0),_=()=>i.value.reduce((r,l)=>r+(parseFloat(l.q3_sales)||0),0),C=()=>i.value.reduce((r,l)=>r+(parseFloat(l.q4_sales)||0),0),y=()=>i.value.reduce((r,l)=>r+(parseFloat(l.total_sales)||0),0),B=()=>i.value.reduce((r,l)=>r+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:i,loading:n,error:c,isHospitality:v,fetchSales:f,getTotalQ1:g,getTotalQ2:w,getTotalQ3:_,getTotalQ4:C,getTotalSales:y,getTotalZeroPercent:B,getZeroPercentRate:()=>{const r=y(),l=B();return r>0?l/r*100:0}}}function te(){const m=x(),{apiCall:p}=m,{isHospitality:i}=R(),n=b([]),c=b({}),v=b(new Set),f=b(new Set),g=b({}),w=b({customer_classes:[],customer_names:[],brands:[],flags:[]});let _=null;const C=async()=>{try{const e=await p("/api/budget");if(!e.ok)throw new Error("Failed to fetch budget data");const t=await e.json();n.value=t.data||[],c.value={},n.value.forEach(a=>{const o=`${a.brand||"null"}_${a.flag||"null"}_${a.customer_name}`;c.value[o]=a})}catch(e){console.error("Error fetching budgets:",e)}},y=async(e,t,a)=>{const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;v.value.add(o);try{if(!m.currentSalesperson)throw new Error("Salesperson data not available");const u=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,S=c.value[u],P={salesperson_id:m.currentSalesperson.salesman_no,salesperson_name:m.currentSalesperson.salesman_name,brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:i.value?"Hospitality":e.derived_customer_class,[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let h;if(S?h=await p(`/api/budget/${S.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):h=await p("/api/budget",{method:"POST",body:JSON.stringify(P)}),!h.ok)throw new Error("Failed to save budget");const d=await h.json();S?S[`quarter_${t}_sales`]=parseFloat(a)||0:(c.value[u]=d.data,n.value.push(d.data)),f.value.add(o),setTimeout(()=>f.value.delete(o),1e3),$()}catch(u){console.error("Error saving budget:",u)}finally{v.value.delete(o)}},B=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;if(g.value.hasOwnProperty(a))return g.value[a];const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,u=c.value[o];return u&&u[`quarter_${t}_sales`]||0},k=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;return v.value.has(a)?"bg-blue-50 border-blue-300":f.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},r=(e,t,a)=>{_&&clearTimeout(_),_=setTimeout(()=>{a&&a!=="0"&&a!==""&&y(e,t,a)},2e3)},l=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`,u=e.target.value;g.value[o]=u,$(),r(t,a,u)},q=(e,t,a)=>{const o=e.target.value,u=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;_&&(clearTimeout(_),_=null),delete g.value[u],$(),y(t,a,o)},Q=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;g.value[o]=e.target.value,e.key==="Enter"&&e.target.blur()},$=()=>{const e={};Object.keys(g.value).forEach(t=>{const a=g.value[t];a&&a!=="0"&&a!==""&&(e[t]=a)}),localStorage.setItem("budget_pending_changes",JSON.stringify(e))};return{budgets:n,budgetMap:c,savingCells:v,savedCells:f,inputValues:g,autosuggestData:w,fetchBudgets:C,saveBudgetCell:y,getBudgetValue:B,getCellClass:k,handleBudgetChange:l,handleBudgetBlur:q,handleBudgetInput:Q,savePendingChangesToStorage:$,loadPendingChangesFromStorage:()=>{try{const e=localStorage.getItem("budget_pending_changes");if(e){const t=JSON.parse(e);return Object.keys(t).forEach(a=>{g.value[a]=t[a]}),Object.keys(t).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},clearPendingChangesFromStorage:()=>{localStorage.removeItem("budget_pending_changes")},fetchAutosuggestData:async()=>{try{const e=await p("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();w.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},createCustomBudget:async e=>{try{if(!m.currentSalesperson)throw new Error("Salesperson data not available");const t={...e,salesperson_id:m.currentSalesperson.salesman_no,salesperson_name:m.currentSalesperson.salesman_name,customer_class:i.value?"Hospitality":e.customer_class,quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},a=await p("/api/budget",{method:"POST",body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to create custom budget");const o=await a.json(),u=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}`;return c.value[u]=o.data,n.value.push(o.data),o.data}catch(t){throw console.error("Error creating custom budget:",t),t}},deleteCustomBudget:async e=>{try{if(!(await p(`/api/budget/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const a=n.value.findIndex(o=>o.id===e);if(a!==-1){const o=n.value[a],u=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;delete c.value[u],n.value.splice(a,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},getCustomBudgets:()=>n.value.filter(e=>e.is_custom===!0),getTotalQ1Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),getTotalQ2Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),getTotalQ3Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),getTotalQ4Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0),getTotalBudget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.total_sales)||0),0),cleanup:()=>{_&&clearTimeout(_)}}}const ae={class:"mx-auto px-4 py-8"},se={key:0,class:"flex justify-center"},oe={key:1,class:"alert alert-error"},re={key:2,class:"text-center py-8"},ne={key:3},ce={__name:"SalesView",setup(m){const{currentUser:p,currentSalesperson:i}=x(),n=X("addBudgetModal"),{sales:c,loading:v,error:f,isHospitality:g,fetchSales:w,getTotalQ1:_,getTotalQ2:C,getTotalQ3:y,getTotalQ4:B,getTotalSales:k,getTotalZeroPercent:r,getZeroPercentRate:l}=R(),{fetchBudgets:q,getBudgetValue:Q,getCellClass:$,handleBudgetChange:O,handleBudgetBlur:j,handleBudgetInput:D,loadPendingChangesFromStorage:N,fetchAutosuggestData:A,createCustomBudget:z,deleteCustomBudget:H,getCustomBudgets:I,getTotalQ1Budget:M,getTotalQ2Budget:V,getTotalQ3Budget:Z,getTotalQ4Budget:J,getTotalBudget:e,autosuggestData:t,cleanup:a}=te(),o=()=>{n.close()},u=async h=>{console.log("handleCustomBudgetCreated called with:",h);try{await z(h),console.log("Custom budget created successfully")}catch(d){console.error("Error creating custom budget:",d)}},S=async h=>{try{await H(h),console.log("Custom budget deleted successfully")}catch(d){console.error("Error deleting custom budget:",d)}},P=async()=>{await A()};return U(async()=>{await w(),await q(),N()&&console.log("Restored pending budget changes from localStorage"),window.addEventListener("beforeunload",d=>{})}),W(()=>{window.removeEventListener("beforeunload",()=>{}),a()}),(h,d)=>(F(),T("div",ae,[s(v)?(F(),T("div",se,[...d[0]||(d[0]=[E("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):s(f)?(F(),T("div",oe,[d[1]||(d[1]=E("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[E("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),E("span",null,G(s(f)),1)])):s(c).length===0?(F(),T("div",re,[...d[2]||(d[2]=[E("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(F(),T("div",ne,[K(Y,{sales:s(c),"custom-budgets":s(I)(),"get-budget-value":s(Q),"get-cell-class":s($),"handle-budget-change":s(O),"handle-budget-blur":s(j),"handle-budget-input":s(D),"handle-delete-custom-budget":S,"is-hospitality":s(g),"get-total-q1":s(_),"get-total-q2":s(C),"get-total-q3":s(y),"get-total-q4":s(B),"get-total-sales":s(k),"get-total-zero-percent":s(r),"get-zero-percent-rate":s(l),"get-total-q1-budget":s(M),"get-total-q2-budget":s(V),"get-total-q3-budget":s(Z),"get-total-q4-budget":s(J),"get-total-budget":s(e)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),K(ee,{"is-open":s(n).isOpen.value,"is-hospitality":s(g),"autosuggest-data":s(t),onClose:o,onCreated:u,onFetchAutosuggest:P},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{ce as default};
