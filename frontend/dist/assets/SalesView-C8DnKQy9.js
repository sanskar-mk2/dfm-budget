import{u as j,r as y,c as W,o as G,a as X,b as F,d as L,e as o,f as E,t as Y,i as ee,g as k}from"./index-UPDjkweO.js";import{_ as te,a as ae}from"./AddCustomBudgetModal-DA_OwYDv.js";function U(){const h=j(),{apiCall:f}=h,g=y([]),n=y(!1),c=y(""),w=W(()=>(h.currentSalesperson?.role||"").startsWith("Hospitality")),b=async()=>{n.value=!0,c.value="";try{const s=await f("/api/sales");if(!s.ok)throw new Error("Failed to fetch sales data");const l=await s.json();g.value=l.data||[]}catch(s){c.value=s.message,console.error("Error fetching sales:",s)}finally{n.value=!1}},d=()=>g.value.reduce((s,l)=>s+(parseFloat(l.q1_sales)||0),0),S=()=>g.value.reduce((s,l)=>s+(parseFloat(l.q2_sales)||0),0),p=()=>g.value.reduce((s,l)=>s+(parseFloat(l.q3_sales)||0),0),_=()=>g.value.reduce((s,l)=>s+(parseFloat(l.q4_sales)||0),0),v=()=>g.value.reduce((s,l)=>s+(parseFloat(l.q4_orders)||0),0),T=()=>g.value.reduce((s,l)=>s+(parseFloat(l.total_sales)||0),0),B=()=>g.value.reduce((s,l)=>s+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:g,loading:n,error:c,isHospitality:w,fetchSales:b,getTotalQ1:d,getTotalQ2:S,getTotalQ3:p,getTotalQ4Sales:_,getTotalQ4:v,getTotalSales:T,getTotalZeroPercent:B,getZeroPercentRate:()=>{const s=T(),l=B();return s>0?l/s*100:0},getTotalOpen2026:()=>g.value.reduce((s,l)=>s+(parseFloat(l.open_2026)||0),0)}}function se(){const h=j(),{apiCall:f}=h,{isHospitality:g}=U(),n=y([]),c=y({}),w=y(new Set),b=y(new Set),d=y({}),S=y({customer_classes:[],customer_names:[],brands:[],flags:[]});let p=null;const _=e=>{const t=e.brand||"null",a=e.flag||"null",r=e.customer_name||"null",u=e.customer_class||e.derived_customer_class||"null";return`${t}_${a}_${r}_${u}`},v=(e,t)=>`${_(e)}_${t}`,T=async()=>{try{const e=await f("/api/budget");if(!e.ok)throw new Error("Failed to fetch budget data");const t=await e.json();n.value=t.data||[],c.value={},n.value.forEach(a=>{const r=_(a);c.value[r]=a})}catch(e){console.error("Error fetching budgets:",e)}},B=async(e,t,a)=>{const r=v(e,t);w.value.add(r);try{if(!h.currentSalesperson)throw new Error("Salesperson data not available");const u=_(e),q=c.value[u],x={salesperson_id:h.currentSalesperson.salesman_no,salesperson_name:h.currentSalesperson.salesman_name,brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:g.value?"Hospitality":e.derived_customer_class,[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let m;if(q?m=await f(`/api/budget/${q.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):m=await f("/api/budget",{method:"POST",body:JSON.stringify(x)}),!m.ok)throw new Error("Failed to save budget");const i=await m.json();q?q[`quarter_${t}_sales`]=parseFloat(a)||0:(c.value[u]=i.data,n.value.push(i.data)),b.value.add(r),setTimeout(()=>b.value.delete(r),1e3),C()}catch(u){console.error("Error saving budget:",u)}finally{w.value.delete(r)}},Q=(e,t)=>{const a=v(e,t);if(d.value.hasOwnProperty(a))return d.value[a];const r=_(e),u=c.value[r];return u&&u[`quarter_${t}_sales`]||0},P=(e,t)=>{const a=v(e,t);return w.value.has(a)?"bg-blue-50 border-blue-300":b.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},s=(e,t,a)=>{p&&clearTimeout(p),p=setTimeout(()=>{a&&a!=="0"&&a!==""&&B(e,t,a)},2e3)},l=(e,t,a)=>{const r=v(t,a),u=e.target.value;d.value[r]=u,C(),s(t,a,u)},O=(e,t,a)=>{const r=e.target.value,u=v(t,a);p&&(clearTimeout(p),p=null),delete d.value[u],C(),B(t,a,r)},$=(e,t,a)=>{const r=v(t,a);d.value[r]=e.target.value,e.key==="Enter"&&e.target.blur()},C=()=>{const e={};Object.keys(d.value).forEach(t=>{const a=d.value[t];a&&a!=="0"&&a!==""&&(e[t]=a)}),localStorage.setItem("budget_pending_changes",JSON.stringify(e))};return{budgets:n,budgetMap:c,savingCells:w,savedCells:b,inputValues:d,autosuggestData:S,fetchBudgets:T,saveBudgetCell:B,getBudgetValue:Q,getCellClass:P,handleBudgetChange:l,handleBudgetBlur:O,handleBudgetInput:$,savePendingChangesToStorage:C,loadPendingChangesFromStorage:()=>{try{const e=localStorage.getItem("budget_pending_changes");if(e){const t=JSON.parse(e);return Object.keys(t).forEach(a=>{d.value[a]=t[a]}),Object.keys(t).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},clearPendingChangesFromStorage:()=>{localStorage.removeItem("budget_pending_changes")},fetchAutosuggestData:async()=>{try{const e=await f("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();S.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},createCustomBudget:async e=>{try{if(!h.currentSalesperson)throw new Error("Salesperson data not available");const t={...e,salesperson_id:h.currentSalesperson.salesman_no,salesperson_name:h.currentSalesperson.salesman_name,customer_class:g.value?"Hospitality":e.customer_class,quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},a=await f("/api/budget",{method:"POST",body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to create custom budget");const r=await a.json(),u=_(r.data);return c.value[u]=r.data,n.value.push(r.data),r.data}catch(t){throw console.error("Error creating custom budget:",t),t}},deleteCustomBudget:async e=>{try{if(!(await f(`/api/budget/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const a=n.value.findIndex(r=>r.id===e);if(a!==-1){const r=n.value[a],u=_(r);delete c.value[u],n.value.splice(a,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},getCustomBudgets:()=>n.value.filter(e=>e.is_custom===!0),getTotalQ1Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),getTotalQ2Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),getTotalQ3Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),getTotalQ4Budget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0),getTotalBudget:()=>n.value.reduce((e,t)=>e+(parseFloat(t.total_sales)||0),0),cleanup:()=>{p&&clearTimeout(p)}}}const oe={class:"mx-auto px-4 py-8"},re={key:0,class:"flex justify-center"},le={key:1,class:"alert alert-error"},ne={key:2,class:"text-center py-8"},ue={key:3},de={__name:"SalesView",setup(h){const{currentUser:f,currentSalesperson:g}=j(),n=ee("addBudgetModal"),{sales:c,loading:w,error:b,isHospitality:d,fetchSales:S,getTotalQ1:p,getTotalQ2:_,getTotalQ3:v,getTotalQ4Sales:T,getTotalQ4:B,getTotalSales:Q,getTotalZeroPercent:P,getZeroPercentRate:s,getTotalOpen2026:l}=U(),{fetchBudgets:O,getBudgetValue:$,getCellClass:C,handleBudgetChange:D,handleBudgetBlur:N,handleBudgetInput:A,loadPendingChangesFromStorage:z,fetchAutosuggestData:H,createCustomBudget:I,deleteCustomBudget:K,getCustomBudgets:M,getTotalQ1Budget:V,getTotalQ2Budget:Z,getTotalQ3Budget:J,getTotalQ4Budget:R,getTotalBudget:e,autosuggestData:t,cleanup:a}=se(),r=()=>{n.close()},u=async m=>{console.log("handleCustomBudgetCreated called with:",m);try{await I(m),console.log("Custom budget created successfully")}catch(i){console.error("Error creating custom budget:",i)}},q=async m=>{try{await K(m),console.log("Custom budget deleted successfully")}catch(i){console.error("Error deleting custom budget:",i)}},x=async()=>{await H()};return G(async()=>{await S(),await O(),z()&&console.log("Restored pending budget changes from localStorage"),window.addEventListener("beforeunload",i=>{})}),X(()=>{window.removeEventListener("beforeunload",()=>{}),a()}),(m,i)=>(k(),F("div",oe,[o(w)?(k(),F("div",re,[...i[0]||(i[0]=[E("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):o(b)?(k(),F("div",le,[i[1]||(i[1]=E("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[E("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),E("span",null,Y(o(b)),1)])):o(c).length===0?(k(),F("div",ne,[...i[2]||(i[2]=[E("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(k(),F("div",ue,[L(te,{sales:o(c),"custom-budgets":o(M)(),"get-budget-value":o($),"get-cell-class":o(C),"handle-budget-change":o(D),"handle-budget-blur":o(N),"handle-budget-input":o(A),"handle-delete-custom-budget":q,"is-hospitality":o(d),"get-total-q1":o(p),"get-total-q2":o(_),"get-total-q3":o(v),"get-total-q4-sales":o(T),"get-total-q4":o(B),"get-total-sales":o(Q),"get-total-zero-percent":o(P),"get-zero-percent-rate":o(s),"get-total-open-2026":o(l),"get-total-q1-budget":o(V),"get-total-q2-budget":o(Z),"get-total-q3-budget":o(J),"get-total-q4-budget":o(R),"get-total-budget":o(e)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),L(ae,{"is-open":o(n).isOpen.value,"is-hospitality":o(d),"autosuggest-data":o(t),onClose:r,onCreated:u,onFetchAutosuggest:x},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{de as default};
