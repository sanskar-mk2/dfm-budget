import{u as j,r as y,c as W,o as G,a as X,b as F,d as L,e as o,f as E,t as Y,i as ee,g as k}from"./index-BLyOduZl.js";import{_ as te,a as ae}from"./AddCustomBudgetModal-S8bh-NXt.js";function U(){const h=j(),{apiCall:f}=h,c=y([]),u=y(!1),g=y(""),w=W(()=>(h.currentSalesperson?.role||"").startsWith("Hospitality")),b=async()=>{u.value=!0,g.value="";try{const s=await f("/api/sales");if(!s.ok)throw new Error("Failed to fetch sales data");const n=await s.json();c.value=n.data||[]}catch(s){g.value=s.message,console.error("Error fetching sales:",s)}finally{u.value=!1}},d=()=>c.value.reduce((s,n)=>s+(parseFloat(n.q1_sales)||0),0),S=()=>c.value.reduce((s,n)=>s+(parseFloat(n.q2_sales)||0),0),p=()=>c.value.reduce((s,n)=>s+(parseFloat(n.q3_sales)||0),0),_=()=>c.value.reduce((s,n)=>s+(parseFloat(n.q4_sales)||0),0),v=()=>c.value.reduce((s,n)=>s+(parseFloat(n.q4_orders)||0),0),T=()=>c.value.reduce((s,n)=>s+(parseFloat(n.total_sales)||0),0),B=()=>c.value.reduce((s,n)=>s+(parseFloat(n.zero_perc_sales_total)||0),0);return{sales:c,loading:u,error:g,isHospitality:w,fetchSales:b,getTotalQ1:d,getTotalQ2:S,getTotalQ3:p,getTotalQ4Sales:_,getTotalQ4:v,getTotalSales:T,getTotalZeroPercent:B,getZeroPercentRate:()=>{const s=T(),n=B();return s>0?n/s*100:0},getTotalOpen2026:()=>c.value.reduce((s,n)=>s+(parseFloat(n.open_2026)||0),0)}}function se(){const h=j(),{apiCall:f}=h,{isHospitality:c}=U(),u=y([]),g=y({}),w=y(new Set),b=y(new Set),d=y({}),S=y({customer_classes:[],customer_names:[],brands:[],flags:[]});let p=null;const _=e=>{const t=e.brand||"null",a=e.flag||"null",r=e.customer_name||"null";let l=e.customer_class||e.derived_customer_class;return c.value&&t!=="null"&&a!=="null"&&(l=l||"Hospitality"),l=l||"null",`${t}_${a}_${r}_${l}`},v=(e,t)=>`${_(e)}_${t}`,T=async()=>{try{const e=await f("/api/budget");if(!e.ok)throw new Error("Failed to fetch budget data");const t=await e.json();u.value=t.data||[],g.value={},u.value.forEach(a=>{const r=_(a);g.value[r]=a})}catch(e){console.error("Error fetching budgets:",e)}},B=async(e,t,a)=>{const r=v(e,t);w.value.add(r);try{if(!h.currentSalesperson)throw new Error("Salesperson data not available");const l=_(e),q=g.value[l],x={salesperson_id:h.currentSalesperson.salesman_no,salesperson_name:h.currentSalesperson.salesman_name,brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:c.value?"Hospitality":e.derived_customer_class,[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let m;if(q?m=await f(`/api/budget/${q.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):m=await f("/api/budget",{method:"POST",body:JSON.stringify(x)}),!m.ok)throw new Error("Failed to save budget");const i=await m.json();q?q[`quarter_${t}_sales`]=parseFloat(a)||0:(g.value[l]=i.data,u.value.push(i.data)),b.value.add(r),setTimeout(()=>b.value.delete(r),1e3),C()}catch(l){console.error("Error saving budget:",l)}finally{w.value.delete(r)}},Q=(e,t)=>{const a=v(e,t);if(d.value.hasOwnProperty(a))return d.value[a];const r=_(e),l=g.value[r];return l&&l[`quarter_${t}_sales`]||0},P=(e,t)=>{const a=v(e,t);return w.value.has(a)?"bg-blue-50 border-blue-300":b.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},s=(e,t,a)=>{p&&clearTimeout(p),p=setTimeout(()=>{a&&a!=="0"&&a!==""&&B(e,t,a)},2e3)},n=(e,t,a)=>{const r=v(t,a),l=e.target.value;d.value[r]=l,C(),s(t,a,l)},O=(e,t,a)=>{const r=e.target.value,l=v(t,a);p&&(clearTimeout(p),p=null),delete d.value[l],C(),B(t,a,r)},$=(e,t,a)=>{const r=v(t,a);d.value[r]=e.target.value,e.key==="Enter"&&e.target.blur()},C=()=>{const e={};Object.keys(d.value).forEach(t=>{const a=d.value[t];a&&a!=="0"&&a!==""&&(e[t]=a)}),localStorage.setItem("budget_pending_changes",JSON.stringify(e))};return{budgets:u,budgetMap:g,savingCells:w,savedCells:b,inputValues:d,autosuggestData:S,fetchBudgets:T,saveBudgetCell:B,getBudgetValue:Q,getCellClass:P,handleBudgetChange:n,handleBudgetBlur:O,handleBudgetInput:$,savePendingChangesToStorage:C,loadPendingChangesFromStorage:()=>{try{const e=localStorage.getItem("budget_pending_changes");if(e){const t=JSON.parse(e);return Object.keys(t).forEach(a=>{d.value[a]=t[a]}),Object.keys(t).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},clearPendingChangesFromStorage:()=>{localStorage.removeItem("budget_pending_changes")},fetchAutosuggestData:async()=>{try{const e=await f("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();S.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},createCustomBudget:async e=>{try{if(!h.currentSalesperson)throw new Error("Salesperson data not available");const t={...e,salesperson_id:h.currentSalesperson.salesman_no,salesperson_name:h.currentSalesperson.salesman_name,customer_class:c.value?"Hospitality":e.customer_class,quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},a=await f("/api/budget",{method:"POST",body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to create custom budget");const r=await a.json(),l=_(r.data);return g.value[l]=r.data,u.value.push(r.data),r.data}catch(t){throw console.error("Error creating custom budget:",t),t}},deleteCustomBudget:async e=>{try{if(!(await f(`/api/budget/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const a=u.value.findIndex(r=>r.id===e);if(a!==-1){const r=u.value[a],l=_(r);delete g.value[l],u.value.splice(a,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},getCustomBudgets:()=>u.value.filter(e=>e.is_custom===!0),getTotalQ1Budget:()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),getTotalQ2Budget:()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),getTotalQ3Budget:()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),getTotalQ4Budget:()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0),getTotalBudget:()=>u.value.reduce((e,t)=>e+(parseFloat(t.total_sales)||0),0),cleanup:()=>{p&&clearTimeout(p)}}}const oe={class:"mx-auto px-4 py-8"},re={key:0,class:"flex justify-center"},le={key:1,class:"alert alert-error"},ne={key:2,class:"text-center py-8"},ue={key:3},de={__name:"SalesView",setup(h){const{currentUser:f,currentSalesperson:c}=j(),u=ee("addBudgetModal"),{sales:g,loading:w,error:b,isHospitality:d,fetchSales:S,getTotalQ1:p,getTotalQ2:_,getTotalQ3:v,getTotalQ4Sales:T,getTotalQ4:B,getTotalSales:Q,getTotalZeroPercent:P,getZeroPercentRate:s,getTotalOpen2026:n}=U(),{fetchBudgets:O,getBudgetValue:$,getCellClass:C,handleBudgetChange:D,handleBudgetBlur:N,handleBudgetInput:A,loadPendingChangesFromStorage:H,fetchAutosuggestData:z,createCustomBudget:I,deleteCustomBudget:K,getCustomBudgets:M,getTotalQ1Budget:V,getTotalQ2Budget:Z,getTotalQ3Budget:J,getTotalQ4Budget:R,getTotalBudget:e,autosuggestData:t,cleanup:a}=se(),r=()=>{u.close()},l=async m=>{console.log("handleCustomBudgetCreated called with:",m);try{await I(m),console.log("Custom budget created successfully")}catch(i){console.error("Error creating custom budget:",i)}},q=async m=>{try{await K(m),console.log("Custom budget deleted successfully")}catch(i){console.error("Error deleting custom budget:",i)}},x=async()=>{await z()};return G(async()=>{await S(),await O(),H()&&console.log("Restored pending budget changes from localStorage"),window.addEventListener("beforeunload",i=>{})}),X(()=>{window.removeEventListener("beforeunload",()=>{}),a()}),(m,i)=>(k(),F("div",oe,[o(w)?(k(),F("div",re,[...i[0]||(i[0]=[E("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):o(b)?(k(),F("div",le,[i[1]||(i[1]=E("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[E("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),E("span",null,Y(o(b)),1)])):o(g).length===0?(k(),F("div",ne,[...i[2]||(i[2]=[E("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(k(),F("div",ue,[L(te,{sales:o(g),"custom-budgets":o(M)(),"get-budget-value":o($),"get-cell-class":o(C),"handle-budget-change":o(D),"handle-budget-blur":o(N),"handle-budget-input":o(A),"handle-delete-custom-budget":q,"is-hospitality":o(d),"get-total-q1":o(p),"get-total-q2":o(_),"get-total-q3":o(v),"get-total-q4-sales":o(T),"get-total-q4":o(B),"get-total-sales":o(Q),"get-total-zero-percent":o(P),"get-zero-percent-rate":o(s),"get-total-open-2026":o(n),"get-total-q1-budget":o(V),"get-total-q2-budget":o(Z),"get-total-q3-budget":o(J),"get-total-q4-budget":o(R),"get-total-budget":o(e)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),L(ae,{"is-open":o(u).isOpen.value,"is-hospitality":o(d),"autosuggest-data":o(t),onClose:r,onCreated:l,onFetchAutosuggest:x},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{de as default};
