import{u as z,r as V,c as F,b as f,g as v,f as t,p as M,t as o,F as L,j as H,h as T,d as O,w as I,A as Y,s as J,o as W,a as X,i as Z,e as P}from"./index-BLyOduZl.js";import{_ as K,d as tt,f as k}from"./downloadUtils-CgUiZzHL.js";function et(){const h=z(),$=V(!1),u=V(null),g=V([]),l=F(()=>{if(!g.value.length)return[];const a={};return g.value.forEach(e=>{const c=`${e.salesperson_id}-${e.customer_class}-${e.group_key}`;a[c]||(a[c]={salesperson_id:e.salesperson_id,salesperson_name:e.salesperson_name,customer_class:e.customer_class,group_key:e.group_key,brand:e.brand,display_key:e.customer_class==="Hospitality"&&e.brand?`${e.group_key} (${e.brand})`:e.group_key,divisions:[],totalRatio:0,hasCustomRatios:!1,usesDefaultRatios:!1,has_budget:e.has_budget!==void 0?e.has_budget:!0});const p={item_division:e.item_division,division_name:e.division_name,effective_ratio:e.effective_ratio,is_custom:e.is_custom,uses_default_ratios:e.uses_default_ratios||!1,q1_allocated:e.q1_allocated,q2_allocated:e.q2_allocated,q3_allocated:e.q3_allocated,q4_allocated:e.q4_allocated,total_allocated:e.total_allocated,division_ratio_2025:e.division_ratio_2025,total_2025_sales:e.total_2025_sales,q1_sales:e.q1_sales,q2_sales:e.q2_sales,q3_sales:e.q3_sales,q4_sales:e.q4_sales,gp_percent:e.gp_percent,q1_gp_percent:e.q1_gp_percent,q2_gp_percent:e.q2_gp_percent,q3_gp_percent:e.q3_gp_percent,q4_gp_percent:e.q4_gp_percent,q1_gp_value:e.q1_gp_value,q2_gp_value:e.q2_gp_value,q3_gp_value:e.q3_gp_value,q4_gp_value:e.q4_gp_value,total_gp_value:e.total_gp_value,locked:!1};a[c].divisions.push(p),a[c].totalRatio+=p.effective_ratio,p.is_custom&&(a[c].hasCustomRatios=!0),p.uses_default_ratios&&(a[c].usesDefaultRatios=!0)}),Object.values(a).forEach(e=>{e.divisions.sort((c,p)=>c.item_division-p.item_division)}),Object.values(a)}),q=async()=>{$.value=!0,u.value=null;try{const a=await h.apiCall("/api/division/allocations");if(a.ok){const e=await a.json();g.value=e.data||[]}else{const e=await a.json();console.error("Error fetching division data:",e),u.value=e.detail||"Failed to fetch division data"}}catch(a){console.error("Exception fetching division data:",a),u.value="Network error occurred"}finally{$.value=!1}},D=async(a,e,c)=>{const p=await h.apiCall(`/api/division/allocations/${a}/${encodeURIComponent(e)}/${encodeURIComponent(c)}`);if(!p.ok)throw new Error("Failed to fetch group");return(await p.json()).data||[]},b=async(a,e)=>{try{const c=l.value.find(r=>r.group_key===a);if(!c)throw new Error("Group not found");const p=e.filter(r=>r.is_custom||r.effective_ratio!==r.division_ratio_2025).map(r=>({salesperson_id:c.salesperson_id,salesperson_name:c.salesperson_name,customer_class:c.customer_class,group_key:c.group_key,item_division:r.item_division,custom_ratio:r.effective_ratio}));if(p.length===0)return console.log("No changes to save"),{success:!0,message:"No changes to save"};const w=await h.apiCall("/api/division/save-ratios",{method:"POST",body:JSON.stringify({overrides:p})});if(w.ok){const r=await w.json(),x=await D(c.salesperson_id,c.customer_class,c.group_key),A=[...g.value];if(A.filter(Q=>Q.group_key===c.group_key&&Q.salesperson_id===c.salesperson_id).length>0){const Q=A.findIndex(C=>C.group_key===c.group_key&&C.salesperson_id===c.salesperson_id),G=A.filter(C=>!(C.group_key===c.group_key&&C.salesperson_id===c.salesperson_id));G.splice(Q,0,...x),g.value=G}else g.value=[...g.value.filter(Q=>!(Q.group_key===c.group_key&&Q.salesperson_id===c.salesperson_id)),...x];return r}else{const r=await w.json();throw console.error("Error saving ratios:",r),new Error(r.detail||"Failed to save ratios")}}catch(c){throw console.error("Exception saving ratios:",c),c}},d=async(a,e,c)=>{try{const p=await h.apiCall(`/api/division/reset-group/${a}/${encodeURIComponent(e)}/${encodeURIComponent(c)}`,{method:"DELETE"});if(p.ok){const w=await p.json(),r=await D(a,e,c),x=[...g.value];if(x.filter(R=>R.group_key===c&&R.salesperson_id===a).length>0){const R=x.findIndex(G=>G.group_key===c&&G.salesperson_id===a),Q=x.filter(G=>!(G.group_key===c&&G.salesperson_id===a));Q.splice(R,0,...r),g.value=Q}else g.value=[...g.value.filter(R=>!(R.group_key===c&&R.salesperson_id===a)),...r];return w}else{const w=await p.json();throw new Error(w.detail||"Failed to reset group overrides")}}catch(p){throw console.error("Exception resetting group overrides:",p),p}};return{loading:$,error:u,divisionData:g,groupedData:l,fetchDivisionData:q,saveRatios:b,resetGroupOverrides:d,resetAllOverrides:async()=>{try{const a=l.value.filter(e=>e.hasCustomRatios).map(e=>d(e.salesperson_id,e.customer_class,e.group_key));return a.length===0?{success:!0,message:"No overrides to reset"}:(await Promise.all(a),{success:!0,message:`Reset overrides for ${a.length} groups`})}catch(a){throw console.error("Exception resetting all overrides:",a),a}}}}const st={class:"flex items-center gap-2"},at=["disabled","title"],ot={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},lt={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},nt={class:"flex-1"},rt=["value","disabled"],ct={class:"text-sm font-mono min-w-[4rem] text-right"},it={__name:"DivisionSlider",props:{ratio:{type:Number,required:!0},locked:{type:Boolean,default:!1},divisionName:{type:String,required:!0},disabled:{type:Boolean,default:!1}},emits:["ratio-change","lock-toggle"],setup(h,{emit:$}){const u=h,g=$,l=F(()=>(u.ratio*100).toFixed(1)),q=b=>{if(!u.locked&&!u.disabled){const d=parseFloat(b.target.value);g("ratio-change",d)}},D=()=>{u.disabled||g("lock-toggle")};return(b,d)=>(v(),f("div",st,[t("button",{onClick:D,disabled:h.disabled,class:M(["btn btn-sm btn-ghost",h.locked?"btn-primary":"btn-outline",h.disabled?"btn-disabled":""]),title:h.locked?"Unlock to edit":"Lock to prevent changes"},[h.locked?(v(),f("svg",ot,[...d[0]||(d[0]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"},null,-1)])])):(v(),f("svg",lt,[...d[1]||(d[1]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"},null,-1)])]))],10,at),t("div",nt,[t("input",{type:"range",min:0,max:1,step:.001,value:h.ratio,disabled:h.locked||h.disabled,onInput:q,class:M(["range range-primary range-sm w-full",{"opacity-50":h.locked||h.disabled}])},null,42,rt)]),t("div",ct,[t("span",{class:M(["badge badge-sm",h.locked?"badge-primary":"badge-outline"])},o(l.value)+"% ",3)])]))}},_t={class:"overflow-x-auto"},dt={class:"table table-zebra w-full"},ut={class:"text-sm opacity-60"},ht={class:"flex flex-col"},gt={class:"font-medium"},pt={key:0,class:"text-xs badge badge-primary badge-sm"},mt={class:"text-right font-mono text-sm"},ft={class:"text-right font-mono text-sm"},vt={class:"text-right font-mono text-sm"},xt={class:"text-right font-mono text-sm"},qt={class:"text-right font-mono text-sm"},yt={class:"text-right font-mono text-sm"},kt={class:"text-right font-mono text-sm"},bt={class:"text-right font-mono text-sm"},Qt={class:"text-right font-mono text-sm"},St={class:"text-right font-mono text-sm"},Gt={class:"text-right font-mono text-sm"},$t={class:"text-right font-mono text-sm"},wt={class:"text-right font-mono text-sm"},Rt={class:"text-right font-mono text-sm"},Ct={class:"text-right font-mono text-sm"},Pt={class:"text-right font-mono text-sm"},Dt={class:"text-right font-mono text-sm"},At={class:"text-right font-mono text-sm"},Et={class:"text-right font-mono text-sm"},Ft={class:"text-right font-mono font-semibold"},Tt={class:"bg-base-200 font-bold"},jt={class:"text-right"},Nt={class:"text-lg"},Bt={class:"text-right"},Vt={class:"text-lg"},Mt={class:"text-right"},Ot={class:"text-lg"},Lt={class:"text-right"},Ut={class:"text-lg"},zt={class:"text-right"},Ht={class:"text-lg"},It={class:"text-right"},Yt={class:"text-lg"},Jt={class:"text-right"},Wt={class:"text-lg"},Xt={class:"text-right"},Zt={class:"text-lg"},Kt={class:"text-right"},te={class:"text-lg"},ee={class:"text-right"},se={class:"text-lg"},ae={class:"text-right"},oe={class:"text-lg"},le={class:"text-right"},ne={class:"text-lg"},re={class:"text-right"},ce={class:"text-lg"},ie={class:"text-right"},_e={class:"text-lg"},de={class:"text-right"},ue={class:"text-lg"},he={class:"text-right"},ge={class:"text-lg"},pe={__name:"DivisionTable",props:{divisions:{type:Array,required:!0},readonly:{type:Boolean,default:!1}},emits:["ratio-change","lock-toggle"],setup(h,{emit:$}){const u=h,g=$,l=_=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(_),q=(_,a)=>{g("ratio-change",_,a)},D=_=>{g("lock-toggle",_)},b=_=>_==null||_===void 0?"-":(_*100).toFixed(1)+"%",d=F(()=>!u.divisions||u.divisions.length===0?{totalRatio:0,totalActualSales:0,totalQ1Sales:0,totalQ2Sales:0,totalQ3Sales:0,totalQ4Sales:0,totalQ1:0,totalQ2:0,totalQ3:0,totalQ4:0,totalAllocated:0,totalQ1Gp:0,totalQ2Gp:0,totalQ3Gp:0,totalQ4Gp:0,totalGp:0}:u.divisions.reduce((_,a)=>(_.totalRatio+=a.effective_ratio||0,_.totalActualSales+=a.total_2025_sales||0,_.totalQ1Sales+=a.q1_sales||0,_.totalQ2Sales+=a.q2_sales||0,_.totalQ3Sales+=a.q3_sales||0,_.totalQ4Sales+=a.q4_sales||0,_.totalQ1+=a.q1_allocated||0,_.totalQ2+=a.q2_allocated||0,_.totalQ3+=a.q3_allocated||0,_.totalQ4+=a.q4_allocated||0,_.totalAllocated+=a.total_allocated||0,_.totalQ1Gp+=a.q1_gp_value||0,_.totalQ2Gp+=a.q2_gp_value||0,_.totalQ3Gp+=a.q3_gp_value||0,_.totalQ4Gp+=a.q4_gp_value||0,_.totalGp+=a.total_gp_value||0,_),{totalRatio:0,totalActualSales:0,totalQ1Sales:0,totalQ2Sales:0,totalQ3Sales:0,totalQ4Sales:0,totalQ1:0,totalQ2:0,totalQ3:0,totalQ4:0,totalAllocated:0,totalQ1Gp:0,totalQ2Gp:0,totalQ3Gp:0,totalQ4Gp:0,totalGp:0}));return(_,a)=>(v(),f("div",_t,[t("table",dt,[a[6]||(a[6]=t("thead",null,[t("tr",null,[t("th",{class:"w-8"},"#"),t("th",null,"Division"),t("th",{class:"w-80"},"Effective Ratio"),t("th",{class:"text-right"},"2025 Sales"),t("th",{class:"text-right"},"Q1 Sales"),t("th",{class:"text-right"},"Q2 Sales"),t("th",{class:"text-right"},"Q3 Sales"),t("th",{class:"text-right"},"Q4 Sales"),t("th",{class:"text-right"},"GP%"),t("th",{class:"text-right"},"Q1 GP%"),t("th",{class:"text-right"},"Q2 GP%"),t("th",{class:"text-right"},"Q3 GP%"),t("th",{class:"text-right"},"Q4 GP%"),t("th",{class:"text-right"},"GP $"),t("th",{class:"text-right"},"Q1 GP"),t("th",{class:"text-right"},"Q2 GP"),t("th",{class:"text-right"},"Q3 GP"),t("th",{class:"text-right"},"Q4 GP"),t("th",{class:"text-right"},"Q1"),t("th",{class:"text-right"},"Q2"),t("th",{class:"text-right"},"Q3"),t("th",{class:"text-right"},"Q4"),t("th",{class:"text-right"},"Total")])],-1)),t("tbody",null,[(v(!0),f(L,null,H(h.divisions,(e,c)=>(v(),f("tr",{key:e.item_division},[t("td",ut,o(e.item_division),1),t("td",null,[t("div",ht,[t("span",gt,o(e.division_name),1),e.is_custom?(v(),f("span",pt," Custom ")):T("",!0)])]),t("td",null,[O(it,{ratio:e.effective_ratio,locked:e.locked,"division-name":e.division_name,disabled:h.readonly,onRatioChange:p=>q(c,p),onLockToggle:()=>D(c)},null,8,["ratio","locked","division-name","disabled","onRatioChange","onLockToggle"])]),t("td",mt,o(l(e.total_2025_sales)),1),t("td",ft,o(l(e.q1_sales)),1),t("td",vt,o(l(e.q2_sales)),1),t("td",xt,o(l(e.q3_sales)),1),t("td",qt,o(l(e.q4_sales)),1),t("td",yt,o(b(e.gp_percent)),1),t("td",kt,o(b(e.q1_gp_percent)),1),t("td",bt,o(b(e.q2_gp_percent)),1),t("td",Qt,o(b(e.q3_gp_percent)),1),t("td",St,o(b(e.q4_gp_percent)),1),t("td",Gt,o(l(e.total_gp_value)),1),t("td",$t,o(l(e.q1_gp_value)),1),t("td",wt,o(l(e.q2_gp_value)),1),t("td",Rt,o(l(e.q3_gp_value)),1),t("td",Ct,o(l(e.q4_gp_value)),1),t("td",Pt,o(l(e.q1_allocated)),1),t("td",Dt,o(l(e.q2_allocated)),1),t("td",At,o(l(e.q3_allocated)),1),t("td",Et,o(l(e.q4_allocated)),1),t("td",Ft,o(l(e.total_allocated)),1)]))),128))]),t("tfoot",null,[t("tr",Tt,[a[0]||(a[0]=t("td",{colspan:"2",class:"text-right"},[t("span",{class:"text-lg"},"Total")],-1)),t("td",jt,[t("span",Nt,o((d.value.totalRatio*100).toFixed(2))+"%",1)]),t("td",Bt,[t("span",Vt,o(l(d.value.totalActualSales)),1)]),t("td",Mt,[t("span",Ot,o(l(d.value.totalQ1Sales)),1)]),t("td",Lt,[t("span",Ut,o(l(d.value.totalQ2Sales)),1)]),t("td",zt,[t("span",Ht,o(l(d.value.totalQ3Sales)),1)]),t("td",It,[t("span",Yt,o(l(d.value.totalQ4Sales)),1)]),a[1]||(a[1]=t("td",{class:"text-right"},[t("span",{class:"text-lg"},"-")],-1)),a[2]||(a[2]=t("td",{class:"text-right"},[t("span",{class:"text-lg"},"-")],-1)),a[3]||(a[3]=t("td",{class:"text-right"},[t("span",{class:"text-lg"},"-")],-1)),a[4]||(a[4]=t("td",{class:"text-right"},[t("span",{class:"text-lg"},"-")],-1)),a[5]||(a[5]=t("td",{class:"text-right"},[t("span",{class:"text-lg"},"-")],-1)),t("td",Jt,[t("span",Wt,o(l(d.value.totalGp)),1)]),t("td",Xt,[t("span",Zt,o(l(d.value.totalQ1Gp)),1)]),t("td",Kt,[t("span",te,o(l(d.value.totalQ2Gp)),1)]),t("td",ee,[t("span",se,o(l(d.value.totalQ3Gp)),1)]),t("td",ae,[t("span",oe,o(l(d.value.totalQ4Gp)),1)]),t("td",le,[t("span",ne,o(l(d.value.totalQ1)),1)]),t("td",re,[t("span",ce,o(l(d.value.totalQ2)),1)]),t("td",ie,[t("span",_e,o(l(d.value.totalQ3)),1)]),t("td",de,[t("span",ue,o(l(d.value.totalQ4)),1)]),t("td",he,[t("span",ge,o(l(d.value.totalAllocated)),1)])])])])]))}},me={class:"card-body"},fe={class:"flex items-center justify-between mb-4"},ve={class:"flex items-center gap-2"},xe={class:"card-title text-lg"},qe={key:0,class:"badge badge-warning badge-sm",title:"No budget exists for this group. Historical sales data only - read-only."},ye={key:1,class:"badge badge-warning badge-sm"},ke={key:0,class:"flex items-center gap-2"},be=["disabled"],Qe=["disabled"],Se={key:0,class:"alert alert-warning mt-2"},Ge={key:0},$e={key:1},we={__name:"DivisionGroupCard",props:{group:{type:Object,required:!0}},emits:["save-ratios","reset-group","collapse"],setup(h,{emit:$}){const u=h,g=$,l=V([]);I(()=>u.group,r=>{r&&r.divisions&&(l.value=r.divisions.map(x=>({...x})))},{immediate:!0});const q=F(()=>u.group.has_budget!==void 0&&u.group.has_budget!==!1),D=F(()=>l.value.reduce((r,x)=>r+x.effective_ratio,0)),b=F(()=>`${u.group.customer_class} > ${u.group.salesperson_name} > ${u.group.display_key}`),d=F(()=>{const r=D.value;return Math.abs(r-1)<.001?{status:"perfect",icon:"✅",class:"text-success"}:r>1?{status:"over",icon:"⚠️",class:"text-warning"}:{status:"under",icon:"⚠️",class:"text-warning"}}),_=F(()=>l.value.some(r=>r.effective_ratio!==r.division_ratio_2025||r.is_custom)),a=(r,x)=>{const A=l.value.map((S,E)=>({...S,index:E})).filter(S=>!S.locked);if(A.length<=1){l.value[r].effective_ratio=1;return}const Q=1-l.value.filter(S=>S.locked).reduce((S,E)=>S+E.effective_ratio,0),G=Math.min(x,Q);l.value[r].effective_ratio=G;const C=A.filter(S=>S.index!==r),j=C.reduce((S,E)=>S+E.effective_ratio,0);if(j>0){const E=(Q-G)/j;C.forEach(B=>{l.value[B.index].effective_ratio=B.effective_ratio*E})}},e=(r,x)=>{q.value&&a(r,x)},c=r=>{q.value&&(l.value[r].locked=!l.value[r].locked)},p=async()=>{if(q.value)try{await g("save-ratios",u.group.group_key,l.value)}catch(r){console.error("Error saving ratios:",r)}},w=async()=>{if(q.value)try{await g("reset-group",u.group.salesperson_id,u.group.customer_class,u.group.group_key)}catch(r){console.error("Error resetting group:",r)}};return(r,x)=>(v(),f("div",{class:M(["card shadow-xl border transition-all duration-200",q.value?"bg-base-100 border-base-300 hover:shadow-2xl":"bg-base-200 border-base-300 opacity-90"])},[t("div",me,[t("div",fe,[t("div",ve,[t("h3",xe,o(b.value),1),q.value?T("",!0):(v(),f("span",qe," No Budget ")),h.group.usesDefaultRatios?(v(),f("span",ye," Missing historical data, using average ratios ")):T("",!0)]),q.value?(v(),f("div",ke,[t("button",{onClick:w,class:"btn btn-ghost btn-sm",disabled:!_.value}," Reset ",8,be),t("button",{onClick:p,class:"btn btn-primary btn-sm",disabled:!_.value||d.value.status!=="perfect"}," Save Changes ",8,Qe)])):T("",!0)]),O(pe,{divisions:l.value,readonly:!q.value,onRatioChange:e,onLockToggle:c},null,8,["divisions","readonly"]),d.value.status!=="perfect"?(v(),f("div",Se,[x[0]||(x[0]=t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})],-1)),t("span",null,[d.value.status==="over"?(v(),f("span",Ge," Total ratio exceeds 100%. Adjust sliders to balance the ratios. ")):(v(),f("span",$e," Total ratio is under 100%. Adjust sliders to reach 100%. "))])])):T("",!0)])],2))}},Re={class:"p-6 space-y-6"},Ce={key:0,class:"space-y-6"},Pe={class:"stats shadow mb-6"},De={class:"stat"},Ae={class:"stat-value text-primary"},Ee={class:"stat"},Fe={class:"stat-value text-secondary"},Te={class:"stat"},je={class:"stat-value text-accent"},Ne={class:"overflow-x-auto"},Be={class:"table table-zebra w-full"},Ve=["onClick"],Me={class:"font-semibold"},Oe={class:"text-xs opacity-70"},Le={class:"text-right font-mono"},Ue={class:"text-right font-mono"},ze={class:"text-right font-mono"},He={class:"text-right font-mono"},Ie={class:"text-right font-mono"},Ye={class:"text-right font-mono"},Je={class:"text-right font-mono"},We={class:"text-right font-mono"},Xe={class:"text-right font-mono"},Ze={class:"text-right font-mono"},Ke={class:"text-right font-mono"},ts={class:"text-right font-mono"},es={class:"text-right font-mono"},ss={class:"text-right font-mono"},as={class:"text-right font-mono"},os={class:"text-right font-mono"},ls={class:"text-right font-mono"},ns={class:"text-right font-mono"},rs={class:"text-right font-mono"},cs={class:"text-right font-mono"},is={class:"text-right font-mono font-semibold"},_s={key:0},ds={colspan:"100%"},us={key:1,class:"alert alert-info"},ps={__name:"DivisionView",setup(h){const $=Z("navActions"),{loading:u,error:g,groupedData:l,fetchDivisionData:q,saveRatios:D,resetGroupOverrides:b,resetAllOverrides:d}=et(),_=z(),{adminStatus:a,superadminStatus:e}=Y(_),c=async(i,n)=>{try{await D(i,n)}catch(s){console.error("Error saving ratios:",s)}},p=async(i,n,s)=>{try{await b(i,n,s)}catch(m){console.error("Error resetting group overrides:",m)}},r={id:"reset-all-overrides",text:"Reset All Overrides",class:"btn btn-warning mr-2",handler:async()=>{try{await d()}catch(i){console.error("Error resetting overrides:",i)}},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>'},x={id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost",handler:()=>{window.history.back()},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'},A=()=>{if(!l.value?.length)return[];const i=[];return l.value.forEach(n=>{n.divisions&&n.divisions.length>0?n.divisions.forEach(s=>{i.push({salesperson_name:n.salesperson_name,salesperson_id:n.salesperson_id,customer_class:n.customer_class,group_key:n.group_key,brand:n.brand||"",has_custom_ratios:n.hasCustomRatios?"Yes":"No",item_division:s.item_division,division_name:s.division_name||"",division_ratio_2025:s.division_ratio_2025!=null?(s.division_ratio_2025*100).toFixed(2)+"%":"",effective_ratio:s.effective_ratio!=null?(s.effective_ratio*100).toFixed(2)+"%":"",is_custom:s.is_custom?"Yes":"No",total_2025_sales:k(s.total_2025_sales||0),q1_sales:k(s.q1_sales||0),q2_sales:k(s.q2_sales||0),q3_sales:k(s.q3_sales||0),q4_sales:k(s.q4_sales||0),gp_percent:s.gp_percent!=null?(s.gp_percent*100).toFixed(1)+"%":"",q1_gp_percent:s.q1_gp_percent!=null?(s.q1_gp_percent*100).toFixed(1)+"%":"",q2_gp_percent:s.q2_gp_percent!=null?(s.q2_gp_percent*100).toFixed(1)+"%":"",q3_gp_percent:s.q3_gp_percent!=null?(s.q3_gp_percent*100).toFixed(1)+"%":"",q4_gp_percent:s.q4_gp_percent!=null?(s.q4_gp_percent*100).toFixed(1)+"%":"",total_gp_value:k(s.total_gp_value||0),q1_gp_value:k(s.q1_gp_value||0),q2_gp_value:k(s.q2_gp_value||0),q3_gp_value:k(s.q3_gp_value||0),q4_gp_value:k(s.q4_gp_value||0),q1_allocated:k(s.q1_allocated||0),q2_allocated:k(s.q2_allocated||0),q3_allocated:k(s.q3_allocated||0),q4_allocated:k(s.q4_allocated||0),total_allocated:k(s.total_allocated||0)})}):i.push({salesperson_name:n.salesperson_name,salesperson_id:n.salesperson_id,customer_class:n.customer_class,group_key:n.group_key,brand:n.brand||"",has_custom_ratios:n.hasCustomRatios?"Yes":"No",item_division:"",division_name:"",division_ratio_2025:"",effective_ratio:"",is_custom:"",total_2025_sales:"",gp_percent:"",total_gp_value:"",q1_allocated:"",q2_allocated:"",q3_allocated:"",q4_allocated:"",total_allocated:""})}),i},R=()=>[{key:"salesperson_name",label:"Salesperson Name"},{key:"salesperson_id",label:"Salesperson ID"},{key:"customer_class",label:"Customer Class"},{key:"group_key",label:"Group Key"},{key:"brand",label:"Brand"},{key:"has_custom_ratios",label:"Has Custom Ratios"},{key:"item_division",label:"Item Division"},{key:"division_name",label:"Division Name"},{key:"division_ratio_2025",label:"2025 Division Ratio"},{key:"effective_ratio",label:"Effective Ratio"},{key:"is_custom",label:"Is Custom"},{key:"total_2025_sales",label:"Total 2025 Sales"},{key:"q1_sales",label:"Q1 Sales"},{key:"q2_sales",label:"Q2 Sales"},{key:"q3_sales",label:"Q3 Sales"},{key:"q4_sales",label:"Q4 Sales"},{key:"gp_percent",label:"GP%"},{key:"q1_gp_percent",label:"Q1 GP%"},{key:"q2_gp_percent",label:"Q2 GP%"},{key:"q3_gp_percent",label:"Q3 GP%"},{key:"q4_gp_percent",label:"Q4 GP%"},{key:"total_gp_value",label:"GP $"},{key:"q1_gp_value",label:"Q1 GP"},{key:"q2_gp_value",label:"Q2 GP"},{key:"q3_gp_value",label:"Q3 GP"},{key:"q4_gp_value",label:"Q4 GP"},{key:"q1_allocated",label:"Q1 Allocated"},{key:"q2_allocated",label:"Q2 Allocated"},{key:"q3_allocated",label:"Q3 Allocated"},{key:"q4_allocated",label:"Q4 Allocated"},{key:"total_allocated",label:"Total Allocated"}],G={id:"export-csv",text:"Export to CSV",class:"btn btn-primary mr-2",handler:()=>{const i=A();if(!i.length){alert("No data available to export");return}const n=R(),s=`division_ratios_${new Date().toISOString().split("T")[0]}.csv`;tt(i,n,s)},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>'},C=()=>{const i=[];(a.value||e.value)&&i.push(G),e.value&&i.push(r),(a.value||e.value)&&i.push(x),$.set(i)};I([a,e],()=>C(),{immediate:!0});const j=J({}),S=i=>`${i.salesperson_id}-${i.customer_class}-${i.group_key}`,E=i=>{const n=i.divisions.reduce((s,m)=>(s.totalRatio+=m.effective_ratio||0,s.totalSales+=m.total_2025_sales||0,s.q1Sales+=m.q1_sales||0,s.q2Sales+=m.q2_sales||0,s.q3Sales+=m.q3_sales||0,s.q4Sales+=m.q4_sales||0,s.q1+=m.q1_allocated||0,s.q2+=m.q2_allocated||0,s.q3+=m.q3_allocated||0,s.q4+=m.q4_allocated||0,s.grandTotal+=m.total_allocated||0,s.totalGp+=m.total_gp_value||0,s.q1Gp+=m.q1_gp_value||0,s.q2Gp+=m.q2_gp_value||0,s.q3Gp+=m.q3_gp_value||0,s.q4Gp+=m.q4_gp_value||0,s),{totalRatio:0,totalSales:0,q1Sales:0,q2Sales:0,q3Sales:0,q4Sales:0,q1:0,q2:0,q3:0,q4:0,grandTotal:0,totalGp:0,q1Gp:0,q2Gp:0,q3Gp:0,q4Gp:0});return n.gpPercent=n.totalSales>0?n.totalGp/n.totalSales:null,n.q1GpPercent=n.q1Sales>0?n.q1Gp/n.q1Sales:null,n.q2GpPercent=n.q2Sales>0?n.q2Gp/n.q2Sales:null,n.q3GpPercent=n.q3Sales>0?n.q3Gp/n.q3Sales:null,n.q4GpPercent=n.q4Sales>0?n.q4Gp/n.q4Sales:null,n},B=F(()=>!l.value||l.value.length===0?[]:l.value.map(i=>({key:S(i),group:i,summary:E(i),label:`${i.customer_class} > ${i.salesperson_name} > ${i.display_key}`}))),U=i=>{j[i]=!j[i]},y=i=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(i||0),N=i=>i==null||i===void 0?"-":`${(i*100).toFixed(1)}%`;return W(()=>{C(),q()}),X(()=>$.clear()),(i,n)=>(v(),f("div",Re,[O(K,{loading:P(u),error:P(g),onRetry:P(q)},null,8,["loading","error","onRetry"]),!P(u)&&!P(g)&&B.value.length>0?(v(),f("div",Ce,[t("div",Pe,[n[3]||(n[3]=t("div",{class:"stat"},[t("div",{class:"stat-title"},"Module"),t("div",{class:"stat-value text-primary"}," Division Ratio Management ")],-1)),t("div",De,[n[0]||(n[0]=t("div",{class:"stat-title"},"Total Groups",-1)),t("div",Ae,o(P(l).length),1)]),t("div",Ee,[n[1]||(n[1]=t("div",{class:"stat-title"},"Groups with Custom Ratios",-1)),t("div",Fe,o(P(l).filter(s=>s.hasCustomRatios).length),1)]),t("div",Te,[n[2]||(n[2]=t("div",{class:"stat-title"},"Total Divisions",-1)),t("div",je,o(P(l).reduce((s,m)=>s+m.divisions.length,0)),1)])]),t("div",Ne,[t("table",Be,[n[4]||(n[4]=t("thead",null,[t("tr",null,[t("th",{class:"w-20"},"Action"),t("th",null,"Group"),t("th",{class:"text-right"},"Total Ratio"),t("th",{class:"text-right"},"Total Sales"),t("th",{class:"text-right"},"Q1 Sales"),t("th",{class:"text-right"},"Q2 Sales"),t("th",{class:"text-right"},"Q3 Sales"),t("th",{class:"text-right"},"Q4 Sales"),t("th",{class:"text-right"},"GP%"),t("th",{class:"text-right"},"Q1 GP%"),t("th",{class:"text-right"},"Q2 GP%"),t("th",{class:"text-right"},"Q3 GP%"),t("th",{class:"text-right"},"Q4 GP%"),t("th",{class:"text-right"},"GP $"),t("th",{class:"text-right"},"Q1 GP"),t("th",{class:"text-right"},"Q2 GP"),t("th",{class:"text-right"},"Q3 GP"),t("th",{class:"text-right"},"Q4 GP"),t("th",{class:"text-right"},"Q1 Budget"),t("th",{class:"text-right"},"Q2 Budget"),t("th",{class:"text-right"},"Q3 Budget"),t("th",{class:"text-right"},"Q4 Budget"),t("th",{class:"text-right"},"Grand Total")])],-1)),t("tbody",null,[(v(!0),f(L,null,H(B.value,s=>(v(),f(L,{key:s.key},[t("tr",null,[t("td",null,[t("button",{class:"btn btn-outline btn-xs",type:"button",onClick:m=>U(s.key)},o(j[s.key]?"Collapse":"Expand"),9,Ve)]),t("td",null,[t("div",Me,o(s.group.display_key),1),t("div",Oe,o(s.group.customer_class)+" • "+o(s.group.salesperson_name),1)]),t("td",Le,o(N(s.summary.totalRatio)),1),t("td",Ue,o(y(s.summary.totalSales)),1),t("td",ze,o(y(s.summary.q1Sales)),1),t("td",He,o(y(s.summary.q2Sales)),1),t("td",Ie,o(y(s.summary.q3Sales)),1),t("td",Ye,o(y(s.summary.q4Sales)),1),t("td",Je,o(N(s.summary.gpPercent)),1),t("td",We,o(N(s.summary.q1GpPercent)),1),t("td",Xe,o(N(s.summary.q2GpPercent)),1),t("td",Ze,o(N(s.summary.q3GpPercent)),1),t("td",Ke,o(N(s.summary.q4GpPercent)),1),t("td",ts,o(y(s.summary.totalGp)),1),t("td",es,o(y(s.summary.q1Gp)),1),t("td",ss,o(y(s.summary.q2Gp)),1),t("td",as,o(y(s.summary.q3Gp)),1),t("td",os,o(y(s.summary.q4Gp)),1),t("td",ls,o(y(s.summary.q1)),1),t("td",ns,o(y(s.summary.q2)),1),t("td",rs,o(y(s.summary.q3)),1),t("td",cs,o(y(s.summary.q4)),1),t("td",is,o(y(s.summary.grandTotal)),1)]),j[s.key]?(v(),f("tr",_s,[t("td",ds,[O(we,{group:s.group,onSaveRatios:c,onResetGroup:p,onCollapse:m=>U(s.key)},null,8,["group","onCollapse"])])])):T("",!0)],64))),128))])])])])):T("",!0),!P(u)&&!P(g)&&P(l).length===0?(v(),f("div",us,[...n[5]||(n[5]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",class:"stroke-current shrink-0 w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),t("span",null,"No division data available. Please check your data sources.",-1)])])):T("",!0)]))}};export{ps as default};
