import{u as q,r as P,c as C,w as V,b as g,g as h,f as e,t as u,s as I,h as S,k as B,F as A,j as M,d as D,A as O,o as T,a as H,i as Q,e as b}from"./index-BjrN0zwX.js";import{_ as L}from"./LoadingError-CdIYZCPO.js";function z(){const k=q(),x=P(!1),n=P([]),m=C(()=>{const t={};for(const s of n.value){const p=`${s.salesperson_id}-${s.customer_class}-${s.group_key}`;t[p]||(t[p]={salesperson_id:s.salesperson_id,salesperson_name:s.salesperson_name,customer_class:s.customer_class,group_key:s.group_key,brand:s.brand,display_key:s.customer_class==="Hospitality"&&s.brand?`${s.group_key} (${s.brand})`:s.group_key,effective_gp_percent:s.effective_gp_percent,is_custom:s.is_custom,quarters:[{label:"Q1",sales_2025:s.q1_sales_2025,sales:s.quarter_1_sales,gp_percent:s.q1_gp_percent,gp_value:s.q1_gp_value},{label:"Q2",sales_2025:s.q2_sales_2025,sales:s.quarter_2_sales,gp_percent:s.q2_gp_percent,gp_value:s.q2_gp_value},{label:"Q3",sales_2025:s.q3_sales_2025,sales:s.quarter_3_sales,gp_percent:s.q3_gp_percent,gp_value:s.q3_gp_value},{label:"Q4",sales_2025:s.q4_sales_2025,sales:s.quarter_4_sales,gp_percent:s.q4_gp_percent,gp_value:s.q4_gp_value}]})}return Object.values(t)});async function o(){x.value=!0;const s=await(await k.apiCall("/api/gross-profit")).json();n.value=s.data||[],x.value=!1}async function y(t,s,p){const r=await k.apiCall(`/api/gross-profit/${t}/${encodeURIComponent(s)}/${encodeURIComponent(p)}`);if(!r.ok)throw new Error("Failed to fetch group");return(await r.json()).data||[]}async function d(t){const s=Math.min(Math.max(t.effective_gp_percent,0),1),p=[{salesperson_id:t.salesperson_id,salesperson_name:t.salesperson_name,customer_class:t.customer_class,group_key:t.group_key,custom_gp_percent:s}];await k.apiCall("/api/gross-profit/save-overrides",{method:"POST",body:JSON.stringify({overrides:p})});const r=await y(t.salesperson_id,t.customer_class,t.group_key),a=[...n.value];if(a.filter(c=>c.group_key===t.group_key&&c.salesperson_id===t.salesperson_id).length>0){const c=a.findIndex(R=>R.group_key===t.group_key&&R.salesperson_id===t.salesperson_id),$=a.filter(R=>!(R.group_key===t.group_key&&R.salesperson_id===t.salesperson_id));$.splice(c,0,...r),n.value=$}else n.value=[...n.value.filter(c=>!(c.group_key===t.group_key&&c.salesperson_id===t.salesperson_id)),...r]}async function v(t){await k.apiCall(`/api/gross-profit/reset/${t.salesperson_id}/${encodeURIComponent(t.customer_class)}/${encodeURIComponent(t.group_key)}`,{method:"DELETE"});const s=await y(t.salesperson_id,t.customer_class,t.group_key),p=[...n.value];if(p.filter(a=>a.group_key===t.group_key&&a.salesperson_id===t.salesperson_id).length>0){const a=p.findIndex(c=>c.group_key===t.group_key&&c.salesperson_id===t.salesperson_id),_=p.filter(c=>!(c.group_key===t.group_key&&c.salesperson_id===t.salesperson_id));_.splice(a,0,...s),n.value=_}else n.value=[...n.value.filter(a=>!(a.group_key===t.group_key&&a.salesperson_id===t.salesperson_id)),...s]}async function w(){await k.apiCall("/api/gross-profit/reset-all",{method:"DELETE"});const t=m.value.filter(a=>a.is_custom),s=t.map(a=>y(a.salesperson_id,a.customer_class,a.group_key)),p=await Promise.all(s);let r=[...n.value];t.forEach((a,_)=>{const c=p[_];r=r.filter($=>!($.group_key===a.group_key&&$.salesperson_id===a.salesperson_id)),r.push(...c)}),n.value=r}return{grouped:m,fetch:o,save:d,reset:v,resetAll:w,loading:x}}const J={class:"flex items-center space-x-3 w-full"},K=["value"],W={class:"badge badge-sm badge-primary"},X={__name:"GrossProfitSlider",props:{modelValue:Number},emits:["update:modelValue"],setup(k,{emit:x}){const n=k,m=x,o=P((n.modelValue||0)*100),y=C(()=>{const d=o.value;return typeof d!="number"||isNaN(d)?"0.0":d.toFixed(1)});return V(o,d=>{if(typeof d=="number"&&!isNaN(d)){const v=d/100;m("update:modelValue",v)}}),V(()=>n.modelValue,d=>{typeof d=="number"&&!isNaN(d)?o.value=d*100:o.value=0}),(d,v)=>(h(),g("div",J,[e("input",{type:"range",min:"0",max:"100",step:"0.1",value:typeof o.value=="number"&&!isNaN(o.value)?o.value:0,onInput:v[0]||(v[0]=w=>o.value=parseFloat(w.target.value)||0),class:"range range-sm range-primary flex-grow"},null,40,K),e("span",W,u(y.value)+"% ",1)]))}},Y={class:"card bg-base-100 shadow-xl border border-base-300 transition-all duration-200 hover:shadow-2xl"},Z={class:"card-body"},ee={class:"flex items-center justify-between mb-4"},se={class:"card-title text-lg"},te={class:"flex items-center gap-2"},ae=["disabled"],ne=["disabled"],oe={key:0,class:"loading loading-spinner loading-xs"},le={class:"overflow-x-auto"},re={class:"table w-full text-sm"},ie={class:"font-medium"},ce={class:"font-mono"},ue={class:"flex justify-between items-center mt-4"},de={class:"w-full max-w-sm"},_e={class:"flex items-center space-x-2"},pe={class:"text-sm opacity-70"},me={key:0,class:"badge badge-sm badge-primary ml-2"},fe={__name:"GrossProfitGroupCard",props:{group:Object,onSave:Function,onReset:Function},emits:["collapse"],setup(k,{emit:x}){const n=k,m=P(!1),o=I({...n.group}),y=P(n.group.effective_gp_percent);V(()=>n.group,r=>{Object.assign(o,r),m.value||(y.value=r.effective_gp_percent)},{deep:!0});const d=C(()=>{const r=o.effective_gp_percent,a=y.value;return Math.abs(r-a)>.001}),v=C(()=>o.is_custom||d.value);async function w(){m.value=!0;try{await n.onSave(o),y.value=o.effective_gp_percent}finally{m.value=!1}}async function t(){m.value=!0;try{await n.onReset(o),y.value=o.effective_gp_percent}finally{m.value=!1}}function s(r){return r==null?"-":(r*100).toFixed(1)+"%"}function p(r){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(r||0)}return(r,a)=>(h(),g("div",Y,[e("div",Z,[e("div",ee,[e("h3",se,u(o.customer_class)+" › "+u(o.salesperson_name)+" › "+u(o.display_key),1),e("div",te,[e("button",{class:"btn btn-sm btn-ghost",disabled:m.value||!v.value,onClick:t}," Reset ",8,ae),e("button",{class:"btn btn-sm btn-primary",disabled:m.value||!d.value,onClick:w},[m.value?(h(),g("span",oe)):S("",!0),a[1]||(a[1]=B(" Save Changes ",-1))],8,ne)])]),e("div",le,[e("table",re,[a[2]||(a[2]=e("thead",null,[e("tr",null,[e("th",null,"Quarter"),e("th",null,"2025 Sales"),e("th",null,"2026 Budget"),e("th",null,"Historical GP%"),e("th",null,"GP $ (Est.)")])],-1)),e("tbody",null,[(h(!0),g(A,null,M(o.quarters,_=>(h(),g("tr",{key:_.label},[e("td",ie,u(_.label),1),e("td",null,u(p(_.sales_2025)),1),e("td",null,u(p(_.sales)),1),e("td",null,u(s(_.gp_percent)),1),e("td",ce,u(p(_.gp_value)),1)]))),128))])])]),e("div",ue,[e("div",de,[a[3]||(a[3]=e("label",{class:"text-sm font-medium mb-2 block"}," Effective GP% ",-1)),e("div",_e,[D(X,{modelValue:o.effective_gp_percent,"onUpdate:modelValue":a[0]||(a[0]=_=>o.effective_gp_percent=_)},null,8,["modelValue"]),e("div",pe,[o.is_custom?(h(),g("span",me,"Custom")):S("",!0)])])])])])]))}},ve={class:"p-6 space-y-6"},ge={key:0,class:"stats shadow mb-6"},he={class:"stat"},ye={class:"stat-value text-primary"},be={class:"stat"},ke={class:"stat-value text-secondary"},xe={class:"stat"},we={class:"stat-value text-accent"},$e={key:1},Re={class:"overflow-x-auto"},Ce={class:"table table-zebra w-full"},Ge=["onClick"],Se={class:"font-semibold"},Pe={class:"text-xs opacity-70"},Ve={class:"text-right font-mono"},Ne={class:"text-right font-mono"},Ae={class:"text-right font-mono"},De={class:"text-right font-mono font-semibold"},Fe={key:0},Ee={colspan:"100%"},je={key:2,class:"alert alert-info"},Me={__name:"GrossProfitView",setup(k){const x=Q("navActions"),{grouped:n,fetch:m,save:o,reset:y,resetAll:d,loading:v}=z(),w=q(),{adminStatus:t,superadminStatus:s}=O(w),r={id:"reset-all-overrides",text:"Reset All Overrides",class:"btn btn-warning mr-2",handler:async()=>{try{await d()}catch(l){console.error("Error resetting all overrides:",l)}},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>'},a={id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost",handler:()=>{window.history.back()},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'},_=()=>{const l=[];s.value&&l.push(r),(t.value||s.value)&&l.push(a),x.set(l)};V([t,s],()=>_(),{immediate:!0});const c=I({}),$=l=>`${l.salesperson_id}-${l.customer_class}-${l.group_key}`,R=l=>({...l.quarters.reduce((i,G)=>(i.sales2025+=G.sales_2025||0,i.budget2026+=G.sales||0,i.gpValue+=G.gp_value||0,i),{sales2025:0,budget2026:0,gpValue:0}),effectiveGp:l.effective_gp_percent||0}),F=C(()=>n.value?.length?n.value.map(l=>({key:$(l),group:l,summary:R(l)})):[]),U=C(()=>n.value?.length?n.value.reduce((f,i)=>f+(i.effective_gp_percent||0),0)/n.value.length:0),E=l=>{c[l]=!c[l]},N=l=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(l||0),j=l=>`${((l||0)*100).toFixed(1)}%`;return T(()=>{_(),m()}),H(()=>x.clear()),(l,f)=>(h(),g("div",ve,[D(L,{loading:b(v),error:null,onRetry:b(m)},null,8,["loading","onRetry"]),!b(v)&&b(n).length>0?(h(),g("div",ge,[f[3]||(f[3]=e("div",{class:"stat"},[e("div",{class:"stat-title"},"Module"),e("div",{class:"stat-value text-primary"}," Gross Profit Management ")],-1)),e("div",he,[f[0]||(f[0]=e("div",{class:"stat-title"},"Total Groups",-1)),e("div",ye,u(b(n).length),1)]),e("div",be,[f[1]||(f[1]=e("div",{class:"stat-title"},"Groups with Custom GP%",-1)),e("div",ke,u(b(n).filter(i=>i.is_custom).length),1)]),e("div",xe,[f[2]||(f[2]=e("div",{class:"stat-title"},"Average GP%",-1)),e("div",we,u(j(U.value)),1)])])):S("",!0),!b(v)&&F.value.length>0?(h(),g("div",$e,[e("div",Re,[e("table",Ce,[f[4]||(f[4]=e("thead",null,[e("tr",null,[e("th",{class:"w-20"},"Action"),e("th",null,"Group"),e("th",{class:"text-right"},"2025 Sales"),e("th",{class:"text-right"},"2026 Budget"),e("th",{class:"text-right"},"Historical GP%"),e("th",{class:"text-right"},"GP $ Est.")])],-1)),e("tbody",null,[(h(!0),g(A,null,M(F.value,i=>(h(),g(A,{key:i.key},[e("tr",null,[e("td",null,[e("button",{class:"btn btn-outline btn-xs",type:"button",onClick:G=>E(i.key)},u(c[i.key]?"Collapse":"Expand"),9,Ge)]),e("td",null,[e("div",Se,u(i.group.display_key),1),e("div",Pe,u(i.group.customer_class)+" - "+u(i.group.salesperson_name),1)]),e("td",Ve,u(N(i.summary.sales2025)),1),e("td",Ne,u(N(i.summary.budget2026)),1),e("td",Ae,u(j(i.summary.effectiveGp)),1),e("td",De,u(N(i.summary.gpValue)),1)]),c[i.key]?(h(),g("tr",Fe,[e("td",Ee,[D(fe,{group:i.group,onSave:b(o),onReset:b(y),onCollapse:G=>E(i.key)},null,8,["group","onSave","onReset","onCollapse"])])])):S("",!0)],64))),128))])])])])):!b(v)&&b(n).length===0?(h(),g("div",je,[...f[5]||(f[5]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",class:"stroke-current shrink-0 w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),e("span",null,"No gross profit data available. Please check your data sources.",-1)])])):S("",!0)]))}};export{Me as default};
