import{u as L,r as B,c as Q,b as f,g as k,f as t,p as O,t as r,F as G,j as M,h as T,d as N,w as U,A as z,s as V,o as H,a as P,i as I,e as S}from"./index-CAe1qyEd.js";import{_ as J}from"./LoadingError-DNBpVobg.js";function W(){const g=L(),R=B(!1),u=B(null),h=B([]),a=Q(()=>{if(!h.value.length)return[];const s={};return h.value.forEach(e=>{const o=`${e.salesperson_id}-${e.customer_class}-${e.group_key}`;s[o]||(s[o]={salesperson_id:e.salesperson_id,salesperson_name:e.salesperson_name,customer_class:e.customer_class,group_key:e.group_key,brand:e.brand,display_key:e.customer_class==="Hospitality"&&e.brand?`${e.group_key} (${e.brand})`:e.group_key,divisions:[],totalRatio:0,hasCustomRatios:!1});const v={item_division:e.item_division,division_name:e.division_name,effective_ratio:e.effective_ratio,is_custom:e.is_custom,q1_allocated:e.q1_allocated,q2_allocated:e.q2_allocated,q3_allocated:e.q3_allocated,q4_allocated:e.q4_allocated,total_allocated:e.total_allocated,division_ratio_2025:e.division_ratio_2025,total_2025_sales:e.total_2025_sales,locked:!1};s[o].divisions.push(v),s[o].totalRatio+=v.effective_ratio,v.is_custom&&(s[o].hasCustomRatios=!0)}),Object.values(s).forEach(e=>{e.divisions.sort((o,v)=>o.item_division-v.item_division)}),Object.values(s)}),D=async()=>{R.value=!0,u.value=null;try{const s=await g.apiCall("/api/division/allocations");if(s.ok){const e=await s.json();h.value=e.data||[]}else{const e=await s.json();console.error("Error fetching division data:",e),u.value=e.detail||"Failed to fetch division data"}}catch(s){console.error("Exception fetching division data:",s),u.value="Network error occurred"}finally{R.value=!1}},A=async(s,e,o)=>{const v=await g.apiCall(`/api/division/allocations/${s}/${encodeURIComponent(e)}/${encodeURIComponent(o)}`);if(!v.ok)throw new Error("Failed to fetch group");return(await v.json()).data||[]},p=async(s,e)=>{try{const o=a.value.find(d=>d.group_key===s);if(!o)throw new Error("Group not found");const v=e.filter(d=>d.is_custom||d.effective_ratio!==d.division_ratio_2025).map(d=>({salesperson_id:o.salesperson_id,salesperson_name:o.salesperson_name,customer_class:o.customer_class,group_key:o.group_key,item_division:d.item_division,custom_ratio:d.effective_ratio}));if(v.length===0)return console.log("No changes to save"),{success:!0,message:"No changes to save"};const l=await g.apiCall("/api/division/save-ratios",{method:"POST",body:JSON.stringify({overrides:v})});if(l.ok){const d=await l.json(),q=await A(o.salesperson_id,o.customer_class,o.group_key),E=[...h.value];if(E.filter(x=>x.group_key===o.group_key&&x.salesperson_id===o.salesperson_id).length>0){const x=E.findIndex(C=>C.group_key===o.group_key&&C.salesperson_id===o.salesperson_id),$=E.filter(C=>!(C.group_key===o.group_key&&C.salesperson_id===o.salesperson_id));$.splice(x,0,...q),h.value=$}else h.value=[...h.value.filter(x=>!(x.group_key===o.group_key&&x.salesperson_id===o.salesperson_id)),...q];return d}else{const d=await l.json();throw console.error("Error saving ratios:",d),new Error(d.detail||"Failed to save ratios")}}catch(o){throw console.error("Exception saving ratios:",o),o}},i=async(s,e,o)=>{try{const v=await g.apiCall(`/api/division/reset-group/${s}/${encodeURIComponent(e)}/${encodeURIComponent(o)}`,{method:"DELETE"});if(v.ok){const l=await v.json(),d=await A(s,e,o),q=[...h.value];if(q.filter(y=>y.group_key===o&&y.salesperson_id===s).length>0){const y=q.findIndex($=>$.group_key===o&&$.salesperson_id===s),x=q.filter($=>!($.group_key===o&&$.salesperson_id===s));x.splice(y,0,...d),h.value=x}else h.value=[...h.value.filter(y=>!(y.group_key===o&&y.salesperson_id===s)),...d];return l}else{const l=await v.json();throw new Error(l.detail||"Failed to reset group overrides")}}catch(v){throw console.error("Exception resetting group overrides:",v),v}};return{loading:R,error:u,divisionData:h,groupedData:a,fetchDivisionData:D,saveRatios:p,resetGroupOverrides:i,resetAllOverrides:async()=>{try{const s=a.value.filter(e=>e.hasCustomRatios).map(e=>i(e.salesperson_id,e.customer_class,e.group_key));return s.length===0?{success:!0,message:"No overrides to reset"}:(await Promise.all(s),{success:!0,message:`Reset overrides for ${s.length} groups`})}catch(s){throw console.error("Exception resetting all overrides:",s),s}}}}const X={class:"flex items-center gap-2"},Y=["disabled","title"],Z={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},K={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},tt={class:"flex-1"},et=["value","disabled"],st={class:"text-sm font-mono min-w-[4rem] text-right"},ot={__name:"DivisionSlider",props:{ratio:{type:Number,required:!0},locked:{type:Boolean,default:!1},divisionName:{type:String,required:!0},disabled:{type:Boolean,default:!1}},emits:["ratio-change","lock-toggle"],setup(g,{emit:R}){const u=g,h=R,a=Q(()=>(u.ratio*100).toFixed(1)),D=p=>{if(!u.locked&&!u.disabled){const i=parseFloat(p.target.value);h("ratio-change",i)}},A=()=>{u.disabled||h("lock-toggle")};return(p,i)=>(k(),f("div",X,[t("button",{onClick:A,disabled:g.disabled,class:O(["btn btn-sm btn-ghost",g.locked?"btn-primary":"btn-outline",g.disabled?"btn-disabled":""]),title:g.locked?"Unlock to edit":"Lock to prevent changes"},[g.locked?(k(),f("svg",Z,[...i[0]||(i[0]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"},null,-1)])])):(k(),f("svg",K,[...i[1]||(i[1]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"},null,-1)])]))],10,Y),t("div",tt,[t("input",{type:"range",min:0,max:1,step:.001,value:g.ratio,disabled:g.locked||g.disabled,onInput:D,class:O(["range range-primary range-sm w-full",{"opacity-50":g.locked||g.disabled}])},null,42,et)]),t("div",st,[t("span",{class:O(["badge badge-sm",g.locked?"badge-primary":"badge-outline"])},r(a.value)+"% ",3)])]))}},at={class:"overflow-x-auto"},lt={class:"table table-zebra w-full"},nt={class:"text-sm opacity-60"},rt={class:"flex flex-col"},it={class:"font-medium"},ct={key:0,class:"text-xs badge badge-primary badge-sm"},dt={class:"text-right font-mono text-sm"},ut={class:"text-right font-mono text-sm"},_t={class:"text-right font-mono text-sm"},ht={class:"text-right font-mono text-sm"},gt={class:"text-right font-mono text-sm"},vt={class:"text-right font-mono font-semibold"},mt={class:"bg-base-200 font-bold"},pt={class:"text-right"},ft={class:"text-lg"},kt={class:"text-right"},yt={class:"text-lg"},xt={class:"text-right"},bt={class:"text-lg"},wt={class:"text-right"},$t={class:"text-lg"},Rt={class:"text-right"},qt={class:"text-lg"},Ct={class:"text-right"},St={class:"text-lg"},Dt={class:"text-right"},At={class:"text-lg"},Et={__name:"DivisionTable",props:{divisions:{type:Array,required:!0},readonly:{type:Boolean,default:!1}},emits:["ratio-change","lock-toggle"],setup(g,{emit:R}){const u=g,h=R,a=i=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(i),D=(i,m)=>{h("ratio-change",i,m)},A=i=>{h("lock-toggle",i)},p=Q(()=>!u.divisions||u.divisions.length===0?{totalRatio:0,totalActualSales:0,totalQ1:0,totalQ2:0,totalQ3:0,totalQ4:0,totalAllocated:0}:u.divisions.reduce((i,m)=>(i.totalRatio+=m.effective_ratio||0,i.totalActualSales+=m.total_2025_sales||0,i.totalQ1+=m.q1_allocated||0,i.totalQ2+=m.q2_allocated||0,i.totalQ3+=m.q3_allocated||0,i.totalQ4+=m.q4_allocated||0,i.totalAllocated+=m.total_allocated||0,i),{totalRatio:0,totalActualSales:0,totalQ1:0,totalQ2:0,totalQ3:0,totalQ4:0,totalAllocated:0}));return(i,m)=>(k(),f("div",at,[t("table",lt,[m[1]||(m[1]=t("thead",null,[t("tr",null,[t("th",{class:"w-8"},"#"),t("th",null,"Division"),t("th",{class:"w-80"},"Effective Ratio"),t("th",{class:"text-right"},"2025 Sales"),t("th",{class:"text-right"},"Q1"),t("th",{class:"text-right"},"Q2"),t("th",{class:"text-right"},"Q3"),t("th",{class:"text-right"},"Q4"),t("th",{class:"text-right"},"Total")])],-1)),t("tbody",null,[(k(!0),f(G,null,M(g.divisions,(s,e)=>(k(),f("tr",{key:s.item_division},[t("td",nt,r(s.item_division),1),t("td",null,[t("div",rt,[t("span",it,r(s.division_name),1),s.is_custom?(k(),f("span",ct," Custom ")):T("",!0)])]),t("td",null,[N(ot,{ratio:s.effective_ratio,locked:s.locked,"division-name":s.division_name,disabled:g.readonly,onRatioChange:o=>D(e,o),onLockToggle:()=>A(e)},null,8,["ratio","locked","division-name","disabled","onRatioChange","onLockToggle"])]),t("td",dt,r(a(s.total_2025_sales)),1),t("td",ut,r(a(s.q1_allocated)),1),t("td",_t,r(a(s.q2_allocated)),1),t("td",ht,r(a(s.q3_allocated)),1),t("td",gt,r(a(s.q4_allocated)),1),t("td",vt,r(a(s.total_allocated)),1)]))),128))]),t("tfoot",null,[t("tr",mt,[m[0]||(m[0]=t("td",{colspan:"2",class:"text-right"},[t("span",{class:"text-lg"},"Total")],-1)),t("td",pt,[t("span",ft,r((p.value.totalRatio*100).toFixed(2))+"%",1)]),t("td",kt,[t("span",yt,r(a(p.value.totalActualSales)),1)]),t("td",xt,[t("span",bt,r(a(p.value.totalQ1)),1)]),t("td",wt,[t("span",$t,r(a(p.value.totalQ2)),1)]),t("td",Rt,[t("span",qt,r(a(p.value.totalQ3)),1)]),t("td",Ct,[t("span",St,r(a(p.value.totalQ4)),1)]),t("td",Dt,[t("span",At,r(a(p.value.totalAllocated)),1)])])])])]))}},Qt={class:"card bg-base-100 shadow-xl border border-base-300"},jt={class:"card-body"},Tt={class:"flex items-center justify-between mb-4"},Ft={class:"card-title text-lg"},Bt={class:"flex items-center gap-2"},Nt=["disabled"],Ot=["disabled"],Gt={key:0,class:"alert alert-warning mt-2"},Lt={key:0},Mt={key:1},Ut={__name:"DivisionGroupCard",props:{group:{type:Object,required:!0}},emits:["save-ratios","reset-group","collapse"],setup(g,{emit:R}){const u=g,h=R,a=B([]);U(()=>u.group,l=>{l&&l.divisions&&(a.value=l.divisions.map(d=>({...d})))},{immediate:!0});const D=Q(()=>a.value.reduce((l,d)=>l+d.effective_ratio,0)),A=Q(()=>`${u.group.customer_class} > ${u.group.salesperson_name} > ${u.group.display_key}`),p=Q(()=>{const l=D.value;return Math.abs(l-1)<.001?{status:"perfect",icon:"✅",class:"text-success"}:l>1?{status:"over",icon:"⚠️",class:"text-warning"}:{status:"under",icon:"⚠️",class:"text-warning"}}),i=Q(()=>a.value.some(l=>l.effective_ratio!==l.division_ratio_2025||l.is_custom)),m=(l,d)=>{const q=a.value.map((b,w)=>({...b,index:w})).filter(b=>!b.locked);if(q.length<=1){a.value[l].effective_ratio=1;return}const y=1-a.value.filter(b=>b.locked).reduce((b,w)=>b+w.effective_ratio,0),x=Math.min(d,y);a.value[l].effective_ratio=x;const $=q.filter(b=>b.index!==l),C=$.reduce((b,w)=>b+w.effective_ratio,0);if(C>0){const w=(y-x)/C;$.forEach(F=>{a.value[F.index].effective_ratio=F.effective_ratio*w})}},s=(l,d)=>{m(l,d)},e=l=>{a.value[l].locked=!a.value[l].locked},o=async()=>{try{await h("save-ratios",u.group.group_key,a.value)}catch(l){console.error("Error saving ratios:",l)}},v=async()=>{try{await h("reset-group",u.group.salesperson_id,u.group.customer_class,u.group.group_key)}catch(l){console.error("Error resetting group:",l)}};return(l,d)=>(k(),f("div",Qt,[t("div",jt,[t("div",Tt,[t("h3",Ft,r(A.value),1),t("div",Bt,[t("button",{onClick:v,class:"btn btn-ghost btn-sm",disabled:!i.value}," Reset ",8,Nt),t("button",{onClick:o,class:"btn btn-primary btn-sm",disabled:!i.value||p.value.status!=="perfect"}," Save Changes ",8,Ot)])]),N(Et,{divisions:a.value,readonly:!1,onRatioChange:s,onLockToggle:e},null,8,["divisions"]),p.value.status!=="perfect"?(k(),f("div",Gt,[d[0]||(d[0]=t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})],-1)),t("span",null,[p.value.status==="over"?(k(),f("span",Lt," Total ratio exceeds 100%. Adjust sliders to balance the ratios. ")):(k(),f("span",Mt," Total ratio is under 100%. Adjust sliders to reach 100%. "))])])):T("",!0)])]))}},zt={class:"p-6 space-y-6"},Vt={key:0,class:"space-y-6"},Ht={class:"stats shadow mb-6"},Pt={class:"stat"},It={class:"stat-value text-primary"},Jt={class:"stat"},Wt={class:"stat-value text-secondary"},Xt={class:"stat"},Yt={class:"stat-value text-accent"},Zt={class:"overflow-x-auto"},Kt={class:"table table-zebra w-full"},te=["onClick"],ee={class:"font-semibold"},se={class:"text-xs opacity-70"},oe={class:"text-right font-mono"},ae={class:"text-right font-mono"},le={class:"text-right font-mono"},ne={class:"text-right font-mono"},re={class:"text-right font-mono"},ie={class:"text-right font-mono"},ce={class:"text-right font-mono font-semibold"},de={key:0},ue={colspan:"100%"},_e={key:1,class:"alert alert-info"},ve={__name:"DivisionView",setup(g){const R=I("navActions"),{loading:u,error:h,groupedData:a,fetchDivisionData:D,saveRatios:A,resetGroupOverrides:p,resetAllOverrides:i}=W(),m=L(),{adminStatus:s,superadminStatus:e}=z(m),o=async(c,_)=>{try{await A(c,_)}catch(n){console.error("Error saving ratios:",n)}},v=async(c,_,n)=>{try{await p(c,_,n)}catch(j){console.error("Error resetting group overrides:",j)}},d={id:"reset-all-overrides",text:"Reset All Overrides",class:"btn btn-warning mr-2",handler:async()=>{try{await i()}catch(c){console.error("Error resetting overrides:",c)}},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>'},q={id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost",handler:()=>{window.history.back()},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'},E=()=>{const c=[];e.value&&c.push(d),(s.value||e.value)&&c.push(q),R.set(c)};U([s,e],()=>E(),{immediate:!0});const y=V({}),x=c=>`${c.salesperson_id}-${c.customer_class}-${c.group_key}`,$=c=>c.divisions.reduce((_,n)=>(_.totalRatio+=n.effective_ratio||0,_.totalSales+=n.total_2025_sales||0,_.q1+=n.q1_allocated||0,_.q2+=n.q2_allocated||0,_.q3+=n.q3_allocated||0,_.q4+=n.q4_allocated||0,_.grandTotal+=n.total_allocated||0,_),{totalRatio:0,totalSales:0,q1:0,q2:0,q3:0,q4:0,grandTotal:0}),C=Q(()=>!a.value||a.value.length===0?[]:a.value.map(c=>({key:x(c),group:c,summary:$(c),label:`${c.customer_class} > ${c.salesperson_name} > ${c.display_key}`}))),b=c=>{y[c]=!y[c]},w=c=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(c||0),F=c=>`${((c||0)*100).toFixed(1)}%`;return H(()=>{E(),D()}),P(()=>R.clear()),(c,_)=>(k(),f("div",zt,[N(J,{loading:S(u),error:S(h),onRetry:S(D)},null,8,["loading","error","onRetry"]),!S(u)&&!S(h)&&C.value.length>0?(k(),f("div",Vt,[t("div",Ht,[_[3]||(_[3]=t("div",{class:"stat"},[t("div",{class:"stat-title"},"Module"),t("div",{class:"stat-value text-primary"}," Division Ratio Management ")],-1)),t("div",Pt,[_[0]||(_[0]=t("div",{class:"stat-title"},"Total Groups",-1)),t("div",It,r(S(a).length),1)]),t("div",Jt,[_[1]||(_[1]=t("div",{class:"stat-title"},"Groups with Custom Ratios",-1)),t("div",Wt,r(S(a).filter(n=>n.hasCustomRatios).length),1)]),t("div",Xt,[_[2]||(_[2]=t("div",{class:"stat-title"},"Total Divisions",-1)),t("div",Yt,r(S(a).reduce((n,j)=>n+j.divisions.length,0)),1)])]),t("div",Zt,[t("table",Kt,[_[4]||(_[4]=t("thead",null,[t("tr",null,[t("th",{class:"w-20"},"Action"),t("th",null,"Group"),t("th",{class:"text-right"},"Total Ratio"),t("th",{class:"text-right"},"Total Sales"),t("th",{class:"text-right"},"Q1 Budget"),t("th",{class:"text-right"},"Q2 Budget"),t("th",{class:"text-right"},"Q3 Budget"),t("th",{class:"text-right"},"Q4 Budget"),t("th",{class:"text-right"},"Grand Total")])],-1)),t("tbody",null,[(k(!0),f(G,null,M(C.value,n=>(k(),f(G,{key:n.key},[t("tr",null,[t("td",null,[t("button",{class:"btn btn-outline btn-xs",type:"button",onClick:j=>b(n.key)},r(y[n.key]?"Collapse":"Expand"),9,te)]),t("td",null,[t("div",ee,r(n.group.display_key),1),t("div",se,r(n.group.customer_class)+" • "+r(n.group.salesperson_name),1)]),t("td",oe,r(F(n.summary.totalRatio)),1),t("td",ae,r(w(n.summary.totalSales)),1),t("td",le,r(w(n.summary.q1)),1),t("td",ne,r(w(n.summary.q2)),1),t("td",re,r(w(n.summary.q3)),1),t("td",ie,r(w(n.summary.q4)),1),t("td",ce,r(w(n.summary.grandTotal)),1)]),y[n.key]?(k(),f("tr",de,[t("td",ue,[N(Ut,{group:n.group,onSaveRatios:o,onResetGroup:v,onCollapse:j=>b(n.key)},null,8,["group","onCollapse"])])])):T("",!0)],64))),128))])])])])):T("",!0),!S(u)&&!S(h)&&S(a).length===0?(k(),f("div",_e,[..._[5]||(_[5]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",class:"stroke-current shrink-0 w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),t("span",null,"No division data available. Please check your data sources.",-1)])])):T("",!0)]))}};export{ve as default};
