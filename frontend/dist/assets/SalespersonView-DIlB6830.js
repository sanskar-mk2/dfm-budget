import{u as U,r as v,c as Y,e as s,n as ae,o as oe,m as se,i as W,a as ne,b as P,d as X,f as Q,t as re,g as j}from"./index-BwlVtp6Q.js";import{_ as le,a as ue}from"./AddCustomBudgetModal-SJSzf0RS.js";function ee(d){const q=U(),{apiCall:_}=q,p=v([]),y=v(!1),l=v(""),g=v(null),$=Y(()=>g.value?.is_hospitality||!1),w=async()=>{y.value=!0,l.value="";try{const r=s(d),u=await _(`/api/sales/${r}`);if(!u.ok)throw new Error("Failed to fetch sales data");const T=await u.json();p.value=T.data||[],g.value=T.salesperson_info||null}catch(r){l.value=r.message,console.error("Error fetching sales:",r)}finally{y.value=!1}},i=()=>p.value.reduce((r,u)=>r+(parseFloat(u.q1_sales)||0),0),S=()=>p.value.reduce((r,u)=>r+(parseFloat(u.q2_sales)||0),0),h=()=>p.value.reduce((r,u)=>r+(parseFloat(u.q3_sales)||0),0),F=()=>p.value.reduce((r,u)=>r+(parseFloat(u.q4_sales)||0),0),B=()=>p.value.reduce((r,u)=>r+(parseFloat(u.total_sales)||0),0),C=()=>p.value.reduce((r,u)=>r+(parseFloat(u.zero_perc_sales_total)||0),0);return{sales:p,loading:y,error:l,salespersonInfo:g,isHospitality:$,fetchSales:w,getTotalQ1:i,getTotalQ2:S,getTotalQ3:h,getTotalQ4:F,getTotalSales:B,getTotalZeroPercent:C,getZeroPercentRate:()=>{const r=B(),u=C();return r>0?u/r*100:0}}}function ce(d){const q=U(),{apiCall:_}=q,{isHospitality:p,salespersonInfo:y}=ee(d),l=v([]),g=v({}),$=v(new Set),w=v(new Set),i=v({}),S=v({customer_classes:[],customer_names:[],brands:[],flags:[]});let h=null;const F=async()=>{try{const e=s(d),t=await _(`/api/budget/${e}`);if(!t.ok)throw new Error("Failed to fetch budget data");const a=await t.json();l.value=a.data||[],g.value={},l.value.forEach(o=>{const n=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;g.value[n]=o})}catch(e){console.error("Error fetching budgets:",e)}},B=async(e,t,a)=>{const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;$.value.add(o);try{const n=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,f=g.value[n],k=s(d);let b=y.value?.salesperson_name;if(!b)try{const M=await _("/api/admin/summary");M.ok&&(b=(await M.json()).data?.find(te=>te.salesperson_id===k)?.salesperson_name)}catch(M){console.error("Error fetching salesperson name from admin summary:",M)}const R={salesperson_id:k,salesperson_name:b||"Unknown",brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:p.value?"Hospitality":e.derived_customer_class||"General",[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let m;if(f?m=await _(`/api/budget/${k}/${f.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):m=await _(`/api/budget/${k}`,{method:"POST",body:JSON.stringify(R)}),!m.ok)throw new Error("Failed to save budget");const c=await m.json();f?f[`quarter_${t}_sales`]=parseFloat(a)||0:(g.value[n]=c.data,l.value.push(c.data)),w.value.add(o),setTimeout(()=>w.value.delete(o),1e3),E()}catch(n){console.error("Error saving budget:",n)}finally{$.value.delete(o)}},C=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;if(i.value.hasOwnProperty(a))return i.value[a];const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,n=g.value[o];return n&&n[`quarter_${t}_sales`]||0},x=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;return $.value.has(a)?"bg-blue-50 border-blue-300":w.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},r=(e,t,a)=>{h&&clearTimeout(h),h=setTimeout(()=>{a&&a!=="0"&&a!==""&&B(e,t,a)},2e3)},u=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`,n=e.target.value;i.value[o]=n,E(),r(t,a,n)},T=(e,t,a)=>{const o=e.target.value,n=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;h&&(clearTimeout(h),h=null),delete i.value[n],E(),B(t,a,o)},z=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;i.value[o]=e.target.value,e.key==="Enter"&&e.target.blur()},E=()=>{const e=typeof d=="function"?d():d,t={};Object.keys(i.value).forEach(a=>{const o=i.value[a];o&&o!=="0"&&o!==""&&(t[a]=o)}),localStorage.setItem(`budget_pending_changes_${e}`,JSON.stringify(t))},V=()=>{try{const e=s(d),t=localStorage.getItem(`budget_pending_changes_${e}`);if(t){const a=JSON.parse(t);return Object.keys(a).forEach(o=>{i.value[o]=a[o]}),Object.keys(a).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},Z=()=>{const e=typeof d=="function"?d():d;localStorage.removeItem(`budget_pending_changes_${e}`)},H=async()=>{try{const e=await _("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();S.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},J=async e=>{try{const t=s(d);let a=y.value?.salesperson_name;if(!a)try{const b=await _("/api/admin/summary");b.ok&&(a=(await b.json()).data?.find(c=>c.salesperson_id===t)?.salesperson_name)}catch(b){console.error("Error fetching salesperson name from admin summary:",b)}const o={...e,salesperson_id:t,salesperson_name:a||"Unknown",customer_class:p.value?"Hospitality":e.customer_class||"General",quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},n=await _(`/api/budget/${t}`,{method:"POST",body:JSON.stringify(o)});if(!n.ok)throw new Error("Failed to create custom budget");const f=await n.json(),k=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;return g.value[k]=f.data,l.value.push(f.data),f.data}catch(t){throw console.error("Error creating custom budget:",t),t}},I=async e=>{try{const t=s(d);if(!(await _(`/api/budget/${t}/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const o=l.value.findIndex(n=>n.id===e);if(o!==-1){const n=l.value[o],f=`${n.brand||"null"}_${n.flag||"null"}_${n.customer_name}`;delete g.value[f],l.value.splice(o,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},K=()=>l.value.filter(e=>e.is_custom===!0),D=()=>l.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),O=()=>l.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),A=()=>l.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),N=()=>l.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0);return{budgets:l,budgetMap:g,savingCells:$,savedCells:w,inputValues:i,autosuggestData:S,fetchBudgets:F,saveBudgetCell:B,getBudgetValue:C,getCellClass:x,handleBudgetChange:u,handleBudgetBlur:T,handleBudgetInput:z,savePendingChangesToStorage:E,loadPendingChangesFromStorage:V,clearPendingChangesFromStorage:Z,fetchAutosuggestData:H,createCustomBudget:J,deleteCustomBudget:I,getCustomBudgets:K,getTotalQ1Budget:D,getTotalQ2Budget:O,getTotalQ3Budget:A,getTotalQ4Budget:N,getTotalBudget:()=>D()+O()+A()+N(),cleanup:()=>{h&&clearTimeout(h)}}}const de={class:"mx-auto px-4 py-8"},ge={key:0,class:"flex justify-center"},ie={key:1,class:"alert alert-error"},me={key:2,class:"text-center py-8"},_e={key:3},ve={__name:"SalespersonView",setup(d){const q=ae(),_=se(),p=U(),y=Y(()=>{const m=q.params.salespersonId;return parseInt(m)}),l=W("addBudgetModal"),g=W("navActions"),{sales:$,loading:w,error:i,isHospitality:S,fetchSales:h,getTotalQ1:F,getTotalQ2:B,getTotalQ3:C,getTotalQ4:x,getTotalSales:r,getTotalZeroPercent:u,getZeroPercentRate:T}=ee(y),{fetchBudgets:z,getBudgetValue:E,getCellClass:V,handleBudgetChange:Z,handleBudgetBlur:H,handleBudgetInput:J,loadPendingChangesFromStorage:I,fetchAutosuggestData:K,createCustomBudget:D,deleteCustomBudget:O,getCustomBudgets:A,getTotalQ1Budget:N,getTotalQ2Budget:L,getTotalQ3Budget:G,getTotalQ4Budget:e,getTotalBudget:t,autosuggestData:a,cleanup:o}=ce(y),n=()=>{_.push("/admin")},f=()=>{l.close()},k=async m=>{console.log("handleCustomBudgetCreated called with:",m);try{await D(m),console.log("Custom budget created successfully")}catch(c){console.error("Error creating custom budget:",c)}},b=async m=>{try{await O(m),console.log("Custom budget deleted successfully")}catch(c){console.error("Error deleting custom budget:",c)}},R=async()=>{await K()};return oe(async()=>{if(!p.adminStatus){_.push("/");return}await h(),await z(),I()&&console.log("Restored pending budget changes from localStorage"),g.set([{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost mr-2",handler:n,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),window.addEventListener("beforeunload",c=>{})}),ne(()=>{window.removeEventListener("beforeunload",()=>{}),g.clear(),o()}),(m,c)=>(j(),P("div",de,[s(w)?(j(),P("div",ge,[...c[0]||(c[0]=[Q("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):s(i)?(j(),P("div",ie,[c[1]||(c[1]=Q("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[Q("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),Q("span",null,re(s(i)),1)])):s($).length===0?(j(),P("div",me,[...c[2]||(c[2]=[Q("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(j(),P("div",_e,[X(le,{sales:s($),"custom-budgets":s(A)(),"get-budget-value":s(E),"get-cell-class":s(V),"handle-budget-change":s(Z),"handle-budget-blur":s(H),"handle-budget-input":s(J),"handle-delete-custom-budget":b,"is-hospitality":s(S),"get-total-q1":s(F),"get-total-q2":s(B),"get-total-q3":s(C),"get-total-q4":s(x),"get-total-sales":s(r),"get-total-zero-percent":s(u),"get-zero-percent-rate":s(T),"get-total-q1-budget":s(N),"get-total-q2-budget":s(L),"get-total-q3-budget":s(G),"get-total-q4-budget":s(e),"get-total-budget":s(t)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),X(ue,{"is-open":s(l).isOpen.value,"is-hospitality":s(S),"autosuggest-data":s(a),onClose:f,onCreated:k,onFetchAutosuggest:R},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{ve as default};
