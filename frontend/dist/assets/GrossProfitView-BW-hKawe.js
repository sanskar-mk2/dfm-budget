import{u as z,r as M,c as A,s as Y,w as L,b as k,g as q,f as e,h as V,t as d,k as T,F as j,j as K,p as O,A as Z,o as ee,a as te,i as se,d as U,e as $}from"./index-2ZkgZC_K.js";import{_ as ae,d as le,f as b}from"./downloadUtils-CpJbyu6O.js";function ne(){const P=z(),Q=M(!1),o=M([]),y=A(()=>{const s={};for(const t of o.value){const f=`${t.salesperson_id}-${t.customer_class}-${t.group_key}`;s[f]||(s[f]={salesperson_id:t.salesperson_id,salesperson_name:t.salesperson_name,customer_class:t.customer_class,group_key:t.group_key,brand:t.brand,display_key:t.customer_class==="Hospitality"&&t.brand?`${t.group_key} (${t.brand})`:t.group_key,effective_gp_percent:t.effective_gp_percent,is_custom:t.is_custom,has_budget:t.has_budget!==void 0?t.has_budget:1,quarters:[{label:"Q1",sales_2025:t.q1_sales_2025,sales:t.quarter_1_sales,gp_percent:t.q1_gp_percent,effective_gp_percent:t.q1_effective_gp_percent||t.q1_gp_percent||t.effective_gp_percent,gp_value:t.q1_gp_value},{label:"Q2",sales_2025:t.q2_sales_2025,sales:t.quarter_2_sales,gp_percent:t.q2_gp_percent,effective_gp_percent:t.q2_effective_gp_percent||t.q2_gp_percent||t.effective_gp_percent,gp_value:t.q2_gp_value},{label:"Q3",sales_2025:t.q3_sales_2025,sales:t.quarter_3_sales,gp_percent:t.q3_gp_percent,effective_gp_percent:t.q3_effective_gp_percent||t.q3_gp_percent||t.effective_gp_percent,gp_value:t.q3_gp_value},{label:"Q4",sales_2025:t.q4_sales_2025,sales:t.quarter_4_sales,gp_percent:t.q4_gp_percent,effective_gp_percent:t.q4_effective_gp_percent||t.q4_gp_percent||t.effective_gp_percent,gp_value:t.q4_gp_value}]})}return Object.values(s)});async function p(){Q.value=!0;const t=await(await P.apiCall("/api/gross-profit")).json();o.value=t.data||[],Q.value=!1}async function G(s,t,f){const g=await P.apiCall(`/api/gross-profit/${s}/${encodeURIComponent(t)}/${encodeURIComponent(f)}`);if(!g.ok)throw new Error("Failed to fetch group");return(await g.json()).data||[]}async function E(s){const t={salesperson_id:s.salesperson_id,salesperson_name:s.salesperson_name,customer_class:s.customer_class,group_key:s.group_key},f=(u,F)=>{if(!u||u.effective_gp_percent===null||u.effective_gp_percent===void 0)return;const w=u.gp_percent,N=s.effective_gp_percent,I=w??N,D=u.effective_gp_percent||0;Math.abs(D-(I||0))>.001?t[`custom_q${F}_gp_percent`]=Math.min(Math.max(D,0),1):s.is_custom&&(t[`custom_q${F}_gp_percent`]=null)},g=s.quarters.find(u=>u.label==="Q1");f(g,1);const _=s.quarters.find(u=>u.label==="Q2");f(_,2);const S=s.quarters.find(u=>u.label==="Q3");f(S,3);const h=s.quarters.find(u=>u.label==="Q4");f(h,4);const a=[t];await P.apiCall("/api/gross-profit/save-overrides",{method:"POST",body:JSON.stringify({overrides:a})});const i=await G(s.salesperson_id,s.customer_class,s.group_key),c=[...o.value];if(c.filter(u=>u.group_key===s.group_key&&u.salesperson_id===s.salesperson_id).length>0){const u=c.findIndex(w=>w.group_key===s.group_key&&w.salesperson_id===s.salesperson_id),F=c.filter(w=>!(w.group_key===s.group_key&&w.salesperson_id===s.salesperson_id));F.splice(u,0,...i),o.value=F}else o.value=[...o.value.filter(u=>!(u.group_key===s.group_key&&u.salesperson_id===s.salesperson_id)),...i]}async function m(s){await P.apiCall(`/api/gross-profit/reset/${s.salesperson_id}/${encodeURIComponent(s.customer_class)}/${encodeURIComponent(s.group_key)}`,{method:"DELETE"});const t=await G(s.salesperson_id,s.customer_class,s.group_key),f=[...o.value];if(f.filter(_=>_.group_key===s.group_key&&_.salesperson_id===s.salesperson_id).length>0){const _=f.findIndex(h=>h.group_key===s.group_key&&h.salesperson_id===s.salesperson_id),S=f.filter(h=>!(h.group_key===s.group_key&&h.salesperson_id===s.salesperson_id));S.splice(_,0,...t),o.value=S}else o.value=[...o.value.filter(_=>!(_.group_key===s.group_key&&_.salesperson_id===s.salesperson_id)),...t]}async function B(){await P.apiCall("/api/gross-profit/reset-all",{method:"DELETE"});const s=y.value.filter(_=>_.is_custom),t=s.map(_=>G(_.salesperson_id,_.customer_class,_.group_key)),f=await Promise.all(t);let g=[...o.value];s.forEach((_,S)=>{const h=f[S];g=g.filter(a=>!(a.group_key===_.group_key&&a.salesperson_id===_.salesperson_id)),g.push(...h)}),o.value=g}return{grouped:y,fetch:p,save:E,reset:m,resetAll:B,loading:Q}}const oe={class:"card-body"},re={class:"flex items-center justify-between mb-4"},ie={class:"flex items-center gap-2"},_e={class:"card-title text-lg"},ce={key:0,class:"badge badge-warning badge-sm",title:"No budget exists for this group. Historical sales data only - read-only."},ue={key:0,class:"flex items-center gap-2"},pe=["disabled"],de=["disabled"],fe={key:0,class:"loading loading-spinner loading-xs"},ge={class:"overflow-x-auto"},ve={class:"table w-full text-sm"},me={class:"font-medium"},be=["value","onInput","onBlur","disabled"],ye={class:"font-mono"},he={class:"mt-4 pt-4 border-t border-base-300"},ke={class:"flex items-center justify-between text-sm"},qe={class:"opacity-70"},xe={key:0,class:"badge badge-sm badge-primary mr-2"},we={class:"font-mono opacity-70"},$e={__name:"GrossProfitGroupCard",props:{group:Object,onSave:Function,onReset:Function},emits:["collapse"],setup(P,{emit:Q}){const o=P,y=M(!1),p=Y({...o.group,quarters:o.group.quarters.map(a=>({...a}))}),G=M(o.group.quarters.map(a=>({label:a.label,effective_gp_percent:a.effective_gp_percent})));L(()=>o.group,a=>{Object.assign(p,{...a,quarters:a.quarters.map(i=>({...i}))}),y.value||(G.value=a.quarters.map(i=>({label:i.label,effective_gp_percent:i.effective_gp_percent})))},{deep:!0});const E=A(()=>{for(let a=0;a<p.quarters.length;a++){const i=p.quarters[a].effective_gp_percent,c=G.value.find(x=>x.label===p.quarters[a].label);if(c&&Math.abs((i||0)-(c.effective_gp_percent||0))>.001)return!0}return!1}),m=A(()=>p.has_budget!==void 0&&p.has_budget!==0),B=A(()=>m.value?p.is_custom||E.value:!1);async function s(){if(m.value){y.value=!0;try{await o.onSave(p),G.value=p.quarters.map(a=>({label:a.label,effective_gp_percent:a.effective_gp_percent}))}finally{y.value=!1}}}async function t(){y.value=!0;try{await o.onReset(p),G.value=p.quarters.map(a=>({label:a.label,effective_gp_percent:a.effective_gp_percent}))}finally{y.value=!1}}function f(a){return a==null?"-":(a*100).toFixed(1)+"%"}function g(a){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(a||0)}function _(a){return a==null||a===void 0?"":(a*100).toFixed(1)}function S(a){if(!a||a==="")return null;const i=parseFloat(a);return isNaN(i)?null:Math.min(Math.max(i/100,0),1)}function h(a,i){if(!m.value)return;const c=S(i);a.effective_gp_percent=c,c!==null&&a.sales!==null&&a.sales!==void 0&&(a.gp_value=Math.round(a.sales*c*100)/100)}return(a,i)=>(q(),k("div",{class:O(["card shadow-xl border transition-all duration-200",m.value?"bg-base-100 border-base-300 hover:shadow-2xl":"bg-base-200 border-base-300 opacity-90"])},[e("div",oe,[e("div",re,[e("div",ie,[e("h3",_e,d(p.customer_class)+" › "+d(p.salesperson_name)+" › "+d(p.display_key),1),m.value?V("",!0):(q(),k("span",ce," No Budget "))]),m.value?(q(),k("div",ue,[e("button",{class:"btn btn-sm btn-ghost",disabled:y.value||!B.value,onClick:t}," Reset ",8,pe),e("button",{class:"btn btn-sm btn-primary",disabled:y.value||!E.value,onClick:s},[y.value?(q(),k("span",fe)):V("",!0),i[0]||(i[0]=T(" Save Changes ",-1))],8,de)])):V("",!0)]),e("div",ge,[e("table",ve,[i[2]||(i[2]=e("thead",null,[e("tr",null,[e("th",null,"Quarter"),e("th",null,"2025 Sales"),e("th",null,"2026 Budget"),e("th",null,"Historical GP%"),e("th",null,"Effective GP%"),e("th",null,"GP $ (Est.)")])],-1)),e("tbody",null,[(q(!0),k(j,null,K(p.quarters,c=>(q(),k("tr",{key:c.label},[e("td",me,d(c.label),1),e("td",null,d(g(c.sales_2025)),1),e("td",null,d(g(c.sales)),1),e("td",null,d(f(c.gp_percent)),1),e("td",null,[e("input",{type:"number",step:"0.1",min:"0",max:"100",value:_(c.effective_gp_percent),onInput:x=>h(c,x.target.value),onBlur:x=>h(c,x.target.value),disabled:!m.value,class:O(["input input-sm w-20 text-right font-mono",m.value?"input-bordered":"input-disabled bg-base-300 opacity-60"]),placeholder:"0.0",title:"Cannot edit - no budget exists for this group"},null,42,be),i[1]||(i[1]=e("span",{class:"text-xs opacity-60 ml-1"},"%",-1))]),e("td",ye,d(g(c.gp_value)),1)]))),128))])])]),e("div",he,[e("div",ke,[e("span",qe,[p.is_custom?(q(),k("span",xe,"Has Custom Overrides")):V("",!0),i[3]||(i[3]=T(" Full-Year Effective GP% (Reference): ",-1))]),e("span",we,d(f(p.effective_gp_percent)),1)])])])],2))}},Ge={class:"p-6 space-y-6"},Se={key:0,class:"stats shadow mb-6"},Ce={class:"stat"},Pe={class:"stat-value text-primary"},Qe={class:"stat"},Fe={class:"stat-value text-secondary"},Re={class:"stat"},Ve={class:"stat-value text-accent"},Ee={key:1},De={class:"overflow-x-auto"},Ae={class:"table table-zebra w-full"},Be=["onClick"],Ie={class:"font-semibold"},Me={class:"text-xs opacity-70"},Ne={class:"text-right font-mono"},He={class:"text-right font-mono"},je={class:"text-right font-mono"},Te={class:"text-right font-mono font-semibold"},Oe={key:0},Ue={colspan:"100%"},ze={key:2,class:"alert alert-info"},Ke={__name:"GrossProfitView",setup(P){const Q=se("navActions"),{grouped:o,fetch:y,save:p,reset:G,resetAll:E,loading:m}=ne(),B=z(),{adminStatus:s,superadminStatus:t}=Z(B),g={id:"reset-all-overrides",text:"Reset All Overrides",class:"btn btn-warning mr-2",handler:async()=>{try{await E()}catch(l){console.error("Error resetting all overrides:",l)}},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>'},_={id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost",handler:()=>{window.history.back()},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'},S=()=>o.value?.length?o.value.map(l=>{const r=l.quarters.find(R=>R.label==="Q1"),n=l.quarters.find(R=>R.label==="Q2"),v=l.quarters.find(R=>R.label==="Q3"),C=l.quarters.find(R=>R.label==="Q4"),J=(r?.sales_2025||0)+(n?.sales_2025||0)+(v?.sales_2025||0)+(C?.sales_2025||0),W=(r?.sales||0)+(n?.sales||0)+(v?.sales||0)+(C?.sales||0),X=(r?.gp_value||0)+(n?.gp_value||0)+(v?.gp_value||0)+(C?.gp_value||0);return{salesperson_name:l.salesperson_name,salesperson_id:l.salesperson_id,customer_class:l.customer_class,group_key:l.group_key,brand:l.brand||"",q1_2025_sales:b(r?.sales_2025||0),q2_2025_sales:b(n?.sales_2025||0),q3_2025_sales:b(v?.sales_2025||0),q4_2025_sales:b(C?.sales_2025||0),total_2025_sales:b(J),q1_2026_budget:b(r?.sales||0),q2_2026_budget:b(n?.sales||0),q3_2026_budget:b(v?.sales||0),q4_2026_budget:b(C?.sales||0),total_2026_budget:b(W),q1_historical_gp_percent:r?.gp_percent!=null?(r.gp_percent*100).toFixed(2)+"%":"",q2_historical_gp_percent:n?.gp_percent!=null?(n.gp_percent*100).toFixed(2)+"%":"",q3_historical_gp_percent:v?.gp_percent!=null?(v.gp_percent*100).toFixed(2)+"%":"",q4_historical_gp_percent:C?.gp_percent!=null?(C.gp_percent*100).toFixed(2)+"%":"",q1_effective_gp_percent:r?.effective_gp_percent!=null?(r.effective_gp_percent*100).toFixed(2)+"%":"",q2_effective_gp_percent:n?.effective_gp_percent!=null?(n.effective_gp_percent*100).toFixed(2)+"%":"",q3_effective_gp_percent:v?.effective_gp_percent!=null?(v.effective_gp_percent*100).toFixed(2)+"%":"",q4_effective_gp_percent:C?.effective_gp_percent!=null?(C.effective_gp_percent*100).toFixed(2)+"%":"",full_year_effective_gp_percent:l.effective_gp_percent!=null?(l.effective_gp_percent*100).toFixed(2)+"%":"",q1_gp_value:b(r?.gp_value||0),q2_gp_value:b(n?.gp_value||0),q3_gp_value:b(v?.gp_value||0),q4_gp_value:b(C?.gp_value||0),total_gp_value:b(X),has_custom_overrides:l.is_custom?"Yes":"No"}}):[],h=()=>[{key:"salesperson_name",label:"Salesperson Name"},{key:"salesperson_id",label:"Salesperson ID"},{key:"customer_class",label:"Customer Class"},{key:"group_key",label:"Group Key"},{key:"brand",label:"Brand"},{key:"q1_2025_sales",label:"Q1 2025 Sales"},{key:"q2_2025_sales",label:"Q2 2025 Sales"},{key:"q3_2025_sales",label:"Q3 2025 Sales"},{key:"q4_2025_sales",label:"Q4 2025 Sales"},{key:"total_2025_sales",label:"Total 2025 Sales"},{key:"q1_2026_budget",label:"Q1 2026 Budget"},{key:"q2_2026_budget",label:"Q2 2026 Budget"},{key:"q3_2026_budget",label:"Q3 2026 Budget"},{key:"q4_2026_budget",label:"Q4 2026 Budget"},{key:"total_2026_budget",label:"Total 2026 Budget"},{key:"q1_historical_gp_percent",label:"Q1 Historical GP%"},{key:"q2_historical_gp_percent",label:"Q2 Historical GP%"},{key:"q3_historical_gp_percent",label:"Q3 Historical GP%"},{key:"q4_historical_gp_percent",label:"Q4 Historical GP%"},{key:"q1_effective_gp_percent",label:"Q1 Effective GP%"},{key:"q2_effective_gp_percent",label:"Q2 Effective GP%"},{key:"q3_effective_gp_percent",label:"Q3 Effective GP%"},{key:"q4_effective_gp_percent",label:"Q4 Effective GP%"},{key:"full_year_effective_gp_percent",label:"Full Year Effective GP%"},{key:"q1_gp_value",label:"Q1 GP Value"},{key:"q2_gp_value",label:"Q2 GP Value"},{key:"q3_gp_value",label:"Q3 GP Value"},{key:"q4_gp_value",label:"Q4 GP Value"},{key:"total_gp_value",label:"Total GP Value"},{key:"has_custom_overrides",label:"Has Custom Overrides"}],i={id:"export-csv",text:"Export to CSV",class:"btn btn-primary mr-2",handler:()=>{const l=S();if(!l.length){alert("No data available to export");return}const r=h(),n=`gross_profit_${new Date().toISOString().split("T")[0]}.csv`;le(l,r,n)},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>'},c=()=>{const l=[];(s.value||t.value)&&l.push(i),t.value&&l.push(g),(s.value||t.value)&&l.push(_),Q.set(l)};L([s,t],()=>c(),{immediate:!0});const x=Y({}),u=l=>`${l.salesperson_id}-${l.customer_class}-${l.group_key}`,F=l=>({...l.quarters.reduce((n,v)=>(n.sales2025+=v.sales_2025||0,n.budget2026+=v.sales||0,n.gpValue+=v.gp_value||0,n),{sales2025:0,budget2026:0,gpValue:0}),effectiveGp:l.effective_gp_percent||0}),w=A(()=>o.value?.length?o.value.map(l=>({key:u(l),group:l,summary:F(l)})):[]),N=A(()=>o.value?.length?o.value.reduce((r,n)=>r+(n.effective_gp_percent||0),0)/o.value.length:0),I=l=>{x[l]=!x[l]},D=l=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(l||0),H=l=>`${((l||0)*100).toFixed(1)}%`;return ee(()=>{c(),y()}),te(()=>Q.clear()),(l,r)=>(q(),k("div",Ge,[U(ae,{loading:$(m),error:null,onRetry:$(y)},null,8,["loading","onRetry"]),!$(m)&&$(o).length>0?(q(),k("div",Se,[r[3]||(r[3]=e("div",{class:"stat"},[e("div",{class:"stat-title"},"Module"),e("div",{class:"stat-value text-primary"}," Gross Profit Management ")],-1)),e("div",Ce,[r[0]||(r[0]=e("div",{class:"stat-title"},"Total Groups",-1)),e("div",Pe,d($(o).length),1)]),e("div",Qe,[r[1]||(r[1]=e("div",{class:"stat-title"},"Groups with Custom GP%",-1)),e("div",Fe,d($(o).filter(n=>n.is_custom).length),1)]),e("div",Re,[r[2]||(r[2]=e("div",{class:"stat-title"},"Average GP%",-1)),e("div",Ve,d(H(N.value)),1)])])):V("",!0),!$(m)&&w.value.length>0?(q(),k("div",Ee,[e("div",De,[e("table",Ae,[r[4]||(r[4]=e("thead",null,[e("tr",null,[e("th",{class:"w-20"},"Action"),e("th",null,"Group"),e("th",{class:"text-right"},"2025 Sales"),e("th",{class:"text-right"},"2026 Budget"),e("th",{class:"text-right"},"Historical GP%"),e("th",{class:"text-right"},"GP $ Est.")])],-1)),e("tbody",null,[(q(!0),k(j,null,K(w.value,n=>(q(),k(j,{key:n.key},[e("tr",null,[e("td",null,[e("button",{class:"btn btn-outline btn-xs",type:"button",onClick:v=>I(n.key)},d(x[n.key]?"Collapse":"Expand"),9,Be)]),e("td",null,[e("div",Ie,d(n.group.display_key),1),e("div",Me,d(n.group.customer_class)+" - "+d(n.group.salesperson_name),1)]),e("td",Ne,d(D(n.summary.sales2025)),1),e("td",He,d(D(n.summary.budget2026)),1),e("td",je,d(H(n.summary.effectiveGp)),1),e("td",Te,d(D(n.summary.gpValue)),1)]),x[n.key]?(q(),k("tr",Oe,[e("td",Ue,[U($e,{group:n.group,onSave:$(p),onReset:$(G),onCollapse:v=>I(n.key)},null,8,["group","onSave","onReset","onCollapse"])])])):V("",!0)],64))),128))])])])])):!$(m)&&$(o).length===0?(q(),k("div",ze,[...r[5]||(r[5]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",class:"stroke-current shrink-0 w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),e("span",null,"No gross profit data available. Please check your data sources.",-1)])])):V("",!0)]))}};export{Ke as default};
