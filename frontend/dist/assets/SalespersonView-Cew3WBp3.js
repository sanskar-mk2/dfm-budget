import{u as L,r as v,c as G,e as s,n as ae,o as oe,l as se,i as Y,a as ne,b as j,d as ee,f as O,t as re,g as x}from"./index-TXwM2Jra.js";import{_ as le,a as ue}from"./AddCustomBudgetModal-CzatNKWI.js";function ce(g){const F=L(),{apiCall:m}=F,c=v([]),b=v(!1),u=v(""),i=v(null),w=G(()=>i.value?.is_hospitality||!1),$=async()=>{b.value=!0,u.value="";try{const n=s(g),l=await m(`/api/sales/${n}`);if(!l.ok)throw new Error("Failed to fetch sales data");const q=await l.json();c.value=q.data||[],i.value=q.salesperson_info||null}catch(n){u.value=n.message,console.error("Error fetching sales:",n)}finally{b.value=!1}},p=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q1_sales)||0),0),T=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q2_sales)||0),0),h=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q3_sales)||0),0),Q=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q4_sales)||0),0),P=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q4_orders)||0),0),B=()=>c.value.reduce((n,l)=>n+(parseFloat(l.total_sales)||0),0),C=()=>c.value.reduce((n,l)=>n+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:c,loading:b,error:u,salespersonInfo:i,isHospitality:w,fetchSales:$,getTotalQ1:p,getTotalQ2:T,getTotalQ3:h,getTotalQ4Sales:Q,getTotalQ4:P,getTotalSales:B,getTotalZeroPercent:C,getZeroPercentRate:()=>{const n=B(),l=C();return n>0?l/n*100:0},getTotalOpen2026:()=>c.value.reduce((n,l)=>n+(parseFloat(l.open_2026)||0),0)}}function de(g){const F=L(),{apiCall:m}=F,c=v(null),b=G(()=>c.value?.is_hospitality||!1),u=v([]),i=v({}),w=v(new Set),$=v(new Set),p=v({}),T=v({customer_classes:[],customer_names:[],brands:[],flags:[]});let h=null;const Q=async()=>{try{const e=s(g),t=await m(`/api/sales/${e}`);if(!t.ok)throw new Error("Failed to fetch salesperson info");const a=await t.json();c.value=a.salesperson_info||null}catch(e){console.error("Error fetching salesperson info:",e)}},P=async()=>{try{await Q();const e=s(g),t=await m(`/api/budget/${e}`);if(!t.ok)throw new Error("Failed to fetch budget data");const a=await t.json();u.value=a.data||[],i.value={},u.value.forEach(o=>{const r=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;i.value[r]=o})}catch(e){console.error("Error fetching budgets:",e)}},B=async(e,t,a)=>{const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;w.value.add(o);try{const r=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,f=i.value[r],S=s(g);let y=c.value?.salesperson_name;if(!y)try{const d=await m("/api/admin/summary");d.ok&&(y=(await d.json()).data?.find(te=>te.salesperson_id===S)?.salesperson_name)}catch(d){console.error("Error fetching salesperson name from admin summary:",d)}const V={salesperson_id:S,salesperson_name:y||"Unknown",brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:b.value?"Hospitality":e.derived_customer_class||"General",[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let k;if(f?k=await m(`/api/budget/${S}/${f.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):k=await m(`/api/budget/${S}`,{method:"POST",body:JSON.stringify(V)}),!k.ok)throw new Error("Failed to save budget");const _=await k.json();f?f[`quarter_${t}_sales`]=parseFloat(a)||0:(i.value[r]=_.data,u.value.push(_.data)),$.value.add(o),setTimeout(()=>$.value.delete(o),1e3),E()}catch(r){console.error("Error saving budget:",r)}finally{w.value.delete(o)}},C=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;if(p.value.hasOwnProperty(a))return p.value[a];const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,r=i.value[o];return r&&r[`quarter_${t}_sales`]||0},D=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;return w.value.has(a)?"bg-blue-50 border-blue-300":$.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},A=(e,t,a)=>{h&&clearTimeout(h),h=setTimeout(()=>{a&&a!=="0"&&a!==""&&B(e,t,a)},2e3)},n=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`,r=e.target.value;p.value[o]=r,E(),A(t,a,r)},l=(e,t,a)=>{const o=e.target.value,r=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;h&&(clearTimeout(h),h=null),delete p.value[r],E(),B(t,a,o)},q=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;p.value[o]=e.target.value,e.key==="Enter"&&e.target.blur()},E=()=>{const e=typeof g=="function"?g():g,t={};Object.keys(p.value).forEach(a=>{const o=p.value[a];o&&o!=="0"&&o!==""&&(t[a]=o)}),localStorage.setItem(`budget_pending_changes_${e}`,JSON.stringify(t))},Z=()=>{try{const e=s(g),t=localStorage.getItem(`budget_pending_changes_${e}`);if(t){const a=JSON.parse(t);return Object.keys(a).forEach(o=>{p.value[o]=a[o]}),Object.keys(a).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},H=()=>{const e=typeof g=="function"?g():g;localStorage.removeItem(`budget_pending_changes_${e}`)},I=async()=>{try{const e=await m("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();T.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},J=async e=>{try{const t=s(g);let a=c.value?.salesperson_name;if(!a)try{const y=await m("/api/admin/summary");y.ok&&(a=(await y.json()).data?.find(_=>_.salesperson_id===t)?.salesperson_name)}catch(y){console.error("Error fetching salesperson name from admin summary:",y)}const o={...e,salesperson_id:t,salesperson_name:a||"Unknown",customer_class:b.value?"Hospitality":e.customer_class||"General",quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},r=await m(`/api/budget/${t}`,{method:"POST",body:JSON.stringify(o)});if(!r.ok)throw new Error("Failed to create custom budget");const f=await r.json(),S=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;return i.value[S]=f.data,u.value.push(f.data),f.data}catch(t){throw console.error("Error creating custom budget:",t),t}},K=async e=>{try{const t=s(g);if(!(await m(`/api/budget/${t}/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const o=u.value.findIndex(r=>r.id===e);if(o!==-1){const r=u.value[o],f=`${r.brand||"null"}_${r.flag||"null"}_${r.customer_name}`;delete i.value[f],u.value.splice(o,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},U=()=>u.value.filter(e=>e.is_custom===!0),N=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),R=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),M=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),z=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0);return{budgets:u,budgetMap:i,savingCells:w,savedCells:$,inputValues:p,autosuggestData:T,salespersonInfo:c,isHospitality:b,fetchBudgets:P,saveBudgetCell:B,getBudgetValue:C,getCellClass:D,handleBudgetChange:n,handleBudgetBlur:l,handleBudgetInput:q,savePendingChangesToStorage:E,loadPendingChangesFromStorage:Z,clearPendingChangesFromStorage:H,fetchAutosuggestData:I,createCustomBudget:J,deleteCustomBudget:K,getCustomBudgets:U,getTotalQ1Budget:N,getTotalQ2Budget:R,getTotalQ3Budget:M,getTotalQ4Budget:z,getTotalBudget:()=>N()+R()+M()+z(),cleanup:()=>{h&&clearTimeout(h)}}}const ge={class:"mx-auto px-4 py-8"},ie={key:0,class:"flex justify-center"},me={key:1,class:"alert alert-error"},pe={key:2,class:"text-center py-8"},_e={key:3},ye={__name:"SalespersonView",setup(g){const F=ae(),m=se(),c=L(),b=G(()=>{const _=F.params.salespersonId;return parseInt(_)}),u=Y("addBudgetModal"),i=Y("navActions"),{sales:w,loading:$,error:p,isHospitality:T,fetchSales:h,getTotalQ1:Q,getTotalQ2:P,getTotalQ3:B,getTotalQ4Sales:C,getTotalQ4:D,getTotalSales:A,getTotalZeroPercent:n,getZeroPercentRate:l,getTotalOpen2026:q}=ce(b),{fetchBudgets:E,getBudgetValue:Z,getCellClass:H,handleBudgetChange:I,handleBudgetBlur:J,handleBudgetInput:K,loadPendingChangesFromStorage:U,fetchAutosuggestData:N,createCustomBudget:R,deleteCustomBudget:M,getCustomBudgets:z,getTotalQ1Budget:W,getTotalQ2Budget:X,getTotalQ3Budget:e,getTotalQ4Budget:t,getTotalBudget:a,autosuggestData:o,cleanup:r}=de(b),f=()=>{m.push("/admin")},S=()=>{u.close()},y=async _=>{console.log("handleCustomBudgetCreated called with:",_);try{await R(_),console.log("Custom budget created successfully")}catch(d){console.error("Error creating custom budget:",d)}},V=async _=>{try{await M(_),console.log("Custom budget deleted successfully")}catch(d){console.error("Error deleting custom budget:",d)}},k=async()=>{await N()};return oe(async()=>{if(!c.adminStatus){m.push("/");return}await h(),await E(),U()&&console.log("Restored pending budget changes from localStorage"),i.set([{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost mr-2",handler:f,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),window.addEventListener("beforeunload",d=>{})}),ne(()=>{window.removeEventListener("beforeunload",()=>{}),i.clear(),r()}),(_,d)=>(x(),j("div",ge,[s($)?(x(),j("div",ie,[...d[0]||(d[0]=[O("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):s(p)?(x(),j("div",me,[d[1]||(d[1]=O("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[O("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),O("span",null,re(s(p)),1)])):s(w).length===0?(x(),j("div",pe,[...d[2]||(d[2]=[O("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(x(),j("div",_e,[ee(le,{sales:s(w),"custom-budgets":s(z)(),"get-budget-value":s(Z),"get-cell-class":s(H),"handle-budget-change":s(I),"handle-budget-blur":s(J),"handle-budget-input":s(K),"handle-delete-custom-budget":V,"is-hospitality":s(T),"get-total-q1":s(Q),"get-total-q2":s(P),"get-total-q3":s(B),"get-total-q4-sales":s(C),"get-total-q4":s(D),"get-total-sales":s(A),"get-total-zero-percent":s(n),"get-zero-percent-rate":s(l),"get-total-open-2026":s(q),"get-total-q1-budget":s(W),"get-total-q2-budget":s(X),"get-total-q3-budget":s(e),"get-total-q4-budget":s(t),"get-total-budget":s(a)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),ee(ue,{"is-open":s(u).isOpen.value,"is-hospitality":s(T),"autosuggest-data":s(o),onClose:S,onCreated:y,onFetchAutosuggest:k},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{ye as default};
