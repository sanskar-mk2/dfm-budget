import{u as V,r as k,c as $,w as C,b as g,g as f,f as t,t as m,s as N,F as G,j as P,d as S,h as R,k as j,m as q,o as A,i as E,a as F,A as D,e as _}from"./index-TXwM2Jra.js";import{_ as M}from"./LoadingError-y_4YO6XF.js";function I(){const p=V(),d=k(!1),a=k([]),l=$(()=>{const s={};for(const e of a.value){const n=`${e.salesperson_id}-${e.customer_class}-${e.group_key}`;s[n]||(s[n]={salesperson_id:e.salesperson_id,salesperson_name:e.salesperson_name,customer_class:e.customer_class,group_key:e.group_key,brand:e.brand,display_key:e.customer_class==="Hospitality"&&e.brand?`${e.group_key} (${e.brand})`:e.group_key,effective_gp_percent:e.effective_gp_percent,is_custom:e.is_custom,quarters:[{label:"Q1",sales_2025:e.q1_sales_2025,sales:e.quarter_1_sales,gp_percent:e.q1_gp_percent,gp_value:e.q1_gp_value},{label:"Q2",sales_2025:e.q2_sales_2025,sales:e.quarter_2_sales,gp_percent:e.q2_gp_percent,gp_value:e.q2_gp_value},{label:"Q3",sales_2025:e.q3_sales_2025,sales:e.quarter_3_sales,gp_percent:e.q3_gp_percent,gp_value:e.q3_gp_value},{label:"Q4",sales_2025:e.q4_sales_2025,sales:e.quarter_4_sales,gp_percent:e.q4_gp_percent,gp_value:e.q4_gp_value}]})}return Object.values(s)});async function c(){d.value=!0;const e=await(await p.apiCall("/api/gross-profit")).json();a.value=e.data||[],d.value=!1}async function h(s,e,n){const r=await p.apiCall(`/api/gross-profit/${s}/${encodeURIComponent(e)}/${encodeURIComponent(n)}`);if(!r.ok)throw new Error("Failed to fetch group");return(await r.json()).data||[]}async function i(s){const e=Math.min(Math.max(s.effective_gp_percent,0),1),n=[{salesperson_id:s.salesperson_id,salesperson_name:s.salesperson_name,customer_class:s.customer_class,group_key:s.group_key,custom_gp_percent:e}];await p.apiCall("/api/gross-profit/save-overrides",{method:"POST",body:JSON.stringify({overrides:n})});const r=await h(s.salesperson_id,s.customer_class,s.group_key),o=[...a.value];if(o.filter(u=>u.group_key===s.group_key&&u.salesperson_id===s.salesperson_id).length>0){const u=o.findIndex(x=>x.group_key===s.group_key&&x.salesperson_id===s.salesperson_id),w=o.filter(x=>!(x.group_key===s.group_key&&x.salesperson_id===s.salesperson_id));w.splice(u,0,...r),a.value=w}else a.value=[...a.value.filter(u=>!(u.group_key===s.group_key&&u.salesperson_id===s.salesperson_id)),...r]}async function v(s){await p.apiCall(`/api/gross-profit/reset/${s.salesperson_id}/${encodeURIComponent(s.customer_class)}/${encodeURIComponent(s.group_key)}`,{method:"DELETE"});const e=await h(s.salesperson_id,s.customer_class,s.group_key),n=[...a.value];if(n.filter(o=>o.group_key===s.group_key&&o.salesperson_id===s.salesperson_id).length>0){const o=n.findIndex(u=>u.group_key===s.group_key&&u.salesperson_id===s.salesperson_id),b=n.filter(u=>!(u.group_key===s.group_key&&u.salesperson_id===s.salesperson_id));b.splice(o,0,...e),a.value=b}else a.value=[...a.value.filter(o=>!(o.group_key===s.group_key&&o.salesperson_id===s.salesperson_id)),...e]}async function y(){await p.apiCall("/api/gross-profit/reset-all",{method:"DELETE"});const s=l.value.filter(o=>o.is_custom),e=s.map(o=>h(o.salesperson_id,o.customer_class,o.group_key)),n=await Promise.all(e);let r=[...a.value];s.forEach((o,b)=>{const u=n[b];r=r.filter(w=>!(w.group_key===o.group_key&&w.salesperson_id===o.salesperson_id)),r.push(...u)}),a.value=r}return{grouped:l,fetch:c,save:i,reset:v,resetAll:y,loading:d}}const B={class:"flex items-center space-x-3 w-full"},U=["value"],O={class:"badge badge-sm badge-primary"},T={__name:"GrossProfitSlider",props:{modelValue:Number},emits:["update:modelValue"],setup(p,{emit:d}){const a=p,l=d,c=k((a.modelValue||0)*100),h=$(()=>{const i=c.value;return typeof i!="number"||isNaN(i)?"0.0":i.toFixed(1)});return C(c,i=>{if(typeof i=="number"&&!isNaN(i)){const v=i/100;l("update:modelValue",v)}}),C(()=>a.modelValue,i=>{typeof i=="number"&&!isNaN(i)?c.value=i*100:c.value=0}),(i,v)=>(f(),g("div",B,[t("input",{type:"range",min:"0",max:"100",step:"0.1",value:typeof c.value=="number"&&!isNaN(c.value)?c.value:0,onInput:v[0]||(v[0]=y=>c.value=parseFloat(y.target.value)||0),class:"range range-sm range-primary flex-grow"},null,40,U),t("span",O,m(h.value)+"% ",1)]))}},Q={class:"card bg-base-100 shadow-xl border border-base-300 transition-all duration-200 hover:shadow-2xl"},H={class:"card-body"},L={class:"flex items-center justify-between mb-4"},z={class:"card-title text-lg"},J={class:"overflow-x-auto"},W={class:"table w-full text-sm"},K={class:"font-medium"},X={class:"font-mono"},Y={class:"flex justify-between items-center mt-4"},Z={class:"w-full max-w-sm"},ee={class:"flex items-center space-x-2"},se={class:"text-sm opacity-70"},te={key:0,class:"badge badge-sm badge-primary ml-2"},ae={class:"space-x-2"},oe=["disabled"],ne=["disabled"],le={key:0,class:"loading loading-spinner loading-xs"},re={__name:"GrossProfitGroupCard",props:{group:Object,onSave:Function,onReset:Function},setup(p){const d=p,a=k(!1),l=N({...d.group});k(d.group.effective_gp_percent);const c=k(d.group.effective_gp_percent);C(()=>d.group,n=>{Object.assign(l,n),a.value||(c.value=n.effective_gp_percent)},{deep:!0});const h=$(()=>{const n=l.effective_gp_percent,r=c.value;return Math.abs(n-r)>.001}),i=$(()=>l.is_custom||h.value);async function v(){a.value=!0;try{await d.onSave(l),c.value=l.effective_gp_percent}finally{a.value=!1}}async function y(){a.value=!0;try{await d.onReset(l),c.value=l.effective_gp_percent}finally{a.value=!1}}function s(n){return n==null?"-":(n*100).toFixed(1)+"%"}function e(n){return n?"$"+n.toLocaleString():"-"}return(n,r)=>(f(),g("div",Q,[t("div",H,[t("div",L,[t("div",null,[t("h3",z,m(l.customer_class)+" › "+m(l.salesperson_name)+" › "+m(l.display_key),1)])]),t("div",J,[t("table",W,[r[1]||(r[1]=t("thead",null,[t("tr",null,[t("th",null,"Quarter"),t("th",null,"2025 Sales"),t("th",null,"2026 Budget"),t("th",null,"Historical GP%"),t("th",null,"GP $ (Est.)")])],-1)),t("tbody",null,[(f(!0),g(G,null,P(l.quarters,o=>(f(),g("tr",{key:o.label},[t("td",K,m(o.label),1),t("td",null,m(e(o.sales_2025)),1),t("td",null,m(e(o.sales)),1),t("td",null,m(s(o.gp_percent)),1),t("td",X,m(e(o.gp_value)),1)]))),128))])])]),t("div",Y,[t("div",Z,[r[2]||(r[2]=t("label",{class:"text-sm font-medium mb-2 block"}," Effective GP% ",-1)),t("div",ee,[S(T,{modelValue:l.effective_gp_percent,"onUpdate:modelValue":r[0]||(r[0]=o=>l.effective_gp_percent=o)},null,8,["modelValue"]),t("div",se,[l.is_custom?(f(),g("span",te,"Custom")):R("",!0)])])]),t("div",ae,[t("button",{class:"btn btn-sm btn-ghost",disabled:a.value||!i.value,onClick:y}," Reset ",8,oe),t("button",{class:"btn btn-sm btn-primary",disabled:a.value||!h.value,onClick:v},[a.value?(f(),g("span",le)):R("",!0),r[3]||(r[3]=j(" Save Changes ",-1))],8,ne)])])])]))}},ie={class:"space-y-6"},ce={__name:"GrossProfitTable",props:{groups:Array,onSave:Function,onReset:Function},setup(p){return(d,a)=>(f(),g("div",ie,[(f(!0),g(G,null,P(p.groups,l=>(f(),q(re,{key:l.display_key,group:l,onSave:p.onSave,onReset:p.onReset},null,8,["group","onSave","onReset"]))),128))]))}},de={class:"p-6 space-y-6"},ue={key:0,class:"stats shadow mb-6"},_e={class:"stat"},pe={class:"stat-value text-primary"},ve={class:"stat"},fe={class:"stat-value text-secondary"},me={class:"stat"},ge={class:"stat-value text-accent"},he={key:1},ye={key:2,class:"alert alert-info"},we={__name:"GrossProfitView",setup(p){const d=E("navActions"),{grouped:a,fetch:l,save:c,reset:h,resetAll:i,loading:v}=I(),y=async()=>{try{await i()}catch(s){console.error("Error resetting all overrides:",s)}};return A(()=>{d.set([{id:"reset-all-overrides",text:"Reset All Overrides",class:"btn btn-warning mr-2",handler:y,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>'},{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost",handler:()=>{window.history.back()},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),l()}),F(()=>d.clear()),(s,e)=>(f(),g("div",de,[e[4]||(e[4]=D('<div class="hero bg-base-200 rounded-lg"><div class="hero-content text-center"><div class="max-w-4xl"><h1 class="text-5xl font-bold">Gross Profit Management</h1><p class="py-6"> Adjust effective GP% overrides for budget allocation. Use sliders to modify gross profit percentages and save changes. </p></div></div></div>',1)),S(M,{loading:_(v),error:null,onRetry:_(l)},null,8,["loading","onRetry"]),!_(v)&&_(a).length>0?(f(),g("div",ue,[t("div",_e,[e[0]||(e[0]=t("div",{class:"stat-title"},"Total Groups",-1)),t("div",pe,m(_(a).length),1)]),t("div",ve,[e[1]||(e[1]=t("div",{class:"stat-title"},"Groups with Custom GP%",-1)),t("div",fe,m(_(a).filter(n=>n.is_custom).length),1)]),t("div",me,[e[2]||(e[2]=t("div",{class:"stat-title"},"Average GP%",-1)),t("div",ge,m((_(a).reduce((n,r)=>n+r.effective_gp_percent,0)/_(a).length*100).toFixed(1))+"% ",1)])])):R("",!0),!_(v)&&_(a).length>0?(f(),g("div",he,[S(ce,{groups:_(a),onSave:_(c),onReset:_(h)},null,8,["groups","onSave","onReset"])])):!_(v)&&_(a).length===0?(f(),g("div",ye,[...e[3]||(e[3]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",class:"stroke-current shrink-0 w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),t("span",null,"No gross profit data available. Please check your data sources.",-1)])])):R("",!0)]))}};export{we as default};
