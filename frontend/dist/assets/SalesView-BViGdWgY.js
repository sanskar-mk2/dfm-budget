import{u as A,r as p,c as se,_ as le,a as q,b as F,d as $,e as y,F as I,t as re,i as ee,o as te,f as ae,g as E}from"./index-5HnzLnCl.js";import{A as ne,S as ue}from"./AddCustomBudgetModal-BS0GH3o8.js";function z(){const h=A(),{apiCall:u}=h,c=p([]),t=p(!1),g=p(""),v=se(()=>(h.currentSalesperson?.role||"").startsWith("Hospitality")),f=async()=>{t.value=!0,g.value="";try{const s=await u("/api/sales");if(!s.ok)throw new Error("Failed to fetch sales data");const r=await s.json();c.value=r.data||[]}catch(s){g.value=s.message,console.error("Error fetching sales:",s)}finally{t.value=!1}},d=()=>c.value.reduce((s,r)=>s+(parseFloat(r.q1_sales)||0),0),B=()=>c.value.reduce((s,r)=>s+(parseFloat(r.q2_sales)||0),0),i=()=>c.value.reduce((s,r)=>s+(parseFloat(r.q3_sales)||0),0),m=()=>c.value.reduce((s,r)=>s+(parseFloat(r.q4_sales)||0),0),_=()=>c.value.reduce((s,r)=>s+(parseFloat(r.q4_orders)||0),0),S=()=>c.value.reduce((s,r)=>s+(parseFloat(r.total_sales)||0),0),b=()=>c.value.reduce((s,r)=>s+(parseFloat(r.zero_perc_sales_total)||0),0);return{sales:c,loading:t,error:g,isHospitality:v,fetchSales:f,getTotalQ1:d,getTotalQ2:B,getTotalQ3:i,getTotalQ4Sales:m,getTotalQ4:_,getTotalSales:S,getTotalZeroPercent:b,getZeroPercentRate:()=>{const s=S(),r=b();return s>0?r/s*100:0},getTotalOpen2026:()=>c.value.reduce((s,r)=>s+(parseFloat(r.open_2026)||0),0)}}function oe(){const h=A(),{apiCall:u}=h,{isHospitality:c}=z(),t=p([]),g=p({}),v=p(new Set),f=p(new Set),d=p({}),B=p({customer_classes:[],customer_names:[],brands:[],flags:[]});let i=null;const m=e=>{const a=e.brand||"null",o=e.flag||"null",l=e.customer_name||"null",n=e.customer_class||e.derived_customer_class||"null";return`${a}_${o}_${l}_${n}`},_=(e,a)=>`${m(e)}_${a}`,S=async()=>{try{const e=await u("/api/budget");if(!e.ok)throw new Error("Failed to fetch budget data");const a=await e.json();t.value=a.data||[],g.value={},t.value.forEach(o=>{const l=m(o);g.value[l]=o})}catch(e){console.error("Error fetching budgets:",e)}},b=async(e,a,o)=>{const l=_(e,a);v.value.add(l);try{if(!h.currentSalesperson)throw new Error("Salesperson data not available");const n=m(e),w=g.value[n],Z={salesperson_id:h.currentSalesperson.salesman_no,salesperson_name:h.currentSalesperson.salesman_name,brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:c.value?"Hospitality":e.derived_customer_class,[`quarter_${a}_sales`]:parseFloat(o)||0,is_custom:e.is_custom||!1};let C;if(w?C=await u(`/api/budget/${w.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${a}_sales`]:parseFloat(o)||0})}):C=await u("/api/budget",{method:"POST",body:JSON.stringify(Z)}),!C.ok)throw new Error("Failed to save budget");const x=await C.json();w?w[`quarter_${a}_sales`]=parseFloat(o)||0:(g.value[n]=x.data,t.value.push(x.data)),f.value.add(l),setTimeout(()=>f.value.delete(l),1e3),T()}catch(n){console.error("Error saving budget:",n)}finally{v.value.delete(l)}},k=(e,a)=>{const o=_(e,a);if(d.value.hasOwnProperty(o))return d.value[o];const l=m(e),n=g.value[l];return n&&n[`quarter_${a}_sales`]||0},P=(e,a)=>{const o=_(e,a);return v.value.has(o)?"bg-blue-50 border-blue-300":f.value.has(o)?"bg-green-50 border-green-300":"hover:bg-gray-50"},s=(e,a,o)=>{i&&clearTimeout(i),i=setTimeout(()=>{o&&o!=="0"&&o!==""&&b(e,a,o)},2e3)},r=(e,a,o)=>{const l=_(a,o),n=e.target.value;d.value[l]=n,T(),s(a,o,n)},D=(e,a,o)=>{const l=e.target.value,n=_(a,o);i&&(clearTimeout(i),i=null),delete d.value[n],T(),b(a,o,l)},O=(e,a,o)=>{const l=_(a,o);d.value[l]=e.target.value,e.key==="Enter"&&e.target.blur()},T=()=>{const e={};Object.keys(d.value).forEach(a=>{const o=d.value[a];o&&o!=="0"&&o!==""&&(e[a]=o)}),localStorage.setItem("budget_pending_changes",JSON.stringify(e))};return{budgets:t,budgetMap:g,savingCells:v,savedCells:f,inputValues:d,autosuggestData:B,fetchBudgets:S,saveBudgetCell:b,getBudgetValue:k,getCellClass:P,handleBudgetChange:r,handleBudgetBlur:D,handleBudgetInput:O,savePendingChangesToStorage:T,loadPendingChangesFromStorage:()=>{try{const e=localStorage.getItem("budget_pending_changes");if(e){const a=JSON.parse(e);return Object.keys(a).forEach(o=>{d.value[o]=a[o]}),Object.keys(a).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},clearPendingChangesFromStorage:()=>{localStorage.removeItem("budget_pending_changes")},fetchAutosuggestData:async()=>{try{const e=await u("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const a=await e.json();B.value=a.data}catch(e){console.error("Error fetching autosuggest data:",e)}},createCustomBudget:async e=>{try{if(!h.currentSalesperson)throw new Error("Salesperson data not available");const a={...e,salesperson_id:h.currentSalesperson.salesman_no,salesperson_name:h.currentSalesperson.salesman_name,customer_class:c.value?"Hospitality":e.customer_class,quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},o=await u("/api/budget",{method:"POST",body:JSON.stringify(a)});if(!o.ok)throw new Error("Failed to create custom budget");const l=await o.json(),n=m(l.data);return g.value[n]=l.data,t.value.push(l.data),l.data}catch(a){throw console.error("Error creating custom budget:",a),a}},deleteCustomBudget:async e=>{try{if(!(await u(`/api/budget/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const o=t.value.findIndex(l=>l.id===e);if(o!==-1){const l=t.value[o],n=m(l);delete g.value[n],t.value.splice(o,1)}return!0}catch(a){throw console.error("Error deleting custom budget:",a),a}},getCustomBudgets:()=>t.value.filter(e=>e.is_custom===!0),getTotalQ1Budget:()=>t.value.reduce((e,a)=>e+(parseFloat(a.quarter_1_sales)||0),0),getTotalQ2Budget:()=>t.value.reduce((e,a)=>e+(parseFloat(a.quarter_2_sales)||0),0),getTotalQ3Budget:()=>t.value.reduce((e,a)=>e+(parseFloat(a.quarter_3_sales)||0),0),getTotalQ4Budget:()=>t.value.reduce((e,a)=>e+(parseFloat(a.quarter_4_sales)||0),0),getTotalBudget:()=>t.value.reduce((e,a)=>e+(parseFloat(a.total_sales)||0),0),cleanup:()=>{i&&clearTimeout(i)}}}const ge={__name:"SalesView",setup(h,{expose:u}){u();const{currentUser:c,currentSalesperson:t}=A(),g=ee("addBudgetModal"),{sales:v,loading:f,error:d,isHospitality:B,fetchSales:i,getTotalQ1:m,getTotalQ2:_,getTotalQ3:S,getTotalQ4Sales:b,getTotalQ4:k,getTotalSales:P,getTotalZeroPercent:s,getZeroPercentRate:r,getTotalOpen2026:D}=z(),{fetchBudgets:O,getBudgetValue:T,getCellClass:K,handleBudgetChange:R,handleBudgetBlur:J,handleBudgetInput:L,loadPendingChangesFromStorage:M,fetchAutosuggestData:N,createCustomBudget:V,deleteCustomBudget:H,getCustomBudgets:U,getTotalQ1Budget:G,getTotalQ2Budget:W,getTotalQ3Budget:X,getTotalQ4Budget:e,getTotalBudget:a,autosuggestData:o,cleanup:l}=oe(),n=()=>{g.open()},w=()=>{g.close()},Z=async Q=>{console.log("handleCustomBudgetCreated called with:",Q);try{await V(Q),console.log("Custom budget created successfully")}catch(j){console.error("Error creating custom budget:",j)}},C=async Q=>{try{await H(Q),console.log("Custom budget deleted successfully")}catch(j){console.error("Error deleting custom budget:",j)}},x=async()=>{await N()};te(async()=>{await i(),await O(),M()&&console.log("Restored pending budget changes from localStorage"),window.addEventListener("beforeunload",j=>{})}),ae(()=>{window.removeEventListener("beforeunload",()=>{}),l()});const Y={currentUser:c,currentSalesperson:t,addBudgetModal:g,sales:v,loading:f,error:d,isHospitality:B,fetchSales:i,getTotalQ1:m,getTotalQ2:_,getTotalQ3:S,getTotalQ4Sales:b,getTotalQ4:k,getTotalSales:P,getTotalZeroPercent:s,getZeroPercentRate:r,getTotalOpen2026:D,fetchBudgets:O,getBudgetValue:T,getCellClass:K,handleBudgetChange:R,handleBudgetBlur:J,handleBudgetInput:L,loadPendingChangesFromStorage:M,fetchAutosuggestData:N,createCustomBudget:V,deleteCustomBudget:H,getCustomBudgets:U,getTotalQ1Budget:G,getTotalQ2Budget:W,getTotalQ3Budget:X,getTotalQ4Budget:e,getTotalBudget:a,autosuggestData:o,cleanup:l,openModal:n,closeModal:w,handleCustomBudgetCreated:Z,handleDeleteCustomBudget:C,handleFetchAutosuggest:x,onMounted:te,onUnmounted:ae,ref:p,inject:ee,get useAuthStore(){return A},get useSalesData(){return z},get useBudgetData(){return oe},SalesTable:ue,AddCustomBudgetModal:ne};return Object.defineProperty(Y,"__isScriptSetup",{enumerable:!1,value:!0}),Y}},ce={class:"mx-auto px-4 py-8"},de={key:0,class:"flex justify-center"},ie={class:"alert alert-error"};function he(h,u,c,t,g,v){return E(),q("div",ce,[F(" Loading State "),t.loading?(E(),q("div",de,[...u[0]||(u[0]=[y("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):t.error?(E(),q(I,{key:1},[F(" Error State "),y("div",ie,[u[1]||(u[1]=y("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[y("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),y("span",null,re(t.error),1)])],2112)):t.sales.length===0?(E(),q(I,{key:2},[F(" Empty State "),u[2]||(u[2]=y("div",{class:"text-center py-8"},[y("p",{class:"text-lg text-base-content/70"},"No sales data found")],-1))],2112)):(E(),q(I,{key:3},[F(" Main Content "),y("div",null,[F(" Sales Table "),$(t.SalesTable,{sales:t.sales,"custom-budgets":t.getCustomBudgets(),"get-budget-value":t.getBudgetValue,"get-cell-class":t.getCellClass,"handle-budget-change":t.handleBudgetChange,"handle-budget-blur":t.handleBudgetBlur,"handle-budget-input":t.handleBudgetInput,"handle-delete-custom-budget":t.handleDeleteCustomBudget,"is-hospitality":t.isHospitality,"get-total-q1":t.getTotalQ1,"get-total-q2":t.getTotalQ2,"get-total-q3":t.getTotalQ3,"get-total-q4-sales":t.getTotalQ4Sales,"get-total-q4":t.getTotalQ4,"get-total-sales":t.getTotalSales,"get-total-zero-percent":t.getTotalZeroPercent,"get-zero-percent-rate":t.getZeroPercentRate,"get-total-open-2026":t.getTotalOpen2026,"get-total-q1-budget":t.getTotalQ1Budget,"get-total-q2-budget":t.getTotalQ2Budget,"get-total-q3-budget":t.getTotalQ3Budget,"get-total-q4-budget":t.getTotalQ4Budget,"get-total-budget":t.getTotalBudget},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])],2112)),F(" Custom Budget Modal "),$(t.AddCustomBudgetModal,{"is-open":t.addBudgetModal.isOpen.value,"is-hospitality":t.isHospitality,"autosuggest-data":t.autosuggestData,onClose:t.closeModal,onCreated:t.handleCustomBudgetCreated,onFetchAutosuggest:t.handleFetchAutosuggest},null,8,["is-open","is-hospitality","autosuggest-data"])])}const pe=le(ge,[["render",he],["__file","G:/ProjectsPARA/Projects/budget-2026/frontend/src/views/SalesView.vue"]]);export{pe as default};
