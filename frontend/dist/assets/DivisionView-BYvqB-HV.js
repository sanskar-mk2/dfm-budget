import{u as N,r as j,c as S,b as m,g as p,f as t,p as A,t as _,F,j as T,h as E,d as q,w as O,o as B,i as L,a as M,A as U,e as k,m as z}from"./index-OE4JlXoz.js";import{_ as G}from"./LoadingError-C4CRoX5x.js";function V(){const i=N(),y=j(!1),d=j(null),c=j([]),r=S(()=>{if(!c.value.length)return[];const o={};return c.value.forEach(s=>{const a=`${s.salesperson_id}-${s.customer_class}-${s.group_key}`;o[a]||(o[a]={salesperson_id:s.salesperson_id,salesperson_name:s.salesperson_name,customer_class:s.customer_class,group_key:s.group_key,brand:s.brand,display_key:s.customer_class==="Hospitality"&&s.brand?`${s.group_key} (${s.brand})`:s.group_key,divisions:[],totalRatio:0,hasCustomRatios:!1});const e={item_division:s.item_division,division_name:s.division_name,effective_ratio:s.effective_ratio,is_custom:s.is_custom,q1_allocated:s.q1_allocated,q2_allocated:s.q2_allocated,q3_allocated:s.q3_allocated,q4_allocated:s.q4_allocated,total_allocated:s.total_allocated,division_ratio_2025:s.division_ratio_2025,total_2025_sales:s.total_2025_sales,locked:!1};o[a].divisions.push(e),o[a].totalRatio+=e.effective_ratio,e.is_custom&&(o[a].hasCustomRatios=!0)}),Object.values(o).forEach(s=>{s.divisions.sort((a,e)=>a.item_division-e.item_division)}),Object.values(o)}),R=async()=>{y.value=!0,d.value=null;try{const o=await i.apiCall("/api/division/allocations");if(o.ok){const s=await o.json();c.value=s.data||[]}else{const s=await o.json();console.error("Error fetching division data:",s),d.value=s.detail||"Failed to fetch division data"}}catch(o){console.error("Exception fetching division data:",o),d.value="Network error occurred"}finally{y.value=!1}},w=async(o,s,a)=>{const e=await i.apiCall(`/api/division/allocations/${o}/${encodeURIComponent(s)}/${encodeURIComponent(a)}`);if(!e.ok)throw new Error("Failed to fetch group");return(await e.json()).data||[]},g=async(o,s)=>{try{const a=r.value.find(u=>u.group_key===o);if(!a)throw new Error("Group not found");const e=s.filter(u=>u.is_custom||u.effective_ratio!==u.division_ratio_2025).map(u=>({salesperson_id:a.salesperson_id,salesperson_name:a.salesperson_name,customer_class:a.customer_class,group_key:a.group_key,item_division:u.item_division,custom_ratio:u.effective_ratio}));if(e.length===0)return console.log("No changes to save"),{success:!0,message:"No changes to save"};const l=await i.apiCall("/api/division/save-ratios",{method:"POST",body:JSON.stringify({overrides:e})});if(l.ok){const u=await l.json(),$=await w(a.salesperson_id,a.customer_class,a.group_key),C=[...c.value];if(C.filter(f=>f.group_key===a.group_key&&f.salesperson_id===a.salesperson_id).length>0){const f=C.findIndex(v=>v.group_key===a.group_key&&v.salesperson_id===a.salesperson_id),x=C.filter(v=>!(v.group_key===a.group_key&&v.salesperson_id===a.salesperson_id));x.splice(f,0,...$),c.value=x}else c.value=[...c.value.filter(f=>!(f.group_key===a.group_key&&f.salesperson_id===a.salesperson_id)),...$];return u}else{const u=await l.json();throw console.error("Error saving ratios:",u),new Error(u.detail||"Failed to save ratios")}}catch(a){throw console.error("Exception saving ratios:",a),a}},n=async(o,s,a)=>{try{const e=await i.apiCall(`/api/division/reset-group/${o}/${encodeURIComponent(s)}/${encodeURIComponent(a)}`,{method:"DELETE"});if(e.ok){const l=await e.json(),u=await w(o,s,a),$=[...c.value];if($.filter(b=>b.group_key===a&&b.salesperson_id===o).length>0){const b=$.findIndex(x=>x.group_key===a&&x.salesperson_id===o),f=$.filter(x=>!(x.group_key===a&&x.salesperson_id===o));f.splice(b,0,...u),c.value=f}else c.value=[...c.value.filter(b=>!(b.group_key===a&&b.salesperson_id===o)),...u];return l}else{const l=await e.json();throw new Error(l.detail||"Failed to reset group overrides")}}catch(e){throw console.error("Exception resetting group overrides:",e),e}};return{loading:y,error:d,divisionData:c,groupedData:r,fetchDivisionData:R,saveRatios:g,resetGroupOverrides:n,resetAllOverrides:async()=>{try{const o=r.value.filter(s=>s.hasCustomRatios).map(s=>n(s.salesperson_id,s.customer_class,s.group_key));return o.length===0?{success:!0,message:"No overrides to reset"}:(await Promise.all(o),{success:!0,message:`Reset overrides for ${o.length} groups`})}catch(o){throw console.error("Exception resetting all overrides:",o),o}}}}const H={class:"flex items-center gap-2"},P=["disabled","title"],I={key:0,xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},J={key:1,xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},W={class:"flex-1"},X=["value","disabled"],Y={class:"text-sm font-mono min-w-[4rem] text-right"},Z={__name:"DivisionSlider",props:{ratio:{type:Number,required:!0},locked:{type:Boolean,default:!1},divisionName:{type:String,required:!0},disabled:{type:Boolean,default:!1}},emits:["ratio-change","lock-toggle"],setup(i,{emit:y}){const d=i,c=y,r=S(()=>(d.ratio*100).toFixed(1)),R=g=>{if(!d.locked&&!d.disabled){const n=parseFloat(g.target.value);c("ratio-change",n)}},w=()=>{d.disabled||c("lock-toggle")};return(g,n)=>(p(),m("div",H,[t("button",{onClick:w,disabled:i.disabled,class:A(["btn btn-sm btn-ghost",i.locked?"btn-primary":"btn-outline",i.disabled?"btn-disabled":""]),title:i.locked?"Unlock to edit":"Lock to prevent changes"},[i.locked?(p(),m("svg",I,[...n[0]||(n[0]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"},null,-1)])])):(p(),m("svg",J,[...n[1]||(n[1]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"},null,-1)])]))],10,P),t("div",W,[t("input",{type:"range",min:0,max:1,step:.001,value:i.ratio,disabled:i.locked||i.disabled,onInput:R,class:A(["range range-primary range-sm w-full",{"opacity-50":i.locked||i.disabled}])},null,42,X)]),t("div",Y,[t("span",{class:A(["badge badge-sm",i.locked?"badge-primary":"badge-outline"])},_(r.value)+"% ",3)])]))}},K={class:"overflow-x-auto"},tt={class:"table table-zebra w-full"},et={class:"text-sm opacity-60"},st={class:"flex flex-col"},ot={class:"font-medium"},at={key:0,class:"text-xs badge badge-primary badge-sm"},rt={class:"text-right font-mono text-sm"},lt={class:"text-right font-mono text-sm"},nt={class:"text-right font-mono text-sm"},it={class:"text-right font-mono text-sm"},ct={class:"text-right font-mono text-sm"},dt={class:"text-right font-mono font-semibold"},ut={class:"bg-base-200 font-bold"},_t={class:"text-right"},ht={class:"text-lg"},vt={class:"text-right"},gt={class:"text-lg"},pt={class:"text-right"},mt={class:"text-lg"},ft={class:"text-right"},kt={class:"text-lg"},yt={class:"text-right"},wt={class:"text-lg"},bt={class:"text-right"},xt={class:"text-lg"},Rt={class:"text-right"},$t={class:"text-lg"},Ct={__name:"DivisionTable",props:{divisions:{type:Array,required:!0},readonly:{type:Boolean,default:!1}},emits:["ratio-change","lock-toggle"],setup(i,{emit:y}){const d=i,c=y,r=n=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(n),R=(n,h)=>{c("ratio-change",n,h)},w=n=>{c("lock-toggle",n)},g=S(()=>!d.divisions||d.divisions.length===0?{totalRatio:0,totalActualSales:0,totalQ1:0,totalQ2:0,totalQ3:0,totalQ4:0,totalAllocated:0}:d.divisions.reduce((n,h)=>(n.totalRatio+=h.effective_ratio||0,n.totalActualSales+=h.total_2025_sales||0,n.totalQ1+=h.q1_allocated||0,n.totalQ2+=h.q2_allocated||0,n.totalQ3+=h.q3_allocated||0,n.totalQ4+=h.q4_allocated||0,n.totalAllocated+=h.total_allocated||0,n),{totalRatio:0,totalActualSales:0,totalQ1:0,totalQ2:0,totalQ3:0,totalQ4:0,totalAllocated:0}));return(n,h)=>(p(),m("div",K,[t("table",tt,[h[1]||(h[1]=t("thead",null,[t("tr",null,[t("th",{class:"w-8"},"#"),t("th",null,"Division"),t("th",{class:"w-80"},"Effective Ratio"),t("th",{class:"text-right"},"2025 Sales"),t("th",{class:"text-right"},"Q1"),t("th",{class:"text-right"},"Q2"),t("th",{class:"text-right"},"Q3"),t("th",{class:"text-right"},"Q4"),t("th",{class:"text-right"},"Total")])],-1)),t("tbody",null,[(p(!0),m(F,null,T(i.divisions,(o,s)=>(p(),m("tr",{key:o.item_division},[t("td",et,_(o.item_division),1),t("td",null,[t("div",st,[t("span",ot,_(o.division_name),1),o.is_custom?(p(),m("span",at," Custom ")):E("",!0)])]),t("td",null,[q(Z,{ratio:o.effective_ratio,locked:o.locked,"division-name":o.division_name,disabled:i.readonly,onRatioChange:a=>R(s,a),onLockToggle:()=>w(s)},null,8,["ratio","locked","division-name","disabled","onRatioChange","onLockToggle"])]),t("td",rt,_(r(o.total_2025_sales)),1),t("td",lt,_(r(o.q1_allocated)),1),t("td",nt,_(r(o.q2_allocated)),1),t("td",it,_(r(o.q3_allocated)),1),t("td",ct,_(r(o.q4_allocated)),1),t("td",dt,_(r(o.total_allocated)),1)]))),128))]),t("tfoot",null,[t("tr",ut,[h[0]||(h[0]=t("td",{colspan:"2",class:"text-right"},[t("span",{class:"text-lg"},"Total")],-1)),t("td",_t,[t("span",ht,_((g.value.totalRatio*100).toFixed(2))+"%",1)]),t("td",vt,[t("span",gt,_(r(g.value.totalActualSales)),1)]),t("td",pt,[t("span",mt,_(r(g.value.totalQ1)),1)]),t("td",ft,[t("span",kt,_(r(g.value.totalQ2)),1)]),t("td",yt,[t("span",wt,_(r(g.value.totalQ3)),1)]),t("td",bt,[t("span",xt,_(r(g.value.totalQ4)),1)]),t("td",Rt,[t("span",$t,_(r(g.value.totalAllocated)),1)])])])])]))}},Dt={class:"card bg-base-100 shadow-xl border border-base-300"},St={class:"card-body"},jt={class:"flex items-center justify-between mb-4"},At={class:"card-title text-lg"},Et={class:"card-actions justify-end mt-4"},qt=["disabled"],Qt=["disabled"],Ft={key:0,class:"alert alert-warning mt-2"},Tt={key:0},Nt={key:1},Ot={__name:"DivisionGroupCard",props:{group:{type:Object,required:!0}},emits:["save-ratios","reset-group"],setup(i,{emit:y}){const d=i,c=y,r=j([]);O(()=>d.group,e=>{e&&e.divisions&&(r.value=e.divisions.map(l=>({...l})))},{immediate:!0});const R=S(()=>r.value.reduce((e,l)=>e+l.effective_ratio,0)),w=S(()=>{const e=R.value;return Math.abs(e-1)<.001?{status:"perfect",icon:"✅",class:"text-success"}:e>1?{status:"over",icon:"⚠️",class:"text-warning"}:{status:"under",icon:"⚠️",class:"text-warning"}}),g=S(()=>r.value.some(e=>e.effective_ratio!==e.division_ratio_2025||e.is_custom)),n=(e,l)=>{const u=r.value.map((v,D)=>({...v,index:D})).filter(v=>!v.locked);if(u.length<=1){r.value[e].effective_ratio=1;return}const C=1-r.value.filter(v=>v.locked).reduce((v,D)=>v+D.effective_ratio,0),b=Math.min(l,C);r.value[e].effective_ratio=b;const f=u.filter(v=>v.index!==e),x=f.reduce((v,D)=>v+D.effective_ratio,0);if(x>0){const D=(C-b)/x;f.forEach(Q=>{r.value[Q.index].effective_ratio=Q.effective_ratio*D})}},h=(e,l)=>{n(e,l)},o=e=>{r.value[e].locked=!r.value[e].locked},s=async()=>{try{await c("save-ratios",d.group.group_key,r.value)}catch(e){console.error("Error saving ratios:",e)}},a=async()=>{try{await c("reset-group",d.group.salesperson_id,d.group.customer_class,d.group.group_key)}catch(e){console.error("Error resetting group:",e)}};return(e,l)=>(p(),m("div",Dt,[t("div",St,[t("div",jt,[t("div",null,[t("h3",At,_(i.group.customer_class)+" › "+_(i.group.salesperson_name)+" › "+_(i.group.display_key),1)])]),q(Ct,{divisions:r.value,readonly:!1,onRatioChange:h,onLockToggle:o},null,8,["divisions"]),t("div",Et,[t("button",{onClick:a,class:"btn btn-ghost btn-sm",disabled:!g.value}," Reset ",8,qt),t("button",{onClick:s,class:"btn btn-primary btn-sm",disabled:!g.value||w.value.status!=="perfect"}," Save Changes ",8,Qt)]),w.value.status!=="perfect"?(p(),m("div",Ft,[l[0]||(l[0]=t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})],-1)),t("span",null,[w.value.status==="over"?(p(),m("span",Tt," Total ratio exceeds 100%. Adjust sliders to balance the ratios. ")):(p(),m("span",Nt," Total ratio is under 100%. Adjust sliders to reach 100%. "))])])):E("",!0)])]))}},Bt={class:"p-6 space-y-6"},Lt={key:0,class:"space-y-6"},Mt={class:"stats shadow mb-6"},Ut={class:"stat"},zt={class:"stat-value text-primary"},Gt={class:"stat"},Vt={class:"stat-value text-secondary"},Ht={class:"stat"},Pt={class:"stat-value text-accent"},It={key:1,class:"alert alert-info"},Xt={__name:"DivisionView",setup(i){const y=L("navActions"),{loading:d,error:c,groupedData:r,fetchDivisionData:R,saveRatios:w,resetGroupOverrides:g,resetAllOverrides:n}=V(),h=async(a,e)=>{try{await w(a,e)}catch(l){console.error("Error saving ratios:",l)}},o=async(a,e,l)=>{try{await g(a,e,l)}catch(u){console.error("Error resetting group overrides:",u)}},s=async()=>{try{await n()}catch(a){console.error("Error resetting overrides:",a)}};return B(()=>{y.set([{id:"reset-all-overrides",text:"Reset All Overrides",class:"btn btn-warning mr-2",handler:s,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>'},{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost",handler:()=>{window.history.back()},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),R()}),M(()=>y.clear()),(a,e)=>(p(),m("div",Bt,[e[4]||(e[4]=U('<div class="hero bg-base-200 rounded-lg"><div class="hero-content text-center"><div class="max-w-4xl"><h1 class="text-5xl font-bold">Division Ratio Management</h1><p class="py-6"> Adjust division ratios for budget allocation. Use sliders to modify ratios and lock divisions to prevent changes. </p></div></div></div>',1)),q(G,{loading:k(d),error:k(c),onRetry:k(R)},null,8,["loading","error","onRetry"]),!k(d)&&!k(c)&&k(r).length>0?(p(),m("div",Lt,[t("div",Mt,[t("div",Ut,[e[0]||(e[0]=t("div",{class:"stat-title"},"Total Groups",-1)),t("div",zt,_(k(r).length),1)]),t("div",Gt,[e[1]||(e[1]=t("div",{class:"stat-title"},"Groups with Custom Ratios",-1)),t("div",Vt,_(k(r).filter(l=>l.hasCustomRatios).length),1)]),t("div",Ht,[e[2]||(e[2]=t("div",{class:"stat-title"},"Total Divisions",-1)),t("div",Pt,_(k(r).reduce((l,u)=>l+u.divisions.length,0)),1)])]),(p(!0),m(F,null,T(k(r),l=>(p(),z(Ot,{key:`${l.salesperson_id}-${l.customer_class}-${l.group_key}`,group:l,onSaveRatios:h,onResetGroup:o},null,8,["group"]))),128))])):!k(d)&&!k(c)&&k(r).length===0?(p(),m("div",It,[...e[3]||(e[3]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",class:"stroke-current shrink-0 w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),t("span",null,"No division data available. Please check your data sources.",-1)])])):E("",!0)]))}};export{Xt as default};
