import{u as L,r as _,c as U,m as E,_ as he,a as Z,b as M,d as le,e as k,F as oe,t as fe,n as ue,l as ce,i as se,o as de,f as ge,w as pe,g as H}from"./index-5HnzLnCl.js";import{A as _e,S as ve}from"./AddCustomBudgetModal-BS0GH3o8.js";function ie(c){const h=L(),{apiCall:g}=h,a=_([]),v=_(!1),u=_(""),d=_(null),y=U(()=>d.value?.is_hospitality||!1),B=async()=>{v.value=!0,u.value="";try{const n=E(c),l=await g(`/api/sales/${n}`);if(!l.ok)throw new Error("Failed to fetch sales data");const j=await l.json();a.value=j.data||[],d.value=j.salesperson_info||null}catch(n){u.value=n.message,console.error("Error fetching sales:",n)}finally{v.value=!1}},m=()=>a.value.reduce((n,l)=>n+(parseFloat(l.q1_sales)||0),0),q=()=>a.value.reduce((n,l)=>n+(parseFloat(l.q2_sales)||0),0),f=()=>a.value.reduce((n,l)=>n+(parseFloat(l.q3_sales)||0),0),b=()=>a.value.reduce((n,l)=>n+(parseFloat(l.q4_sales)||0),0),p=()=>a.value.reduce((n,l)=>n+(parseFloat(l.q4_orders)||0),0),Q=()=>a.value.reduce((n,l)=>n+(parseFloat(l.total_sales)||0),0),P=()=>a.value.reduce((n,l)=>n+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:a,loading:v,error:u,salespersonInfo:d,isHospitality:y,fetchSales:B,getTotalQ1:m,getTotalQ2:q,getTotalQ3:f,getTotalQ4Sales:b,getTotalQ4:p,getTotalSales:Q,getTotalZeroPercent:P,getZeroPercentRate:()=>{const n=Q(),l=P();return n>0?l/n*100:0},getTotalOpen2026:()=>a.value.reduce((n,l)=>n+(parseFloat(l.open_2026)||0),0)}}function me(c){const h=L(),{apiCall:g}=h,a=_(null),v=U(()=>a.value?.is_hospitality||!1),u=_([]),d=_({}),y=_(new Set),B=_(new Set),m=_({}),q=_({customer_classes:[],customer_names:[],brands:[],flags:[]});let f=null;const b=e=>{const t=e.brand||"null",o=e.flag||"null",s=e.customer_name||"null",r=e.customer_class||e.derived_customer_class||"null";return`${t}_${o}_${s}_${r}`},p=(e,t)=>`${b(e)}_${t}`,Q=async()=>{try{const e=E(c),t=await g(`/api/sales/${e}`);if(!t.ok)throw new Error("Failed to fetch salesperson info");const o=await t.json();a.value=o.salesperson_info||null}catch(e){console.error("Error fetching salesperson info:",e)}},P=async()=>{try{await Q();const e=E(c),t=await g(`/api/budget/${e}`);if(!t.ok)throw new Error("Failed to fetch budget data");const o=await t.json();u.value=o.data||[],d.value={},u.value.forEach(s=>{const r=b(s);d.value[r]=s})}catch(e){console.error("Error fetching budgets:",e)}},A=async(e,t,o)=>{const s=p(e,t);y.value.add(s);try{const r=b(e),i=d.value[r],S=E(c);let w=a.value?.salesperson_name;if(!w)try{const O=await g("/api/admin/summary");O.ok&&(w=(await O.json()).data?.find(x=>x.salesperson_id===S)?.salesperson_name)}catch(O){console.error("Error fetching salesperson name from admin summary:",O)}const J={salesperson_id:S,salesperson_name:w||"Unknown",brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:v.value?"Hospitality":e.derived_customer_class||"General",[`quarter_${t}_sales`]:parseFloat(o)||0,is_custom:e.is_custom||!1};let F;if(i?F=await g(`/api/budget/${S}/${i.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(o)||0})}):F=await g(`/api/budget/${S}`,{method:"POST",body:JSON.stringify(J)}),!F.ok)throw new Error("Failed to save budget");const D=await F.json();i?i[`quarter_${t}_sales`]=parseFloat(o)||0:(d.value[r]=D.data,u.value.push(D.data)),B.value.add(s),setTimeout(()=>B.value.delete(s),1e3),T()}catch(r){console.error("Error saving budget:",r)}finally{y.value.delete(s)}},I=(e,t)=>{const o=p(e,t);if(m.value.hasOwnProperty(o))return m.value[o];const s=b(e),r=d.value[s];return r&&r[`quarter_${t}_sales`]||0},n=(e,t)=>{const o=p(e,t);return y.value.has(o)?"bg-blue-50 border-blue-300":B.value.has(o)?"bg-green-50 border-green-300":"hover:bg-gray-50"},l=(e,t,o)=>{f&&clearTimeout(f),f=setTimeout(()=>{o&&o!=="0"&&o!==""&&A(e,t,o)},2e3)},j=(e,t,o)=>{const s=p(t,o),r=e.target.value;m.value[s]=r,T(),l(t,o,r)},G=(e,t,o)=>{const s=e.target.value,r=p(t,o);f&&(clearTimeout(f),f=null),delete m.value[r],T(),A(t,o,s)},W=(e,t,o)=>{const s=p(t,o);m.value[s]=e.target.value,e.key==="Enter"&&e.target.blur()},T=()=>{const e=typeof c=="function"?c():c,t={};Object.keys(m.value).forEach(o=>{const s=m.value[o];s&&s!=="0"&&s!==""&&(t[o]=s)}),localStorage.setItem(`budget_pending_changes_${e}`,JSON.stringify(t))},X=()=>{try{const e=E(c),t=localStorage.getItem(`budget_pending_changes_${e}`);if(t){const o=JSON.parse(t);return Object.keys(o).forEach(s=>{m.value[s]=o[s]}),Object.keys(o).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},Y=()=>{const e=typeof c=="function"?c():c;localStorage.removeItem(`budget_pending_changes_${e}`)},$=async()=>{try{const e=await g("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();q.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},ee=async e=>{try{const t=E(c);let o=a.value?.salesperson_name;if(!o)try{const w=await g("/api/admin/summary");w.ok&&(o=(await w.json()).data?.find(D=>D.salesperson_id===t)?.salesperson_name)}catch(w){console.error("Error fetching salesperson name from admin summary:",w)}const s={...e,salesperson_id:t,salesperson_name:o||"Unknown",customer_class:v.value?"Hospitality":e.customer_class||"General",quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},r=await g(`/api/budget/${t}`,{method:"POST",body:JSON.stringify(s)});if(!r.ok)throw new Error("Failed to create custom budget");const i=await r.json(),S=b(i.data);return d.value[S]=i.data,u.value.push(i.data),i.data}catch(t){throw console.error("Error creating custom budget:",t),t}},te=async e=>{try{const t=E(c);if(!(await g(`/api/budget/${t}/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const s=u.value.findIndex(r=>r.id===e);if(s!==-1){const r=u.value[s],i=b(r);delete d.value[i],u.value.splice(s,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},z=()=>u.value.filter(e=>e.is_custom===!0),N=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),R=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),V=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),K=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0);return{budgets:u,budgetMap:d,savingCells:y,savedCells:B,inputValues:m,autosuggestData:q,salespersonInfo:a,isHospitality:v,fetchBudgets:P,saveBudgetCell:A,getBudgetValue:I,getCellClass:n,handleBudgetChange:j,handleBudgetBlur:G,handleBudgetInput:W,savePendingChangesToStorage:T,loadPendingChangesFromStorage:X,clearPendingChangesFromStorage:Y,fetchAutosuggestData:$,createCustomBudget:ee,deleteCustomBudget:te,getCustomBudgets:z,getTotalQ1Budget:N,getTotalQ2Budget:R,getTotalQ3Budget:V,getTotalQ4Budget:K,getTotalBudget:()=>N()+R()+V()+K(),cleanup:()=>{f&&clearTimeout(f)}}}const ye={__name:"SalespersonView",setup(c,{expose:h}){h();const g=ue(),a=ce(),v=L(),u=U(()=>{const C=g.params.salespersonId;return parseInt(C)}),d=se("addBudgetModal"),y=se("navActions"),{sales:B,loading:m,error:q,salespersonInfo:f,isHospitality:b,fetchSales:p,getTotalQ1:Q,getTotalQ2:P,getTotalQ3:A,getTotalQ4Sales:I,getTotalQ4:n,getTotalSales:l,getTotalZeroPercent:j,getZeroPercentRate:G,getTotalOpen2026:W}=ie(u),{fetchBudgets:T,getBudgetValue:X,getCellClass:Y,handleBudgetChange:$,handleBudgetBlur:ee,handleBudgetInput:te,loadPendingChangesFromStorage:z,fetchAutosuggestData:N,createCustomBudget:R,deleteCustomBudget:V,getCustomBudgets:K,getTotalQ1Budget:ne,getTotalQ2Budget:re,getTotalQ3Budget:e,getTotalQ4Budget:t,getTotalBudget:o,autosuggestData:s,cleanup:r}=me(u),i=()=>{a.push("/admin")},S=async()=>{await p(),await T()},w=()=>{d.open()},J=()=>{d.close()},F=async C=>{console.log("handleCustomBudgetCreated called with:",C);try{await R(C),console.log("Custom budget created successfully")}catch(x){console.error("Error creating custom budget:",x)}},D=async C=>{try{await V(C),console.log("Custom budget deleted successfully")}catch(x){console.error("Error deleting custom budget:",x)}},O=async()=>{await N()};de(async()=>{if(!v.adminStatus){a.push("/");return}await p(),await T(),z()&&console.log("Restored pending budget changes from localStorage"),y.set([{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost mr-2",handler:i,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),window.addEventListener("beforeunload",x=>{})}),ge(()=>{window.removeEventListener("beforeunload",()=>{}),y.clear(),r()});const ae={route:g,router:a,authStore:v,salespersonId:u,addBudgetModal:d,navActions:y,sales:B,loading:m,error:q,salespersonInfo:f,isHospitality:b,fetchSales:p,getTotalQ1:Q,getTotalQ2:P,getTotalQ3:A,getTotalQ4Sales:I,getTotalQ4:n,getTotalSales:l,getTotalZeroPercent:j,getZeroPercentRate:G,getTotalOpen2026:W,fetchBudgets:T,getBudgetValue:X,getCellClass:Y,handleBudgetChange:$,handleBudgetBlur:ee,handleBudgetInput:te,loadPendingChangesFromStorage:z,fetchAutosuggestData:N,createCustomBudget:R,deleteCustomBudget:V,getCustomBudgets:K,getTotalQ1Budget:ne,getTotalQ2Budget:re,getTotalQ3Budget:e,getTotalQ4Budget:t,getTotalBudget:o,autosuggestData:s,cleanup:r,goBack:i,retryFetch:S,openModal:w,closeModal:J,handleCustomBudgetCreated:F,handleDeleteCustomBudget:D,handleFetchAutosuggest:O,onMounted:de,onUnmounted:ge,ref:_,inject:se,computed:U,watch:pe,get useRoute(){return ue},get useRouter(){return ce},get useAuthStore(){return L},get useSalesDataForAdmin(){return ie},get useBudgetDataForAdmin(){return me},SalesTable:ve,AddCustomBudgetModal:_e};return Object.defineProperty(ae,"__isScriptSetup",{enumerable:!1,value:!0}),ae}},be={class:"mx-auto px-4 py-8"},we={key:0,class:"flex justify-center"},Be={class:"alert alert-error"};function Te(c,h,g,a,v,u){return H(),Z("div",be,[M(" Loading State "),a.loading?(H(),Z("div",we,[...h[0]||(h[0]=[k("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):a.error?(H(),Z(oe,{key:1},[M(" Error State "),k("div",Be,[h[1]||(h[1]=k("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[k("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),k("span",null,fe(a.error),1)])],2112)):a.sales.length===0?(H(),Z(oe,{key:2},[M(" Empty State "),h[2]||(h[2]=k("div",{class:"text-center py-8"},[k("p",{class:"text-lg text-base-content/70"},"No sales data found")],-1))],2112)):(H(),Z(oe,{key:3},[M(" Main Content "),k("div",null,[M(" Sales Table "),le(a.SalesTable,{sales:a.sales,"custom-budgets":a.getCustomBudgets(),"get-budget-value":a.getBudgetValue,"get-cell-class":a.getCellClass,"handle-budget-change":a.handleBudgetChange,"handle-budget-blur":a.handleBudgetBlur,"handle-budget-input":a.handleBudgetInput,"handle-delete-custom-budget":a.handleDeleteCustomBudget,"is-hospitality":a.isHospitality,"get-total-q1":a.getTotalQ1,"get-total-q2":a.getTotalQ2,"get-total-q3":a.getTotalQ3,"get-total-q4-sales":a.getTotalQ4Sales,"get-total-q4":a.getTotalQ4,"get-total-sales":a.getTotalSales,"get-total-zero-percent":a.getTotalZeroPercent,"get-zero-percent-rate":a.getZeroPercentRate,"get-total-open-2026":a.getTotalOpen2026,"get-total-q1-budget":a.getTotalQ1Budget,"get-total-q2-budget":a.getTotalQ2Budget,"get-total-q3-budget":a.getTotalQ3Budget,"get-total-q4-budget":a.getTotalQ4Budget,"get-total-budget":a.getTotalBudget},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])],2112)),M(" Custom Budget Modal "),le(a.AddCustomBudgetModal,{"is-open":a.addBudgetModal.isOpen.value,"is-hospitality":a.isHospitality,"autosuggest-data":a.autosuggestData,onClose:a.closeModal,onCreated:a.handleCustomBudgetCreated,onFetchAutosuggest:a.handleFetchAutosuggest},null,8,["is-open","is-hospitality","autosuggest-data"])])}const ke=he(ye,[["render",Te],["__file","G:/ProjectsPARA/Projects/budget-2026/frontend/src/views/SalespersonView.vue"]]);export{ke as default};
