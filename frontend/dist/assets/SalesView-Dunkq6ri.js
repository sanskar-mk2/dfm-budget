import{u as x,r as b,c as U,o as W,a as G,b as F,d as R,e as s,f as E,t as X,i as Y,g as k}from"./index-BNzBhQG3.js";import{_ as ee,a as te}from"./AddCustomBudgetModal-DmIx0ugJ.js";function L(){const _=x(),{apiCall:p}=_,d=b([]),r=b(!1),c=b(""),v=U(()=>(_.currentSalesperson?.role||"").startsWith("Hospitality")),h=async()=>{r.value=!0,c.value="";try{const o=await p("/api/sales");if(!o.ok)throw new Error("Failed to fetch sales data");const l=await o.json();d.value=l.data||[]}catch(o){c.value=o.message,console.error("Error fetching sales:",o)}finally{r.value=!1}},g=()=>d.value.reduce((o,l)=>o+(parseFloat(l.q1_sales)||0),0),w=()=>d.value.reduce((o,l)=>o+(parseFloat(l.q2_sales)||0),0),i=()=>d.value.reduce((o,l)=>o+(parseFloat(l.q3_sales)||0),0),C=()=>d.value.reduce((o,l)=>o+(parseFloat(l.q4_sales)||0),0),y=()=>d.value.reduce((o,l)=>o+(parseFloat(l.total_sales)||0),0),B=()=>d.value.reduce((o,l)=>o+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:d,loading:r,error:c,isHospitality:v,fetchSales:h,getTotalQ1:g,getTotalQ2:w,getTotalQ3:i,getTotalQ4:C,getTotalSales:y,getTotalZeroPercent:B,getZeroPercentRate:()=>{const o=y(),l=B();return o>0?l/o*100:0},getTotalOpen2026:()=>d.value.reduce((o,l)=>o+(parseFloat(l.open_2026)||0),0)}}function ae(){const _=x(),{apiCall:p}=_,{isHospitality:d}=L(),r=b([]),c=b({}),v=b(new Set),h=b(new Set),g=b({}),w=b({customer_classes:[],customer_names:[],brands:[],flags:[]});let i=null;const C=async()=>{try{const e=await p("/api/budget");if(!e.ok)throw new Error("Failed to fetch budget data");const t=await e.json();r.value=t.data||[],c.value={},r.value.forEach(a=>{const n=`${a.brand||"null"}_${a.flag||"null"}_${a.customer_name}`;c.value[n]=a})}catch(e){console.error("Error fetching budgets:",e)}},y=async(e,t,a)=>{const n=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;v.value.add(n);try{if(!_.currentSalesperson)throw new Error("Salesperson data not available");const u=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,S=c.value[u],O={salesperson_id:_.currentSalesperson.salesman_no,salesperson_name:_.currentSalesperson.salesman_name,brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:d.value?"Hospitality":e.derived_customer_class,[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let T;if(S?T=await p(`/api/budget/${S.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):T=await p("/api/budget",{method:"POST",body:JSON.stringify(O)}),!T.ok)throw new Error("Failed to save budget");const f=await T.json();S?S[`quarter_${t}_sales`]=parseFloat(a)||0:(c.value[u]=f.data,r.value.push(f.data)),h.value.add(n),setTimeout(()=>h.value.delete(n),1e3),$()}catch(u){console.error("Error saving budget:",u)}finally{v.value.delete(n)}},B=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;if(g.value.hasOwnProperty(a))return g.value[a];const n=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,u=c.value[n];return u&&u[`quarter_${t}_sales`]||0},q=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;return v.value.has(a)?"bg-blue-50 border-blue-300":h.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},Q=(e,t,a)=>{i&&clearTimeout(i),i=setTimeout(()=>{a&&a!=="0"&&a!==""&&y(e,t,a)},2e3)},o=(e,t,a)=>{const n=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`,u=e.target.value;g.value[n]=u,$(),Q(t,a,u)},l=(e,t,a)=>{const n=e.target.value,u=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;i&&(clearTimeout(i),i=null),delete g.value[u],$(),y(t,a,n)},P=(e,t,a)=>{const n=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;g.value[n]=e.target.value,e.key==="Enter"&&e.target.blur()},$=()=>{const e={};Object.keys(g.value).forEach(t=>{const a=g.value[t];a&&a!=="0"&&a!==""&&(e[t]=a)}),localStorage.setItem("budget_pending_changes",JSON.stringify(e))};return{budgets:r,budgetMap:c,savingCells:v,savedCells:h,inputValues:g,autosuggestData:w,fetchBudgets:C,saveBudgetCell:y,getBudgetValue:B,getCellClass:q,handleBudgetChange:o,handleBudgetBlur:l,handleBudgetInput:P,savePendingChangesToStorage:$,loadPendingChangesFromStorage:()=>{try{const e=localStorage.getItem("budget_pending_changes");if(e){const t=JSON.parse(e);return Object.keys(t).forEach(a=>{g.value[a]=t[a]}),Object.keys(t).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},clearPendingChangesFromStorage:()=>{localStorage.removeItem("budget_pending_changes")},fetchAutosuggestData:async()=>{try{const e=await p("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();w.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},createCustomBudget:async e=>{try{if(!_.currentSalesperson)throw new Error("Salesperson data not available");const t={...e,salesperson_id:_.currentSalesperson.salesman_no,salesperson_name:_.currentSalesperson.salesman_name,customer_class:d.value?"Hospitality":e.customer_class,quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},a=await p("/api/budget",{method:"POST",body:JSON.stringify(t)});if(!a.ok)throw new Error("Failed to create custom budget");const n=await a.json(),u=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}`;return c.value[u]=n.data,r.value.push(n.data),n.data}catch(t){throw console.error("Error creating custom budget:",t),t}},deleteCustomBudget:async e=>{try{if(!(await p(`/api/budget/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const a=r.value.findIndex(n=>n.id===e);if(a!==-1){const n=r.value[a],u=`${n.brand||"null"}_${n.flag||"null"}_${n.customer_name}`;delete c.value[u],r.value.splice(a,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},getCustomBudgets:()=>r.value.filter(e=>e.is_custom===!0),getTotalQ1Budget:()=>r.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),getTotalQ2Budget:()=>r.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),getTotalQ3Budget:()=>r.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),getTotalQ4Budget:()=>r.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0),getTotalBudget:()=>r.value.reduce((e,t)=>e+(parseFloat(t.total_sales)||0),0),cleanup:()=>{i&&clearTimeout(i)}}}const se={class:"mx-auto px-4 py-8"},oe={key:0,class:"flex justify-center"},ne={key:1,class:"alert alert-error"},re={key:2,class:"text-center py-8"},le={key:3},ge={__name:"SalesView",setup(_){const{currentUser:p,currentSalesperson:d}=x(),r=Y("addBudgetModal"),{sales:c,loading:v,error:h,isHospitality:g,fetchSales:w,getTotalQ1:i,getTotalQ2:C,getTotalQ3:y,getTotalQ4:B,getTotalSales:q,getTotalZeroPercent:Q,getZeroPercentRate:o,getTotalOpen2026:l}=L(),{fetchBudgets:P,getBudgetValue:$,getCellClass:j,handleBudgetChange:D,handleBudgetBlur:N,handleBudgetInput:A,loadPendingChangesFromStorage:z,fetchAutosuggestData:H,createCustomBudget:I,deleteCustomBudget:M,getCustomBudgets:V,getTotalQ1Budget:Z,getTotalQ2Budget:J,getTotalQ3Budget:K,getTotalQ4Budget:e,getTotalBudget:t,autosuggestData:a,cleanup:n}=ae(),u=()=>{r.close()},S=async f=>{console.log("handleCustomBudgetCreated called with:",f);try{await I(f),console.log("Custom budget created successfully")}catch(m){console.error("Error creating custom budget:",m)}},O=async f=>{try{await M(f),console.log("Custom budget deleted successfully")}catch(m){console.error("Error deleting custom budget:",m)}},T=async()=>{await H()};return W(async()=>{await w(),await P(),z()&&console.log("Restored pending budget changes from localStorage"),window.addEventListener("beforeunload",m=>{})}),G(()=>{window.removeEventListener("beforeunload",()=>{}),n()}),(f,m)=>(k(),F("div",se,[s(v)?(k(),F("div",oe,[...m[0]||(m[0]=[E("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):s(h)?(k(),F("div",ne,[m[1]||(m[1]=E("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[E("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),E("span",null,X(s(h)),1)])):s(c).length===0?(k(),F("div",re,[...m[2]||(m[2]=[E("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(k(),F("div",le,[R(ee,{sales:s(c),"custom-budgets":s(V)(),"get-budget-value":s($),"get-cell-class":s(j),"handle-budget-change":s(D),"handle-budget-blur":s(N),"handle-budget-input":s(A),"handle-delete-custom-budget":O,"is-hospitality":s(g),"get-total-q1":s(i),"get-total-q2":s(C),"get-total-q3":s(y),"get-total-q4":s(B),"get-total-sales":s(q),"get-total-zero-percent":s(Q),"get-zero-percent-rate":s(o),"get-total-open-2026":s(l),"get-total-q1-budget":s(Z),"get-total-q2-budget":s(J),"get-total-q3-budget":s(K),"get-total-q4-budget":s(e),"get-total-budget":s(t)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),R(te,{"is-open":s(r).isOpen.value,"is-hospitality":s(g),"autosuggest-data":s(a),onClose:u,onCreated:S,onFetchAutosuggest:T},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{ge as default};
