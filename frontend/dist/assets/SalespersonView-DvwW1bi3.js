import{u as W,r as v,c as X,e as s,n as oe,o as ne,l as re,i as te,a as le,b as j,d as ae,f as O,t as ue,g as x}from"./index-B6ztc34b.js";import{_ as ce,a as de}from"./AddCustomBudgetModal-CgFLszP_.js";function ge(g){const P=W(),{apiCall:p}=P,c=v([]),y=v(!1),u=v(""),i=v(null),S=X(()=>i.value?.is_hospitality||!1),T=async()=>{y.value=!0,u.value="";try{const n=s(g),l=await p(`/api/sales/${n}`);if(!l.ok)throw new Error("Failed to fetch sales data");const $=await l.json();c.value=$.data||[],i.value=$.salesperson_info||null}catch(n){u.value=n.message,console.error("Error fetching sales:",n)}finally{y.value=!1}},m=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q1_sales)||0),0),C=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q2_sales)||0),0),f=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q3_sales)||0),0),b=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q4_sales)||0),0),w=()=>c.value.reduce((n,l)=>n+(parseFloat(l.q4_orders)||0),0),q=()=>c.value.reduce((n,l)=>n+(parseFloat(l.total_sales)||0),0),E=()=>c.value.reduce((n,l)=>n+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:c,loading:y,error:u,salespersonInfo:i,isHospitality:S,fetchSales:T,getTotalQ1:m,getTotalQ2:C,getTotalQ3:f,getTotalQ4Sales:b,getTotalQ4:w,getTotalSales:q,getTotalZeroPercent:E,getZeroPercentRate:()=>{const n=q(),l=E();return n>0?l/n*100:0},getTotalOpen2026:()=>c.value.reduce((n,l)=>n+(parseFloat(l.open_2026)||0),0)}}function ie(g){const P=W(),{apiCall:p}=P,c=v(null),y=X(()=>c.value?.is_hospitality||!1),u=v([]),i=v({}),S=v(new Set),T=v(new Set),m=v({}),C=v({customer_classes:[],customer_names:[],brands:[],flags:[]});let f=null;const b=e=>{const t=e.brand||"null",a=e.flag||"null",o=e.customer_name||"null",r=e.customer_class||e.derived_customer_class||"null";return`${t}_${a}_${o}_${r}`},w=(e,t)=>`${b(e)}_${t}`,q=async()=>{try{const e=s(g),t=await p(`/api/sales/${e}`);if(!t.ok)throw new Error("Failed to fetch salesperson info");const a=await t.json();c.value=a.salesperson_info||null}catch(e){console.error("Error fetching salesperson info:",e)}},E=async()=>{try{await q();const e=s(g),t=await p(`/api/budget/${e}`);if(!t.ok)throw new Error("Failed to fetch budget data");const a=await t.json();u.value=a.data||[],i.value={},u.value.forEach(o=>{const r=b(o);i.value[r]=o})}catch(e){console.error("Error fetching budgets:",e)}},F=async(e,t,a)=>{const o=w(e,t);S.value.add(o);try{const r=b(e),h=i.value[r],k=s(g);let B=c.value?.salesperson_name;if(!B)try{const K=await p("/api/admin/summary");K.ok&&(B=(await K.json()).data?.find(se=>se.salesperson_id===k)?.salesperson_name)}catch(K){console.error("Error fetching salesperson name from admin summary:",K)}const _={salesperson_id:k,salesperson_name:B||"Unknown",brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:y.value?"Hospitality":e.derived_customer_class||"General",[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let d;if(h?d=await p(`/api/budget/${k}/${h.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):d=await p(`/api/budget/${k}`,{method:"POST",body:JSON.stringify(_)}),!d.ok)throw new Error("Failed to save budget");const z=await d.json();h?h[`quarter_${t}_sales`]=parseFloat(a)||0:(i.value[r]=z.data,u.value.push(z.data)),T.value.add(o),setTimeout(()=>T.value.delete(o),1e3),Q()}catch(r){console.error("Error saving budget:",r)}finally{S.value.delete(o)}},D=(e,t)=>{const a=w(e,t);if(m.value.hasOwnProperty(a))return m.value[a];const o=b(e),r=i.value[o];return r&&r[`quarter_${t}_sales`]||0},n=(e,t)=>{const a=w(e,t);return S.value.has(a)?"bg-blue-50 border-blue-300":T.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},l=(e,t,a)=>{f&&clearTimeout(f),f=setTimeout(()=>{a&&a!=="0"&&a!==""&&F(e,t,a)},2e3)},$=(e,t,a)=>{const o=w(t,a),r=e.target.value;m.value[o]=r,Q(),l(t,a,r)},V=(e,t,a)=>{const o=e.target.value,r=w(t,a);f&&(clearTimeout(f),f=null),delete m.value[r],Q(),F(t,a,o)},Z=(e,t,a)=>{const o=w(t,a);m.value[o]=e.target.value,e.key==="Enter"&&e.target.blur()},Q=()=>{const e=typeof g=="function"?g():g,t={};Object.keys(m.value).forEach(a=>{const o=m.value[a];o&&o!=="0"&&o!==""&&(t[a]=o)}),localStorage.setItem(`budget_pending_changes_${e}`,JSON.stringify(t))},H=()=>{try{const e=s(g),t=localStorage.getItem(`budget_pending_changes_${e}`);if(t){const a=JSON.parse(t);return Object.keys(a).forEach(o=>{m.value[o]=a[o]}),Object.keys(a).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},I=()=>{const e=typeof g=="function"?g():g;localStorage.removeItem(`budget_pending_changes_${e}`)},J=async()=>{try{const e=await p("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();C.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},U=async e=>{try{const t=s(g);let a=c.value?.salesperson_name;if(!a)try{const B=await p("/api/admin/summary");B.ok&&(a=(await B.json()).data?.find(z=>z.salesperson_id===t)?.salesperson_name)}catch(B){console.error("Error fetching salesperson name from admin summary:",B)}const o={...e,salesperson_id:t,salesperson_name:a||"Unknown",customer_class:y.value?"Hospitality":e.customer_class||"General",quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},r=await p(`/api/budget/${t}`,{method:"POST",body:JSON.stringify(o)});if(!r.ok)throw new Error("Failed to create custom budget");const h=await r.json(),k=b(h.data);return i.value[k]=h.data,u.value.push(h.data),h.data}catch(t){throw console.error("Error creating custom budget:",t),t}},L=async e=>{try{const t=s(g);if(!(await p(`/api/budget/${t}/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const o=u.value.findIndex(r=>r.id===e);if(o!==-1){const r=u.value[o],h=b(r);delete i.value[h],u.value.splice(o,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},G=()=>u.value.filter(e=>e.is_custom===!0),A=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),N=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),R=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),M=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0);return{budgets:u,budgetMap:i,savingCells:S,savedCells:T,inputValues:m,autosuggestData:C,salespersonInfo:c,isHospitality:y,fetchBudgets:E,saveBudgetCell:F,getBudgetValue:D,getCellClass:n,handleBudgetChange:$,handleBudgetBlur:V,handleBudgetInput:Z,savePendingChangesToStorage:Q,loadPendingChangesFromStorage:H,clearPendingChangesFromStorage:I,fetchAutosuggestData:J,createCustomBudget:U,deleteCustomBudget:L,getCustomBudgets:G,getTotalQ1Budget:A,getTotalQ2Budget:N,getTotalQ3Budget:R,getTotalQ4Budget:M,getTotalBudget:()=>A()+N()+R()+M(),cleanup:()=>{f&&clearTimeout(f)}}}const pe={class:"mx-auto px-4 py-8"},me={key:0,class:"flex justify-center"},he={key:1,class:"alert alert-error"},fe={key:2,class:"text-center py-8"},_e={key:3},Be={__name:"SalespersonView",setup(g){const P=oe(),p=re(),c=W(),y=X(()=>{const _=P.params.salespersonId;return parseInt(_)}),u=te("addBudgetModal"),i=te("navActions"),{sales:S,loading:T,error:m,isHospitality:C,fetchSales:f,getTotalQ1:b,getTotalQ2:w,getTotalQ3:q,getTotalQ4Sales:E,getTotalQ4:F,getTotalSales:D,getTotalZeroPercent:n,getZeroPercentRate:l,getTotalOpen2026:$}=ge(y),{fetchBudgets:V,getBudgetValue:Z,getCellClass:Q,handleBudgetChange:H,handleBudgetBlur:I,handleBudgetInput:J,loadPendingChangesFromStorage:U,fetchAutosuggestData:L,createCustomBudget:G,deleteCustomBudget:A,getCustomBudgets:N,getTotalQ1Budget:R,getTotalQ2Budget:M,getTotalQ3Budget:Y,getTotalQ4Budget:ee,getTotalBudget:e,autosuggestData:t,cleanup:a}=ie(y),o=()=>{p.push("/admin")},r=()=>{u.close()},h=async _=>{console.log("handleCustomBudgetCreated called with:",_);try{await G(_),console.log("Custom budget created successfully")}catch(d){console.error("Error creating custom budget:",d)}},k=async _=>{try{await A(_),console.log("Custom budget deleted successfully")}catch(d){console.error("Error deleting custom budget:",d)}},B=async()=>{await L()};return ne(async()=>{if(!c.adminStatus){p.push("/");return}await f(),await V(),U()&&console.log("Restored pending budget changes from localStorage"),i.set([{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost mr-2",handler:o,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),window.addEventListener("beforeunload",d=>{})}),le(()=>{window.removeEventListener("beforeunload",()=>{}),i.clear(),a()}),(_,d)=>(x(),j("div",pe,[s(T)?(x(),j("div",me,[...d[0]||(d[0]=[O("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):s(m)?(x(),j("div",he,[d[1]||(d[1]=O("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[O("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),O("span",null,ue(s(m)),1)])):s(S).length===0?(x(),j("div",fe,[...d[2]||(d[2]=[O("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(x(),j("div",_e,[ae(ce,{sales:s(S),"custom-budgets":s(N)(),"get-budget-value":s(Z),"get-cell-class":s(Q),"handle-budget-change":s(H),"handle-budget-blur":s(I),"handle-budget-input":s(J),"handle-delete-custom-budget":k,"is-hospitality":s(C),"get-total-q1":s(b),"get-total-q2":s(w),"get-total-q3":s(q),"get-total-q4-sales":s(E),"get-total-q4":s(F),"get-total-sales":s(D),"get-total-zero-percent":s(n),"get-zero-percent-rate":s(l),"get-total-open-2026":s($),"get-total-q1-budget":s(R),"get-total-q2-budget":s(M),"get-total-q3-budget":s(Y),"get-total-q4-budget":s(ee),"get-total-budget":s(e)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4-sales","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),ae(de,{"is-open":s(u).isOpen.value,"is-hospitality":s(C),"autosuggest-data":s(t),onClose:r,onCreated:h,onFetchAutosuggest:B},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{Be as default};
