import{u as U,r as v,c as Y,e as s,n as ae,o as oe,m as se,i as W,a as ne,b as Q,d as X,f as O,t as re,g as j}from"./index-BNzBhQG3.js";import{_ as le,a as ue}from"./AddCustomBudgetModal-DmIx0ugJ.js";function ee(d){const q=U(),{apiCall:_}=q,i=v([]),y=v(!1),u=v(""),g=v(null),$=Y(()=>g.value?.is_hospitality||!1),w=async()=>{y.value=!0,u.value="";try{const n=s(d),l=await _(`/api/sales/${n}`);if(!l.ok)throw new Error("Failed to fetch sales data");const E=await l.json();i.value=E.data||[],g.value=E.salesperson_info||null}catch(n){u.value=n.message,console.error("Error fetching sales:",n)}finally{y.value=!1}},m=()=>i.value.reduce((n,l)=>n+(parseFloat(l.q1_sales)||0),0),k=()=>i.value.reduce((n,l)=>n+(parseFloat(l.q2_sales)||0),0),h=()=>i.value.reduce((n,l)=>n+(parseFloat(l.q3_sales)||0),0),P=()=>i.value.reduce((n,l)=>n+(parseFloat(l.q4_sales)||0),0),B=()=>i.value.reduce((n,l)=>n+(parseFloat(l.total_sales)||0),0),C=()=>i.value.reduce((n,l)=>n+(parseFloat(l.zero_perc_sales_total)||0),0);return{sales:i,loading:y,error:u,salespersonInfo:g,isHospitality:$,fetchSales:w,getTotalQ1:m,getTotalQ2:k,getTotalQ3:h,getTotalQ4:P,getTotalSales:B,getTotalZeroPercent:C,getZeroPercentRate:()=>{const n=B(),l=C();return n>0?l/n*100:0},getTotalOpen2026:()=>i.value.reduce((n,l)=>n+(parseFloat(l.open_2026)||0),0)}}function ce(d){const q=U(),{apiCall:_}=q,{isHospitality:i,salespersonInfo:y}=ee(d),u=v([]),g=v({}),$=v(new Set),w=v(new Set),m=v({}),k=v({customer_classes:[],customer_names:[],brands:[],flags:[]});let h=null;const P=async()=>{try{const e=s(d),t=await _(`/api/budget/${e}`);if(!t.ok)throw new Error("Failed to fetch budget data");const a=await t.json();u.value=a.data||[],g.value={},u.value.forEach(o=>{const r=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;g.value[r]=o})}catch(e){console.error("Error fetching budgets:",e)}},B=async(e,t,a)=>{const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;$.value.add(o);try{const r=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,f=g.value[r],T=s(d);let b=y.value?.salesperson_name;if(!b)try{const c=await _("/api/admin/summary");c.ok&&(b=(await c.json()).data?.find(te=>te.salesperson_id===T)?.salesperson_name)}catch(c){console.error("Error fetching salesperson name from admin summary:",c)}const z={salesperson_id:T,salesperson_name:b||"Unknown",brand:e.brand,flag:e.flag,customer_name:e.customer_name,customer_class:i.value?"Hospitality":e.derived_customer_class||"General",[`quarter_${t}_sales`]:parseFloat(a)||0,is_custom:e.is_custom||!1};let S;if(f?S=await _(`/api/budget/${T}/${f.id}`,{method:"PUT",body:JSON.stringify({[`quarter_${t}_sales`]:parseFloat(a)||0})}):S=await _(`/api/budget/${T}`,{method:"POST",body:JSON.stringify(z)}),!S.ok)throw new Error("Failed to save budget");const p=await S.json();f?f[`quarter_${t}_sales`]=parseFloat(a)||0:(g.value[r]=p.data,u.value.push(p.data)),w.value.add(o),setTimeout(()=>w.value.delete(o),1e3),F()}catch(r){console.error("Error saving budget:",r)}finally{$.value.delete(o)}},C=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;if(m.value.hasOwnProperty(a))return m.value[a];const o=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}`,r=g.value[o];return r&&r[`quarter_${t}_sales`]||0},x=(e,t)=>{const a=`${e.brand||"null"}_${e.flag||"null"}_${e.customer_name}_${t}`;return $.value.has(a)?"bg-blue-50 border-blue-300":w.value.has(a)?"bg-green-50 border-green-300":"hover:bg-gray-50"},D=(e,t,a)=>{h&&clearTimeout(h),h=setTimeout(()=>{a&&a!=="0"&&a!==""&&B(e,t,a)},2e3)},n=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`,r=e.target.value;m.value[o]=r,F(),D(t,a,r)},l=(e,t,a)=>{const o=e.target.value,r=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;h&&(clearTimeout(h),h=null),delete m.value[r],F(),B(t,a,o)},E=(e,t,a)=>{const o=`${t.brand||"null"}_${t.flag||"null"}_${t.customer_name}_${a}`;m.value[o]=e.target.value,e.key==="Enter"&&e.target.blur()},F=()=>{const e=typeof d=="function"?d():d,t={};Object.keys(m.value).forEach(a=>{const o=m.value[a];o&&o!=="0"&&o!==""&&(t[a]=o)}),localStorage.setItem(`budget_pending_changes_${e}`,JSON.stringify(t))},V=()=>{try{const e=s(d),t=localStorage.getItem(`budget_pending_changes_${e}`);if(t){const a=JSON.parse(t);return Object.keys(a).forEach(o=>{m.value[o]=a[o]}),Object.keys(a).length>0}}catch(e){console.error("Error loading pending changes:",e)}return!1},Z=()=>{const e=typeof d=="function"?d():d;localStorage.removeItem(`budget_pending_changes_${e}`)},H=async()=>{try{const e=await _("/api/budget/autosuggest");if(!e.ok)throw new Error("Failed to fetch autosuggest data");const t=await e.json();k.value=t.data}catch(e){console.error("Error fetching autosuggest data:",e)}},J=async e=>{try{const t=s(d);let a=y.value?.salesperson_name;if(!a)try{const b=await _("/api/admin/summary");b.ok&&(a=(await b.json()).data?.find(p=>p.salesperson_id===t)?.salesperson_name)}catch(b){console.error("Error fetching salesperson name from admin summary:",b)}const o={...e,salesperson_id:t,salesperson_name:a||"Unknown",customer_class:i.value?"Hospitality":e.customer_class||"General",quarter_1_sales:0,quarter_2_sales:0,quarter_3_sales:0,quarter_4_sales:0,is_custom:!0},r=await _(`/api/budget/${t}`,{method:"POST",body:JSON.stringify(o)});if(!r.ok)throw new Error("Failed to create custom budget");const f=await r.json(),T=`${o.brand||"null"}_${o.flag||"null"}_${o.customer_name}`;return g.value[T]=f.data,u.value.push(f.data),f.data}catch(t){throw console.error("Error creating custom budget:",t),t}},I=async e=>{try{const t=s(d);if(!(await _(`/api/budget/${t}/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete custom budget");const o=u.value.findIndex(r=>r.id===e);if(o!==-1){const r=u.value[o],f=`${r.brand||"null"}_${r.flag||"null"}_${r.customer_name}`;delete g.value[f],u.value.splice(o,1)}return!0}catch(t){throw console.error("Error deleting custom budget:",t),t}},K=()=>u.value.filter(e=>e.is_custom===!0),A=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_1_sales)||0),0),N=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_2_sales)||0),0),R=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_3_sales)||0),0),M=()=>u.value.reduce((e,t)=>e+(parseFloat(t.quarter_4_sales)||0),0);return{budgets:u,budgetMap:g,savingCells:$,savedCells:w,inputValues:m,autosuggestData:k,fetchBudgets:P,saveBudgetCell:B,getBudgetValue:C,getCellClass:x,handleBudgetChange:n,handleBudgetBlur:l,handleBudgetInput:E,savePendingChangesToStorage:F,loadPendingChangesFromStorage:V,clearPendingChangesFromStorage:Z,fetchAutosuggestData:H,createCustomBudget:J,deleteCustomBudget:I,getCustomBudgets:K,getTotalQ1Budget:A,getTotalQ2Budget:N,getTotalQ3Budget:R,getTotalQ4Budget:M,getTotalBudget:()=>A()+N()+R()+M(),cleanup:()=>{h&&clearTimeout(h)}}}const de={class:"mx-auto px-4 py-8"},ge={key:0,class:"flex justify-center"},ie={key:1,class:"alert alert-error"},me={key:2,class:"text-center py-8"},_e={key:3},ve={__name:"SalespersonView",setup(d){const q=ae(),_=se(),i=U(),y=Y(()=>{const p=q.params.salespersonId;return parseInt(p)}),u=W("addBudgetModal"),g=W("navActions"),{sales:$,loading:w,error:m,isHospitality:k,fetchSales:h,getTotalQ1:P,getTotalQ2:B,getTotalQ3:C,getTotalQ4:x,getTotalSales:D,getTotalZeroPercent:n,getZeroPercentRate:l,getTotalOpen2026:E}=ee(y),{fetchBudgets:F,getBudgetValue:V,getCellClass:Z,handleBudgetChange:H,handleBudgetBlur:J,handleBudgetInput:I,loadPendingChangesFromStorage:K,fetchAutosuggestData:A,createCustomBudget:N,deleteCustomBudget:R,getCustomBudgets:M,getTotalQ1Budget:L,getTotalQ2Budget:G,getTotalQ3Budget:e,getTotalQ4Budget:t,getTotalBudget:a,autosuggestData:o,cleanup:r}=ce(y),f=()=>{_.push("/admin")},T=()=>{u.close()},b=async p=>{console.log("handleCustomBudgetCreated called with:",p);try{await N(p),console.log("Custom budget created successfully")}catch(c){console.error("Error creating custom budget:",c)}},z=async p=>{try{await R(p),console.log("Custom budget deleted successfully")}catch(c){console.error("Error deleting custom budget:",c)}},S=async()=>{await A()};return oe(async()=>{if(!i.adminStatus){_.push("/");return}await h(),await F(),K()&&console.log("Restored pending budget changes from localStorage"),g.set([{id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost mr-2",handler:f,icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'}]),window.addEventListener("beforeunload",c=>{})}),ne(()=>{window.removeEventListener("beforeunload",()=>{}),g.clear(),r()}),(p,c)=>(j(),Q("div",de,[s(w)?(j(),Q("div",ge,[...c[0]||(c[0]=[O("div",{class:"loading loading-spinner loading-lg"},null,-1)])])):s(m)?(j(),Q("div",ie,[c[1]||(c[1]=O("svg",{xmlns:"http://www.w3.org/2000/svg",class:"stroke-current shrink-0 h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[O("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),O("span",null,re(s(m)),1)])):s($).length===0?(j(),Q("div",me,[...c[2]||(c[2]=[O("p",{class:"text-lg text-base-content/70"},"No sales data found",-1)])])):(j(),Q("div",_e,[X(le,{sales:s($),"custom-budgets":s(M)(),"get-budget-value":s(V),"get-cell-class":s(Z),"handle-budget-change":s(H),"handle-budget-blur":s(J),"handle-budget-input":s(I),"handle-delete-custom-budget":z,"is-hospitality":s(k),"get-total-q1":s(P),"get-total-q2":s(B),"get-total-q3":s(C),"get-total-q4":s(x),"get-total-sales":s(D),"get-total-zero-percent":s(n),"get-zero-percent-rate":s(l),"get-total-open-2026":s(E),"get-total-q1-budget":s(L),"get-total-q2-budget":s(G),"get-total-q3-budget":s(e),"get-total-q4-budget":s(t),"get-total-budget":s(a)},null,8,["sales","custom-budgets","get-budget-value","get-cell-class","handle-budget-change","handle-budget-blur","handle-budget-input","is-hospitality","get-total-q1","get-total-q2","get-total-q3","get-total-q4","get-total-sales","get-total-zero-percent","get-zero-percent-rate","get-total-open-2026","get-total-q1-budget","get-total-q2-budget","get-total-q3-budget","get-total-q4-budget","get-total-budget"])])),X(ue,{"is-open":s(u).isOpen.value,"is-hospitality":s(k),"autosuggest-data":s(o),onClose:T,onCreated:b,onFetchAutosuggest:S},null,8,["is-open","is-hospitality","autosuggest-data"])]))}};export{ve as default};
