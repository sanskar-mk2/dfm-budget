import{u as U,r as M,c as B,s as Y,w as z,b as k,g as q,f as e,t as d,h as A,k as T,F as N,j as L,A as X,o as Z,a as ee,i as te,d as O,e as w}from"./index-B6ztc34b.js";import{_ as se,d as ae,f as g}from"./downloadUtils-_K93Qbmf.js";function le(){const S=U(),P=M(!1),o=M([]),m=B(()=>{const s={};for(const t of o.value){const u=`${t.salesperson_id}-${t.customer_class}-${t.group_key}`;s[u]||(s[u]={salesperson_id:t.salesperson_id,salesperson_name:t.salesperson_name,customer_class:t.customer_class,group_key:t.group_key,brand:t.brand,display_key:t.customer_class==="Hospitality"&&t.brand?`${t.group_key} (${t.brand})`:t.group_key,effective_gp_percent:t.effective_gp_percent,is_custom:t.is_custom,quarters:[{label:"Q1",sales_2025:t.q1_sales_2025,sales:t.quarter_1_sales,gp_percent:t.q1_gp_percent,effective_gp_percent:t.q1_effective_gp_percent||t.q1_gp_percent||t.effective_gp_percent,gp_value:t.q1_gp_value},{label:"Q2",sales_2025:t.q2_sales_2025,sales:t.quarter_2_sales,gp_percent:t.q2_gp_percent,effective_gp_percent:t.q2_effective_gp_percent||t.q2_gp_percent||t.effective_gp_percent,gp_value:t.q2_gp_value},{label:"Q3",sales_2025:t.q3_sales_2025,sales:t.quarter_3_sales,gp_percent:t.q3_gp_percent,effective_gp_percent:t.q3_effective_gp_percent||t.q3_gp_percent||t.effective_gp_percent,gp_value:t.q3_gp_value},{label:"Q4",sales_2025:t.q4_sales_2025,sales:t.quarter_4_sales,gp_percent:t.q4_gp_percent,effective_gp_percent:t.q4_effective_gp_percent||t.q4_gp_percent||t.effective_gp_percent,gp_value:t.q4_gp_value}]})}return Object.values(s)});async function f(){P.value=!0;const t=await(await S.apiCall("/api/gross-profit")).json();o.value=t.data||[],P.value=!1}async function $(s,t,u){const y=await S.apiCall(`/api/gross-profit/${s}/${encodeURIComponent(t)}/${encodeURIComponent(u)}`);if(!y.ok)throw new Error("Failed to fetch group");return(await y.json()).data||[]}async function R(s){const t={salesperson_id:s.salesperson_id,salesperson_name:s.salesperson_name,customer_class:s.customer_class,group_key:s.group_key},u=(c,Q)=>{if(!c||c.effective_gp_percent===null||c.effective_gp_percent===void 0)return;const h=c.gp_percent,j=s.effective_gp_percent,I=h??j,V=c.effective_gp_percent||0;Math.abs(V-(I||0))>.001?t[`custom_q${Q}_gp_percent`]=Math.min(Math.max(V,0),1):s.is_custom&&(t[`custom_q${Q}_gp_percent`]=null)},y=s.quarters.find(c=>c.label==="Q1");u(y,1);const _=s.quarters.find(c=>c.label==="Q2");u(_,2);const x=s.quarters.find(c=>c.label==="Q3");u(x,3);const a=s.quarters.find(c=>c.label==="Q4");u(a,4);const i=[t];await S.apiCall("/api/gross-profit/save-overrides",{method:"POST",body:JSON.stringify({overrides:i})});const p=await $(s.salesperson_id,s.customer_class,s.group_key),b=[...o.value];if(b.filter(c=>c.group_key===s.group_key&&c.salesperson_id===s.salesperson_id).length>0){const c=b.findIndex(h=>h.group_key===s.group_key&&h.salesperson_id===s.salesperson_id),Q=b.filter(h=>!(h.group_key===s.group_key&&h.salesperson_id===s.salesperson_id));Q.splice(c,0,...p),o.value=Q}else o.value=[...o.value.filter(c=>!(c.group_key===s.group_key&&c.salesperson_id===s.salesperson_id)),...p]}async function C(s){await S.apiCall(`/api/gross-profit/reset/${s.salesperson_id}/${encodeURIComponent(s.customer_class)}/${encodeURIComponent(s.group_key)}`,{method:"DELETE"});const t=await $(s.salesperson_id,s.customer_class,s.group_key),u=[...o.value];if(u.filter(_=>_.group_key===s.group_key&&_.salesperson_id===s.salesperson_id).length>0){const _=u.findIndex(a=>a.group_key===s.group_key&&a.salesperson_id===s.salesperson_id),x=u.filter(a=>!(a.group_key===s.group_key&&a.salesperson_id===s.salesperson_id));x.splice(_,0,...t),o.value=x}else o.value=[...o.value.filter(_=>!(_.group_key===s.group_key&&_.salesperson_id===s.salesperson_id)),...t]}async function E(){await S.apiCall("/api/gross-profit/reset-all",{method:"DELETE"});const s=m.value.filter(_=>_.is_custom),t=s.map(_=>$(_.salesperson_id,_.customer_class,_.group_key)),u=await Promise.all(t);let y=[...o.value];s.forEach((_,x)=>{const a=u[x];y=y.filter(i=>!(i.group_key===_.group_key&&i.salesperson_id===_.salesperson_id)),y.push(...a)}),o.value=y}return{grouped:m,fetch:f,save:R,reset:C,resetAll:E,loading:P}}const ne={class:"card bg-base-100 shadow-xl border border-base-300 transition-all duration-200 hover:shadow-2xl"},oe={class:"card-body"},re={class:"flex items-center justify-between mb-4"},ie={class:"card-title text-lg"},_e={class:"flex items-center gap-2"},ce=["disabled"],pe=["disabled"],ue={key:0,class:"loading loading-spinner loading-xs"},de={class:"overflow-x-auto"},fe={class:"table w-full text-sm"},ve={class:"font-medium"},ge=["value","onInput","onBlur"],me={class:"font-mono"},ye={class:"mt-4 pt-4 border-t border-base-300"},be={class:"flex items-center justify-between text-sm"},he={class:"opacity-70"},ke={key:0,class:"badge badge-sm badge-primary mr-2"},qe={class:"font-mono opacity-70"},xe={__name:"GrossProfitGroupCard",props:{group:Object,onSave:Function,onReset:Function},emits:["collapse"],setup(S,{emit:P}){const o=S,m=M(!1),f=Y({...o.group,quarters:o.group.quarters.map(a=>({...a}))}),$=M(o.group.quarters.map(a=>({label:a.label,effective_gp_percent:a.effective_gp_percent})));z(()=>o.group,a=>{Object.assign(f,{...a,quarters:a.quarters.map(i=>({...i}))}),m.value||($.value=a.quarters.map(i=>({label:i.label,effective_gp_percent:i.effective_gp_percent})))},{deep:!0});const R=B(()=>{for(let a=0;a<f.quarters.length;a++){const i=f.quarters[a].effective_gp_percent,p=$.value.find(b=>b.label===f.quarters[a].label);if(p&&Math.abs((i||0)-(p.effective_gp_percent||0))>.001)return!0}return!1}),C=B(()=>f.is_custom||R.value);async function E(){m.value=!0;try{await o.onSave(f),$.value=f.quarters.map(a=>({label:a.label,effective_gp_percent:a.effective_gp_percent}))}finally{m.value=!1}}async function s(){m.value=!0;try{await o.onReset(f),$.value=f.quarters.map(a=>({label:a.label,effective_gp_percent:a.effective_gp_percent}))}finally{m.value=!1}}function t(a){return a==null?"-":(a*100).toFixed(1)+"%"}function u(a){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(a||0)}function y(a){return a==null||a===void 0?"":(a*100).toFixed(1)}function _(a){if(!a||a==="")return null;const i=parseFloat(a);return isNaN(i)?null:Math.min(Math.max(i/100,0),1)}function x(a,i){const p=_(i);a.effective_gp_percent=p,p!==null&&a.sales!==null&&a.sales!==void 0&&(a.gp_value=Math.round(a.sales*p*100)/100)}return(a,i)=>(q(),k("div",ne,[e("div",oe,[e("div",re,[e("h3",ie,d(f.customer_class)+" › "+d(f.salesperson_name)+" › "+d(f.display_key),1),e("div",_e,[e("button",{class:"btn btn-sm btn-ghost",disabled:m.value||!C.value,onClick:s}," Reset ",8,ce),e("button",{class:"btn btn-sm btn-primary",disabled:m.value||!R.value,onClick:E},[m.value?(q(),k("span",ue)):A("",!0),i[0]||(i[0]=T(" Save Changes ",-1))],8,pe)])]),e("div",de,[e("table",fe,[i[2]||(i[2]=e("thead",null,[e("tr",null,[e("th",null,"Quarter"),e("th",null,"2025 Sales"),e("th",null,"2026 Budget"),e("th",null,"Historical GP%"),e("th",null,"Effective GP%"),e("th",null,"GP $ (Est.)")])],-1)),e("tbody",null,[(q(!0),k(N,null,L(f.quarters,p=>(q(),k("tr",{key:p.label},[e("td",ve,d(p.label),1),e("td",null,d(u(p.sales_2025)),1),e("td",null,d(u(p.sales)),1),e("td",null,d(t(p.gp_percent)),1),e("td",null,[e("input",{type:"number",step:"0.1",min:"0",max:"100",value:y(p.effective_gp_percent),onInput:b=>x(p,b.target.value),onBlur:b=>x(p,b.target.value),class:"input input-bordered input-sm w-20 text-right font-mono",placeholder:"0.0"},null,40,ge),i[1]||(i[1]=e("span",{class:"text-xs opacity-60 ml-1"},"%",-1))]),e("td",me,d(u(p.gp_value)),1)]))),128))])])]),e("div",ye,[e("div",be,[e("span",he,[f.is_custom?(q(),k("span",ke,"Has Custom Overrides")):A("",!0),i[3]||(i[3]=T(" Full-Year Effective GP% (Reference): ",-1))]),e("span",qe,d(t(f.effective_gp_percent)),1)])])])]))}},we={class:"p-6 space-y-6"},$e={key:0,class:"stats shadow mb-6"},Ge={class:"stat"},Se={class:"stat-value text-primary"},Ce={class:"stat"},Pe={class:"stat-value text-secondary"},Qe={class:"stat"},Fe={class:"stat-value text-accent"},Re={key:1},Ve={class:"overflow-x-auto"},Ee={class:"table table-zebra w-full"},De=["onClick"],Ae={class:"font-semibold"},Be={class:"text-xs opacity-70"},Ie={class:"text-right font-mono"},Me={class:"text-right font-mono"},je={class:"text-right font-mono"},He={class:"text-right font-mono font-semibold"},Ne={key:0},Te={colspan:"100%"},Oe={key:2,class:"alert alert-info"},ze={__name:"GrossProfitView",setup(S){const P=te("navActions"),{grouped:o,fetch:m,save:f,reset:$,resetAll:R,loading:C}=le(),E=U(),{adminStatus:s,superadminStatus:t}=X(E),y={id:"reset-all-overrides",text:"Reset All Overrides",class:"btn btn-warning mr-2",handler:async()=>{try{await R()}catch(l){console.error("Error resetting all overrides:",l)}},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>'},_={id:"back-to-admin",text:"Back to Admin",class:"btn btn-ghost",handler:()=>{window.history.back()},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>'},x=()=>o.value?.length?o.value.map(l=>{const r=l.quarters.find(F=>F.label==="Q1"),n=l.quarters.find(F=>F.label==="Q2"),v=l.quarters.find(F=>F.label==="Q3"),G=l.quarters.find(F=>F.label==="Q4"),K=(r?.sales_2025||0)+(n?.sales_2025||0)+(v?.sales_2025||0)+(G?.sales_2025||0),J=(r?.sales||0)+(n?.sales||0)+(v?.sales||0)+(G?.sales||0),W=(r?.gp_value||0)+(n?.gp_value||0)+(v?.gp_value||0)+(G?.gp_value||0);return{salesperson_name:l.salesperson_name,salesperson_id:l.salesperson_id,customer_class:l.customer_class,group_key:l.group_key,brand:l.brand||"",q1_2025_sales:g(r?.sales_2025||0),q2_2025_sales:g(n?.sales_2025||0),q3_2025_sales:g(v?.sales_2025||0),q4_2025_sales:g(G?.sales_2025||0),total_2025_sales:g(K),q1_2026_budget:g(r?.sales||0),q2_2026_budget:g(n?.sales||0),q3_2026_budget:g(v?.sales||0),q4_2026_budget:g(G?.sales||0),total_2026_budget:g(J),q1_historical_gp_percent:r?.gp_percent!=null?(r.gp_percent*100).toFixed(2)+"%":"",q2_historical_gp_percent:n?.gp_percent!=null?(n.gp_percent*100).toFixed(2)+"%":"",q3_historical_gp_percent:v?.gp_percent!=null?(v.gp_percent*100).toFixed(2)+"%":"",q4_historical_gp_percent:G?.gp_percent!=null?(G.gp_percent*100).toFixed(2)+"%":"",q1_effective_gp_percent:r?.effective_gp_percent!=null?(r.effective_gp_percent*100).toFixed(2)+"%":"",q2_effective_gp_percent:n?.effective_gp_percent!=null?(n.effective_gp_percent*100).toFixed(2)+"%":"",q3_effective_gp_percent:v?.effective_gp_percent!=null?(v.effective_gp_percent*100).toFixed(2)+"%":"",q4_effective_gp_percent:G?.effective_gp_percent!=null?(G.effective_gp_percent*100).toFixed(2)+"%":"",full_year_effective_gp_percent:l.effective_gp_percent!=null?(l.effective_gp_percent*100).toFixed(2)+"%":"",q1_gp_value:g(r?.gp_value||0),q2_gp_value:g(n?.gp_value||0),q3_gp_value:g(v?.gp_value||0),q4_gp_value:g(G?.gp_value||0),total_gp_value:g(W),has_custom_overrides:l.is_custom?"Yes":"No"}}):[],a=()=>[{key:"salesperson_name",label:"Salesperson Name"},{key:"salesperson_id",label:"Salesperson ID"},{key:"customer_class",label:"Customer Class"},{key:"group_key",label:"Group Key"},{key:"brand",label:"Brand"},{key:"q1_2025_sales",label:"Q1 2025 Sales"},{key:"q2_2025_sales",label:"Q2 2025 Sales"},{key:"q3_2025_sales",label:"Q3 2025 Sales"},{key:"q4_2025_sales",label:"Q4 2025 Sales"},{key:"total_2025_sales",label:"Total 2025 Sales"},{key:"q1_2026_budget",label:"Q1 2026 Budget"},{key:"q2_2026_budget",label:"Q2 2026 Budget"},{key:"q3_2026_budget",label:"Q3 2026 Budget"},{key:"q4_2026_budget",label:"Q4 2026 Budget"},{key:"total_2026_budget",label:"Total 2026 Budget"},{key:"q1_historical_gp_percent",label:"Q1 Historical GP%"},{key:"q2_historical_gp_percent",label:"Q2 Historical GP%"},{key:"q3_historical_gp_percent",label:"Q3 Historical GP%"},{key:"q4_historical_gp_percent",label:"Q4 Historical GP%"},{key:"q1_effective_gp_percent",label:"Q1 Effective GP%"},{key:"q2_effective_gp_percent",label:"Q2 Effective GP%"},{key:"q3_effective_gp_percent",label:"Q3 Effective GP%"},{key:"q4_effective_gp_percent",label:"Q4 Effective GP%"},{key:"full_year_effective_gp_percent",label:"Full Year Effective GP%"},{key:"q1_gp_value",label:"Q1 GP Value"},{key:"q2_gp_value",label:"Q2 GP Value"},{key:"q3_gp_value",label:"Q3 GP Value"},{key:"q4_gp_value",label:"Q4 GP Value"},{key:"total_gp_value",label:"Total GP Value"},{key:"has_custom_overrides",label:"Has Custom Overrides"}],p={id:"export-csv",text:"Export to CSV",class:"btn btn-primary mr-2",handler:()=>{const l=x();if(!l.length){alert("No data available to export");return}const r=a(),n=`gross_profit_${new Date().toISOString().split("T")[0]}.csv`;ae(l,r,n)},icon:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>'},b=()=>{const l=[];(s.value||t.value)&&l.push(p),t.value&&l.push(y),(s.value||t.value)&&l.push(_),P.set(l)};z([s,t],()=>b(),{immediate:!0});const D=Y({}),c=l=>`${l.salesperson_id}-${l.customer_class}-${l.group_key}`,Q=l=>({...l.quarters.reduce((n,v)=>(n.sales2025+=v.sales_2025||0,n.budget2026+=v.sales||0,n.gpValue+=v.gp_value||0,n),{sales2025:0,budget2026:0,gpValue:0}),effectiveGp:l.effective_gp_percent||0}),h=B(()=>o.value?.length?o.value.map(l=>({key:c(l),group:l,summary:Q(l)})):[]),j=B(()=>o.value?.length?o.value.reduce((r,n)=>r+(n.effective_gp_percent||0),0)/o.value.length:0),I=l=>{D[l]=!D[l]},V=l=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(l||0),H=l=>`${((l||0)*100).toFixed(1)}%`;return Z(()=>{b(),m()}),ee(()=>P.clear()),(l,r)=>(q(),k("div",we,[O(se,{loading:w(C),error:null,onRetry:w(m)},null,8,["loading","onRetry"]),!w(C)&&w(o).length>0?(q(),k("div",$e,[r[3]||(r[3]=e("div",{class:"stat"},[e("div",{class:"stat-title"},"Module"),e("div",{class:"stat-value text-primary"}," Gross Profit Management ")],-1)),e("div",Ge,[r[0]||(r[0]=e("div",{class:"stat-title"},"Total Groups",-1)),e("div",Se,d(w(o).length),1)]),e("div",Ce,[r[1]||(r[1]=e("div",{class:"stat-title"},"Groups with Custom GP%",-1)),e("div",Pe,d(w(o).filter(n=>n.is_custom).length),1)]),e("div",Qe,[r[2]||(r[2]=e("div",{class:"stat-title"},"Average GP%",-1)),e("div",Fe,d(H(j.value)),1)])])):A("",!0),!w(C)&&h.value.length>0?(q(),k("div",Re,[e("div",Ve,[e("table",Ee,[r[4]||(r[4]=e("thead",null,[e("tr",null,[e("th",{class:"w-20"},"Action"),e("th",null,"Group"),e("th",{class:"text-right"},"2025 Sales"),e("th",{class:"text-right"},"2026 Budget"),e("th",{class:"text-right"},"Historical GP%"),e("th",{class:"text-right"},"GP $ Est.")])],-1)),e("tbody",null,[(q(!0),k(N,null,L(h.value,n=>(q(),k(N,{key:n.key},[e("tr",null,[e("td",null,[e("button",{class:"btn btn-outline btn-xs",type:"button",onClick:v=>I(n.key)},d(D[n.key]?"Collapse":"Expand"),9,De)]),e("td",null,[e("div",Ae,d(n.group.display_key),1),e("div",Be,d(n.group.customer_class)+" - "+d(n.group.salesperson_name),1)]),e("td",Ie,d(V(n.summary.sales2025)),1),e("td",Me,d(V(n.summary.budget2026)),1),e("td",je,d(H(n.summary.effectiveGp)),1),e("td",He,d(V(n.summary.gpValue)),1)]),D[n.key]?(q(),k("tr",Ne,[e("td",Te,[O(xe,{group:n.group,onSave:w(f),onReset:w($),onCollapse:v=>I(n.key)},null,8,["group","onSave","onReset","onCollapse"])])])):A("",!0)],64))),128))])])])])):!w(C)&&w(o).length===0?(q(),k("div",Oe,[...r[5]||(r[5]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",class:"stroke-current shrink-0 w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),e("span",null,"No gross profit data available. Please check your data sources.",-1)])])):A("",!0)]))}};export{ze as default};
